<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Городской гид - {{title}}</title>
    <!-- Подключение CSS файла -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/PersonalPage.css') }}">
    <!-- Украшаем вкладку вашим логотипом -->
    <link rel="icon" href="{{ url_for('static', filename='Фотки зданий/лого.png') }}" type="image/png">

    <script src="{{ url_for('static', filename='js/RegistrationLogin.js') }}"></script>
</head>
<body>
    <!-- Объединенная навигация -->
<nav class="navbar">
    <div class="nav-container">
        <div class="logo" onclick="window.location.href='/';">
            <img src="{{ url_for('static', filename='Фотки зданий/лого.png') }}" alt="Логотип" height="50px" width="70px">
            <span>Городской Гид</span>
        </div>

        <!-- Поиск из старого HTML с визуалом нового -->
        <form class="search-box" action="/search" method="POST">
            <input type="text" name="query" placeholder="Поиск заведений..." class="search-input" id="search-input">
            <button type="submit" class="search-button">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M21 21L16.65 16.65" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </form>

        <!-- Кнопка избранного из старого HTML -->
        <div class="favorites-wrapper">
            <div class="favorite-wrapper" id="header-favorites-btn" style="display: none;" onclick="window.location.href='/favorites'">
              <span class="particle particle-1">✦</span>
              <span class="particle particle-2">✦</span>
              <span class="particle particle-3">✦</span>
              <span class="particle particle-4">✦</span>
              <span class="particle particle-5">✦</span>
                <span class="particle particle-6">✦</span>
              <span class="particle particle-7">✦</span>
              <span class="heart-icon">❤</span>
              <span class="favorites-counter" id="favorites-count">0</span>
            </div>
        </div>

        <!-- Кнопки входа/регистрации из старого HTML с визуалом нового -->
        <div class="auth-buttons">
            <button id="loginButton" class="btn-login" onclick="showWindow()">Вход</button>
            <button id="registerButton" class="btn-register" onclick="showWindow1()">Регистрация</button>
            <div id="userInfo" style="display: none;">
                <div class="Коробка">
                    <img id="avatar" src="{{ url_for('static', filename='Фотки зданий/avatar.png') }}" alt="Avatar">
                    <span id="welcomeUser"></span>
                </div>
                <button class="btn-logout" onclick="logout()">Выход</button>
            </div>
        </div>
    </div>
    <div class="clouds"></div>
</nav>

<!-- Окна входа/регистрации из старого HTML -->
<div id="overlay" style="display: none;"></div>

<div id="content_window" class="popup-window">
    <form id="loginForm" method="POST" action="/login">
        <h1>Вход</h1>
        <span class="btnX" onclick="hideWindow()">×</span>
        <div class="form-group">
            <label for="username">Логин</label>
            <input type="text" class="form-control" id="username" name="username" placeholder="Введите логин" required>
        </div>
        <div class="form-group">
            <label for="password">Пароль</label>
            <input type="password" class="form-control" id="password" name="password" placeholder="Введите пароль" required>
        </div>
        <button type="submit" class="btnA">Войти</button>
    </form>
</div>

<div id="content_window2" class="popup-window">
    <form id="regForm" method="POST" action="/register">
        <h1>Регистрация</h1>
        <span class="btnX" onclick="hideWindow1()">×</span>
        <div class="form-group">
            <label for="username1">Логин</label>
            <input type="text" id="username1" name="username" class="form-control" placeholder="Введите логин" required>
        </div>
        <div class="form-group">
            <label for="password1">Пароль</label>
            <input type="password" id="password1" name="password" class="form-control" placeholder="Введите пароль" required>
        </div>
        <div class="form-group">
            <label for="password2">Подтвердите пароль</label>
            <input type="password" id="password2" name="confirm_password" class="form-control" placeholder="Подтвердите пароль" required>
        </div>
        <div class="form-group">
            <label for="secret_key">Секретный ключ</label>
            <input type="password" id="secret_key" name="secret_key" class="form-control" placeholder="Введите секретный ключ" required>
        </div>
        <button type="submit" class="btnB">Зарегистрироваться</button>
    </form>
</div>

    <!-- Задний фон -->
    <div class="image-container">
        <img src="{{ url_for('static', filename='Фотки зданий/РесторанФон.jpg') }}" class="img-top-center" alt="РесторанФон.jpg">
    </div>
    <div class="box">
        <div class="container">
            <!-- Левая часть: картинка -->
            <div class="image-section">
                <div class="image-flip-container">
                    <!-- Передняя сторона (картинка) -->
                    <div class="image-front" >
                        <img src="{{ url_for('static', filename='Фотки зданий/Барашки.png') }}" alt="Ресторан Барашки">
                        <!-- Кнопка на карточке заведения -->
                        <button class="favorite-btn js-favorite-btn"
                                data-item-id="lambs"
                                data-item='{"id":"lambs","name":"Ресторан Lambs"}'
                                onclick="toggleFavorite('lambs', this)">
                          ❤
                        </button>
                        <!-- Кнопка развернуть в правом нижнем углу -->
                        <button class="expand-btn" onclick="expandImage(this)">↗</button>
                        <!-- Кнопка показать карту по центру снизу -->
                        <button class="map-btn" onclick="flipCard()">Показать карту</button>
                        <!-- График работы в левом верхнем углу -->
                        <div class="schedule-dropdown">
                            <button class="schedule-btn">График работы ▼</button>
                            <div class="schedule-content" id="schedule-content">
                                Пн-Пт: 10:00 - 22:00<br>
                                Сб-Вс: 11:00 - 23:00
                            </div>
                        </div>
                        <!-- Кнопка меню по центру снизу -->
                        <button class="menu-btn" onclick="openMenuModal()">Меню</button>
                    </div>

                    <!-- Задняя сторона (карта) -->
                    <div class="image-back">
                        <div class="map-container" id="map-container">
                            <h3>ул. Ломоносова, 22/2, Великий Новгород</h3>
                            <div class="map-container">
                                <iframe id="map_547336407" width="100%" height="100%" sandbox="allow-modals allow-forms allow-scripts allow-same-origin allow-popups allow-top-navigation-by-user-activation"></iframe>
                            </div>
                        </div>

                        <!-- Кнопка вернуться к изображению по центру снизу -->
                        <button class="back-btn" onclick="flipCard()">Показать изображение</button>
                    </div>
                </div>
            </div>

            <!-- Правая часть: описание -->
            <div class="details-section">
                <h1>Барашки</h1>
                <p>Ресторан «Барашки» предлагает своим гостям блюда грузинской кухни, приготовленные по традиционным рецептам.</p>
                <svg style="width: 18px; height: 18px; font-size: 17px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                <p>+7 (8162) 55-53-22</p>
            </div>
        </div>

        <!-- Блок отзывов -->
        <div class="reviews">
            <h2>Отзывы</h2>
            <p>Общая оценка: <strong id="overall-rating">0.0</strong> (на основе <span id="total-reviews">0</span> отзывов)</p>
            <div class="rating-bars">
                <div class="rating-bar">
                    <span>5 звёзд</span>
                    <div class="bar" style="margin-left: 10px"><div class="fill" style="width: 0;"></div></div>
                    <span>0</span>
                </div>
                <div class="rating-bar">
                    <span>4 звёзды</span>
                    <div class="bar"><div class="fill" style="width: 0;"></div></div>
                    <span>0</span>
                </div>
                <div class="rating-bar">
                    <span>3 звёзды</span>
                    <div class="bar"><div class="fill" style="width: 0;"></div></div>
                    <span>0</span>
                </div>
                <div class="rating-bar">
                    <span>2 звёзды</span>
                    <div class="bar"><div class="fill" style="width: 0;"></div></div>
                    <span>0</span>
                </div>
                <div class="rating-bar">
                    <span>1 звезда</span>
                    <div class="bar"><div class="fill" style="width: 0;"></div></div>
                    <span>0</span>
                </div>
            </div>

            <!-- Фильтр отзывов -->
            <div class="review-filter">
                <label>Фильтр по оценкам:</label>
                <div class="filter-controls">
                    <div class="stars" id="filter-stars">
                        <span class="star" data-value="1">
                            <img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">
                        </span>
                        <span class="star" data-value="2">
                            <img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">
                        </span>
                        <span class="star" data-value="3">
                            <img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">
                        </span>
                        <span class="star" data-value="4">
                            <img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">
                        </span>
                        <span class="star" data-value="5">
                            <img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">
                        </span>
                    </div>
                </div>
            </div>

            <!-- Контейнер для отзывов -->
            <div class="review-container">
                <!-- Стрелочка влево -->
                <button class="scroll-button left" onclick="scrollReviews('left')">◄</button>
                <!-- Контейнер для отзывов -->
                <div class="review-list" id="review-list">
                    <!-- Отзывы будут добавляться сюда -->
                </div>
                <!-- Стрелочка вправо -->
                <button class="scroll-button right" onclick="scrollReviews('right')">►</button>
            </div>

            <!-- Кнопка "Оставить отзыв" -->
            <button class="review-container-button" onclick="openReviewModal()">Оставить отзыв</button>
        </div>

        <!-- Модальное окно для меню -->
        <div class="modal" id="menu-modal">
            <div class="modal-content">
                <h2>Меню</h2>
                <p>Здесь будет содержимое меню.</p>
                <button onclick="closeMenuModal()">Закрыть</button>
            </div>
        </div>

        <!-- Модальное окно для отзыва -->
        <div class="modal" id="review-modal">
            <div class="modal-content">
                <span class="close" onclick="closeReviewModal()">&times;</span>
                <h2>Оставить отзыв</h2>
                <form id="review-form">
                    <label class="review-form-name" for="name">Имя:</label>
                    <input type="text" id="name" required><br><br>
                    <label>Оценка: <span id="rating-error" style="color: red; display: none; font-size: 11px">*Обязательное поле</span></label>
                    <div class="stars" id="review-stars">
                        <span class="star" data-value="1">
                            <img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">
                        </span>
                        <span class="star" data-value="2">
                            <img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">
                        </span>
                        <span class="star" data-value="3">
                            <img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">
                        </span>
                        <span class="star" data-value="4">
                            <img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">
                        </span>
                        <span class="star" data-value="5">
                            <img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">
                        </span>
                    </div><br>
                    <label for="comment">Комментарий:</label><br>
                    <textarea id="comment" rows="4"></textarea><br><br>
                    <button class="review-form-button" type="submit">Отправить</button>
                </form>
            </div>
        </div>

        <!-- Модальное окно для развёрнутого отзыва -->
        <div class="modal" id="full-review-modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeFullReviewModal()">&times;</span>
                <h2>Полный отзыв</h2>
                <div class="review-header-wrapper">
                    <div class="review-header">
                        <img class="avatar" src="{{ url_for('static', filename='Фотки зданий/avatar.png') }}" alt="Аватар">
                        <div class="name-rating-modal">
                            <div class="review-name"></div>
                            <div class="review-rating"></div>
                        </div>
                    </div>
                </div>
                <div class="review-comment"></div>
                <div class="review-actions">
                    <button class="like-btn" onclick="rateReview(true)">
                        <img src="{{ url_for('static', filename='Фотки зданий/Лайк.png') }}" alt="Лайк">
                        <span class="like-count">0</span>
                    </button>
                    <button class="dislike-btn" onclick="rateReview(false)">
                        <img src="{{ url_for('static', filename='Фотки зданий/Дизлайк.png') }}" alt="Дизлайк">
                        <span class="dislike-count">0</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для редактирования отзыва -->
<div class="modal" id="edit-review-modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditReviewModal()">&times;</span>
        <h2>Редактировать отзыв</h2>
        <form id="edit-review-form">
            <label>Оценка:</label>
            <div class="stars">
                <span class="star" data-value="1" onclick="setRating(this, 1)">
                    <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                </span>
                <span class="star" data-value="2" onclick="setRating(this, 2)">
                    <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                </span>
                <span class="star" data-value="3" onclick="setRating(this, 3)">
                    <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                </span>
                <span class="star" data-value="4" onclick="setRating(this, 4)">
                    <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                </span>
                <span class="star" data-value="5" onclick="setRating(this, 5)">
                    <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                </span>
            </div>
            <label for="edit-comment">Комментарий:</label>
            <textarea id="edit-comment" rows="4"></textarea>
            <button type="submit" class="submit-btn">Сохранить изменения</button>
        </form>
    </div>
</div>

    <!-- Городской силуэт перед футером -->
    <div class="skyscrapers"></div>

    <!-- Футер -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section about">
                <img src="{{ url_for('static', filename='Фотки зданий/лого.png') }}" style="width: 120px;" alt="Логотип">
                <p>Городской гид - ваш путеводитель по лучшим местам Великого Новгорода</p>
                <div class="socials">
                    <a href="#"><img src="{{ url_for('static', filename='Фотки зданий/TG.png') }}" alt="Telegram"></a>
                    <a href="#"><img src="{{ url_for('static', filename='Фотки зданий/YT.png') }}" style="margin-bottom: 0; margin-top: 8px" alt="YouTube"></a>
                    <a href="#"><img src="{{ url_for('static', filename='Фотки зданий/vk.png') }}" alt="VK"></a>
                    <a href="#"><img src="{{ url_for('static', filename='Фотки зданий/OK.png') }}" alt="OK"></a>
                </div>
            </div>

            <div class="footer-section links">
                <h3>Навигация</h3>
                <ul>
                    <li><a href="#">Главная</a></li>
                    <li><a href="#">О проекте</a></li>
                    <li><a href="#">Контакты</a></li>
                    <li><a href="#">Помощь</a></li>
                </ul>
            </div>

            <div class="footer-section contact">
                <h3>Контакты</h3>
                <p><i class="phone-icon"></i> +7 (123) 456-78-90</p>
                <p><i class="email-icon"></i> info@gorodskoygid.ru</p>
                <p><i class="location-icon"></i> Великий Новгород</p>
            </div>
        </div>

        <div class="footer-bottom">
            &copy; 2025 Городской Гид | Все права защищены
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // Константы
const PATHS = {
    starActive: "/static/Фотки зданий/baka.png",
    starInactive: "/static/Фотки зданий/star.png",
    avatar: "/static/Фотки зданий/avatar.png",
    like: "/static/Фотки зданий/Лайк.png",
    dislike: "/static/Фотки зданий/Дизлайк.png"
};

// Глобальные переменные
let selectedRating = 0;
const currentRestaurantId = 'lambs'; // ID текущего ресторана

// Функция для загрузки отзывов
async function loadReviews() {
    try {
        const response = await fetch(`/api/reviews?restaurant_id=${currentRestaurantId}`);
        if (!response.ok) {
            throw new Error('Ошибка при загрузке отзывов');
        }
        const reviews = await response.json();
        updateReviewsUI(reviews);
        updateOverallRating();
    } catch (error) {
        console.error('Error:', error);
        showNotification('Ошибка при загрузке отзывов', 'error');
    }
}

// Функция для обновления UI с отзывами
function updateReviewsUI(reviews) {
    const reviewList = document.getElementById('review-list');
    reviewList.innerHTML = '';

    if (!reviews || reviews.length === 0) {
        reviewList.innerHTML = '<div class="no-reviews">Пока нет отзывов. Будьте первым!</div>';
        return;
    }

    reviews.forEach(review => {
        const reviewElement = document.createElement('div');
        reviewElement.className = 'review-card';
        reviewElement.dataset.reviewId = review.id;

        reviewElement.innerHTML = `
            <div class="review-header">
                <img class="avatar" src="${PATHS.avatar}" alt="Аватар">
                <div class="name-rating">
                    <div class="name">${review.username}</div>
                    <div class="rating" data-rating="${review.rating}">
                        ${'<img src="' + PATHS.starActive + '" alt="★">'.repeat(review.rating)}
                        ${'<img src="' + PATHS.starInactive + '" alt="★">'.repeat(5 - review.rating)}
                    </div>
                </div>
            </div>
            <div class="comment-container">
                <div class="comment-text">${review.comment || ''}</div>
                ${review.comment ? '<div class="comment-blur"></div>' : ''}
            </div>
            <div class="review-actions">
                <button class="like-btn" onclick="rateReview(${review.id}, true)">
                    <img src="${PATHS.like}" alt="Лайк">
                    <span class="like-count">${review.likes || 0}</span>
                </button>
                <button class="dislike-btn" onclick="rateReview(${review.id}, false)">
                    <img src="${PATHS.dislike}" alt="Дизлайк">
                    <span class="dislike-count">${review.dislikes || 0}</span>
                </button>
            </div>
            <div class="expand" onclick="openFullReviewModal(${review.id})">Развернуть</div>
        `;

        if (review.comment) {
            limitCommentHeight(reviewElement);
        }

        reviewList.appendChild(reviewElement);
    });

    updateReviewVisibility();
}

// Функция для отправки отзыва
async function submitReview() {
    const name = document.getElementById('name').value.trim();
    const comment = document.getElementById('comment').value.trim();

    if (!name) {
        showNotification('Пожалуйста, укажите имя', 'error');
        return;
    }

    if (selectedRating === 0) {
        document.getElementById('rating-error').style.display = 'inline';
        return;
    }

    try {
        const response = await fetch('/api/reviews', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                restaurant_id: currentRestaurantId,
                username: name,
                rating: selectedRating,
                comment: comment
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Ошибка при отправке отзыва');
        }

        showNotification('Отзыв успешно добавлен!');
        closeReviewModal();
        loadReviews(); // Перезагружаем отзывы
    } catch (error) {
        console.error('Error:', error);
        showNotification(error.message, 'error');
    }
}

// Функция для обновления общего рейтинга
async function updateOverallRating() {
    try {
        const response = await fetch(`/api/restaurants/${currentRestaurantId}/stats`);
        if (!response.ok) {
            throw new Error('Ошибка при загрузке рейтинга');
        }
        const stats = await response.json();

        document.getElementById('overall-rating').textContent = stats.average_rating.toFixed(1);
        document.getElementById('total-reviews').textContent = stats.total_reviews;

        // Обновляем статистику по звездам
        for (let i = 1; i <= 5; i++) {
            const count = stats.ratings[i] || 0;
            const percentage = stats.total_reviews === 0 ? 0 : (count / stats.total_reviews) * 100;
            const bar = document.querySelector(`.rating-bar:nth-child(${6 - i}) .fill`);
            const countSpan = document.querySelector(`.rating-bar:nth-child(${6 - i}) span:last-child`);
            if (bar) bar.style.width = `${percentage}%`;
            if (countSpan) countSpan.textContent = count;
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    // Инициализация звезд рейтинга
    const stars = document.querySelectorAll('#review-stars .star');
    stars.forEach(star => {
        star.addEventListener('click', () => {
            selectedRating = parseInt(star.getAttribute('data-value'));
            stars.forEach((s, index) => {
                s.innerHTML = `<img src="${index < selectedRating ? PATHS.starActive : PATHS.starInactive}" alt="★">`;
            });
            document.getElementById('rating-error').style.display = 'none';
        });
    });

    // Обработчик формы отзыва
    document.getElementById('review-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitReview();
    });

    // Загрузка отзывов
    loadReviews();
});










// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    loadReviews();

    // Обработчик формы отзыва
    document.getElementById('review-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitReview();
    });
});





        // Обновляем обработчик формы
document.getElementById('review-form').addEventListener('submit', function(e) {
    e.preventDefault();
    submitReview();
});

// Функция для показа уведомлений
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Функция для закрытия модального окна отзыва
function closeReviewModal() {
    document.getElementById('review-modal').style.display = 'none';
    document.getElementById('review-form').reset();

    // Сбрасываем выбранные звезды
    const stars = document.querySelectorAll('#review-stars .star');
    stars.forEach(star => {
        star.innerHTML = `<img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">`;
    });
    selectedRating = 0;
}








// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    loadReviews();
});




       // Инициализация
document.addEventListener('DOMContentLoaded', function() {
  initFavorites();
});

function initFavorites() {
  updateFavoritesVisibility();

  window.addEventListener('storage', function(event) {
    if (event.key === 'favorites') {
      updateFavoritesVisibility();
    }
  });
}

// Основная функция переключения
function toggleFavorite(itemId, itemData) {
  const favorites = JSON.parse(localStorage.getItem('favorites')) || {};

  if (favorites[itemId]) {
    delete favorites[itemId];
  } else {
    favorites[itemId] = itemData;
  }

  localStorage.setItem('favorites', JSON.stringify(favorites));

  // Принудительное обновление интерфейса
  forceUIUpdate();

  // Оповещение других вкладок
  window.dispatchEvent(new Event('storageUpdate'));
}

// Обновление интерфейса с анимацией
function forceUIUpdate() {
  const headerBtn = document.getElementById('header-favorites-btn');
  if (headerBtn) {
    // 1. Добавляем класс для анимации исчезновения
    headerBtn.classList.add('hide');

    // 2. Через 300ms (длительность анимации) обновляем состояние
    setTimeout(() => {
      updateFavoritesVisibility();
      headerBtn.classList.remove('hide');
    }, 300);
  } else {
    updateFavoritesVisibility();
  }
}

// Контроль видимости кнопки
function updateFavoritesVisibility() {
  const favorites = JSON.parse(localStorage.getItem('favorites')) || {};
  const count = Object.keys(favorites).length;
  const headerBtn = document.getElementById('header-favorites-btn');
  const counter = document.getElementById('favorites-count');

  if (counter) counter.textContent = count;

  if (!headerBtn) return;

  if (count > 0) {
    showHeaderButton();
  } else {
    hideHeaderButton();
  }
}



        document.addEventListener('DOMContentLoaded', function() {
  // Инициализация кнопки
  const headerFavBtn = document.getElementById('header-favorites-btn');
  const particles = headerFavBtn.querySelectorAll('.particle');

  // Проверка избранного при загрузке
  updateFavoritesCount();

  // Анимация частиц
  headerFavBtn.addEventListener('mouseenter', function() {
    this.classList.add('active');
  });

  headerFavBtn.addEventListener('mouseleave', function() {
    this.classList.remove('active');
  });

  // Обработчики для кнопок в карточках
  document.querySelectorAll('.js-favorite-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const itemId = this.dataset.itemId;
      const itemData = JSON.parse(this.dataset.item);
      toggleFavorite(itemId, itemData);
    });
  });

  // Синхронизация между вкладками
  window.addEventListener('storage', function(event) {
    if (event.key === 'favorites') {
      updateFavoritesCount();
    }
  });
});

// Показать кнопку в шапке
function showHeaderButton() {
  const btn = document.getElementById('header-favorites-btn');
  if (!btn.classList.contains('visible')) {
    btn.style.display = 'inline-block';
    setTimeout(() => {
      btn.classList.add('visible');
    }, 10);
  }
}

// Скрыть кнопку с анимацией
function hideHeaderButton() {
  const btn = document.getElementById('header-favorites-btn');
  if (btn.classList.contains('visible')) {
    btn.classList.remove('visible');
    setTimeout(() => {
      btn.style.display = 'none';
    }, 300); // Должно совпадать с длительностью transition
  }
}

// Обновление счетчика и видимости кнопки
function updateFavoritesCount() {
  const favorites = JSON.parse(localStorage.getItem('favorites')) || {};
  const count = Object.keys(favorites).length;
  const counter = document.getElementById('favorites-count');
  const headerBtn = document.getElementById('header-favorites-btn');

  if (counter) counter.textContent = count;

  if (headerBtn) {
    if (count > 0) {
      showHeaderButton();
    } else {
      hideHeaderButton();
    }
  }
}


    // Функции для окон входа/регистрации
    function showWindow() {
        document.getElementById('overlay').style.display = 'block';
        const windowElement = document.getElementById('content_window');
        windowElement.classList.add('show');
        windowElement.style.display = 'block';
        document.body.classList.add('no-scroll');
    }

    function hideWindow() {
        document.getElementById('overlay').style.display = 'none';
        const windowElement = document.getElementById('content_window');
        windowElement.classList.remove('show');
        windowElement.style.display = 'none';
        document.body.classList.remove('no-scroll');
    }

    function showWindow1() {
        document.getElementById('overlay').style.display = 'block';
        const windowElement = document.getElementById('content_window2');
        windowElement.classList.add('show');
        windowElement.style.display = 'block';
        document.body.classList.add('no-scroll');
    }

    function hideWindow1() {
        document.getElementById('overlay').style.display = 'none';
        const windowElement = document.getElementById('content_window2');
        windowElement.classList.remove('show');
        windowElement.style.display = 'none';
        document.body.classList.remove('no-scroll');
    }

    // Закрытие окна при клике вне его
    document.getElementById('overlay').addEventListener('click', function() {
        const window1 = document.getElementById('content_window');
        const window2 = document.getElementById('content_window2');
        if (window1.classList.contains('show')) {
            hideWindow();
        } else if (window2.classList.contains('show')) {
            hideWindow1();
        }
    });

    // Обработчик для формы регистрации
    document.getElementById('regForm').onsubmit = function(event) {
        event.preventDefault();

        const username = document.getElementById('username1').value;
        const password = document.getElementById('password1').value;
        const confirmPassword = document.getElementById('password2').value;
        const secretKey = document.getElementById('secret_key').value;

        if (password !== confirmPassword) {
            alert('Пароли не совпадают');
            return;
        }

        fetch('/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'username': username,
                'password': password,
                'secret_key': secretKey
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('welcomeUser').innerText = data.username;
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('registerButton').style.display = 'none';
                hideWindow1();
                localStorage.setItem('username', data.username);
            } else {
                alert(data.message);
            }
        });
    };

    // Обработчик для формы входа
    document.getElementById('loginForm').onsubmit = function(event) {
        event.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        fetch('/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'username': username,
                'password': password
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('welcomeUser').innerText = data.username;
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('registerButton').style.display = 'none';
                hideWindow();
                localStorage.setItem('username', data.username);
            } else {
                alert(data.message);
            }
        });
    };

    // Функция выхода
    function logout() {
        fetch('/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('loginButton').style.display = 'block';
                document.getElementById('registerButton').style.display = 'block';
                localStorage.removeItem('username');
            } else {
                alert(data.message);
            }
        });
    }

    // Проверка состояния пользователя при загрузке страницы
    window.addEventListener('load', function() {
        const username = localStorage.getItem('username');
        if (username) {
            document.getElementById('welcomeUser').innerText = username;
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('loginButton').style.display = 'none';
            document.getElementById('registerButton').style.display = 'none';
        }

        // Инициализация менеджера избранного
        FavoritesManager.init();
    });

    // Синхронизация состояния пользователя между вкладками
    window.addEventListener('storage', function(event) {
        if (event.key === 'username') {
            if (event.newValue) {
                document.getElementById('welcomeUser').innerText = event.newValue;
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('registerButton').style.display = 'none';
            } else {
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('loginButton').style.display = 'block';
                document.getElementById('registerButton').style.display = 'block';
            }
        }
    });

    // Менеджер избранного из старого HTML
    const FavoritesManager = {
        init: function() {
            this.bindEvents();
            this.updateCounter();
            this.markExistingFavorites();
        },

        bindEvents: function() {
            document.querySelectorAll('.js-favorite-btn').forEach(btn => {
                btn.addEventListener('click', this.handleFavoriteClick.bind(this));
            });
        },

        handleFavoriteClick: function(event) {
            const button = event.currentTarget;
            if (!button) return;

            try {
                const itemData = button.getAttribute('data-item');
                if (!itemData) {
                    console.error('No data-item attribute found');
                    return;
                }

                const item = JSON.parse(itemData);
                if (!item || !item.id) {
                    console.error('Invalid item data');
                    return;
                }

                const favorites = this.getFavorites();
                const existingIndex = favorites.findIndex(fav => fav.id === item.id);

                if (existingIndex === -1) {
                    favorites.push(item);
                    button.classList.add('active');
                    this.showNotification(`"${item.name}" добавлен в избранное`);
                } else {
                    favorites.splice(existingIndex, 1);
                    button.classList.remove('active');
                    this.showNotification(`"${item.name}" удален из избранного`);
                }

                this.saveFavorites(favorites);
                this.updateCounter();
            } catch (error) {
                console.error('Error handling favorite click:', error);
            }
        },

        markExistingFavorites: function() {
            const favorites = this.getFavorites();
            document.querySelectorAll('.js-favorite-btn').forEach(btn => {
                try {
                    const itemData = btn.getAttribute('data-item');
                    if (!itemData) return;

                    const item = JSON.parse(itemData);
                    if (item && item.id && favorites.some(fav => fav.id === item.id)) {
                        btn.classList.add('active');
                    }
                } catch (error) {
                    console.error('Error marking existing favorite:', error);
                }
            });
        },

        getFavorites: function() {
            try {
                return JSON.parse(localStorage.getItem('favorites')) || [];
            } catch (error) {
                console.error('Error getting favorites:', error);
                return [];
            }
        },

        saveFavorites: function(favorites) {
            try {
                localStorage.setItem('favorites', JSON.stringify(favorites));
            } catch (error) {
                console.error('Error saving favorites:', error);
            }
        },

        updateCounter: function() {
            try {
                const count = this.getFavorites().length;
                const counter = document.getElementById('favorites-count');
                if (counter) counter.textContent = count;
            } catch (error) {
                console.error('Error updating counter:', error);
            }
        },

        showNotification: function(message) {
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.backgroundColor = 'rgba(0,0,0,0.8)';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '1000';
            notification.style.transition = 'opacity 0.5s';
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 2000);
        }
    };

    // Переворот карточки
    function flipCard() {
        document.querySelector('.image-flip-container').classList.toggle('flipped');
    }

    // Развернуть изображение
    function expandImage(btn) {
        const img = btn.closest('.image-front').querySelector('img');
        const imgSrc = img.src;

        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        overlay.style.zIndex = '1000';
        overlay.style.cursor = 'zoom-out';

        const expandedImg = document.createElement('img');
        expandedImg.src = imgSrc;
        expandedImg.style.maxWidth = '90%';
        expandedImg.style.maxHeight = '90%';
        expandedImg.style.objectFit = 'contain';

        overlay.appendChild(expandedImg);
        overlay.onclick = function() {
            document.body.removeChild(overlay);
        };

        document.body.appendChild(overlay);
    }

    // Модальное окно для меню
    function openMenuModal() {
        document.getElementById('menu-modal').style.display = 'flex';
    }
    function closeMenuModal() {
        document.getElementById('menu-modal').style.display = 'none';
    }

    // Модальное окно для отзыва
    function openReviewModal() {
        document.getElementById('review-modal').style.display = 'flex';
    }
    // Закрытие модального окна при клике вне его области
    document.getElementById('review-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReviewModal();
        }
    });

    // Обновленный код фильтрации
    function filterReviewsByRating(rating) {
        const reviewList = document.getElementById('review-list');
        const reviewCards = reviewList.querySelectorAll('.review-card');
        let hasMatches = false;

        // Удаляем старое сообщение "Нет отзывов"
        const oldMsg = document.getElementById('no-reviews-message');
        if (oldMsg) oldMsg.remove();

        // Фильтруем отзывы
        reviewCards.forEach(card => {
            const cardRating = parseInt(card.querySelector('.rating').dataset.rating);

            if (rating === 0 || cardRating === rating) {
                card.style.display = 'flex'; // Важно использовать flex
                hasMatches = true;
            } else {
                card.style.display = 'none';
            }
        });

        // Показываем сообщение если нет совпадений
        if (!hasMatches && rating !== 0) {
            const msg = document.createElement('div');
            msg.id = 'no-reviews-message';
            msg.textContent = 'Таких отзывов нет!';
            msg.style.textAlign = 'center';
            msg.style.padding = '20px';
            msg.style.color = '#666';
            reviewList.appendChild(msg);
        }

        // Принудительное обновление layout
        setTimeout(updateReviewVisibility, 50);
    }

    // Обновленный обработчик звезд фильтра
    const filterStars = document.querySelectorAll('#filter-stars .star');
    let currentFilter = 0;

    filterStars.forEach(star => {
        star.addEventListener('click', function() {
            const value = parseInt(this.getAttribute('data-value'));

            // Если кликнули на уже выбранную звезду - сбрасываем фильтр
            if (currentFilter === value) {
                currentFilter = 0;
                filterStars.forEach(s => {
                    s.innerHTML = `<img src="${PATHS.starInactive}" alt="★">`;
                });
            } else {
                currentFilter = value;
                // Подсвечиваем звезды до выбранного значения
                filterStars.forEach((s, index) => {
                    const starValue = index + 1;
                    s.innerHTML = `<img src="${starValue <= value ? PATHS.starActive : PATHS.starInactive}"
                                       alt="★">`;
                });
            }

            filterReviewsByRating(currentFilter);
        });
    });

    // Функция показа всех отзывов
    function showAllReviews() {
        currentFilter = 0;
        filterStars.forEach(star => {
            star.innerHTML = `<img src="${PATHS.starInactive}" alt="★">`;
        });
        filterReviewsByRating(0);
    }

    // Лайки и дизлайки
    let likeCount = 0;
    let dislikeCount = 0;
    function likeReview() {
        likeCount++;
        document.getElementById('like-count').textContent = likeCount;
    }
    function dislikeReview() {
        dislikeCount++;
        document.getElementById('dislike-count').textContent = dislikeCount;
    }

    // Оценка звёздами
    const stars = document.querySelectorAll('#review-stars .star');

    stars.forEach(star => {
        star.addEventListener('click', () => {
            const value = parseFloat(star.getAttribute('data-value'));
            selectedRating = value; // Сохраняем выбранную оценку

            stars.forEach((s, index) => {
                const starValue = parseFloat(s.getAttribute('data-value'));
                if (starValue <= value) {
                    s.innerHTML = `<img src="{{ url_for('static', filename='Фотки зданий/baka.png') }}" alt="★" style="width: 24px; height: 24px;">`;
                } else {
                    s.innerHTML = `<img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★" style="width: 24px; height: 24px;">`;
                }
            });
        });
    });

    // Функция для добавления отзыва
    const reviewForm = document.getElementById('review-form');
    const reviewList = document.getElementById('review-list');
    reviewForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('name').value;
        const comment = document.getElementById('comment').value;

        // Проверка, что оценка выбрана
        if (selectedRating === 0) {
            document.getElementById('rating-error').style.display = 'inline';
            return;
        } else {
            document.getElementById('rating-error').style.display = 'none';
        }

        // Создаём новый отзыв
        const review = {
            id: Date.now(), // Уникальный ID для отзыва
            name: name,
            rating: selectedRating,
            comment: comment,
            likes: 0,
            dislikes: 0
        };

        // Добавляем отзыв в массив
        reviews.push(review);

        // Обновляем статистику
        ratingCounts[Math.floor(selectedRating)]++;

        // Обновляем общую оценку
        updateOverallRating();

        // Создаём HTML для нового отзыва
        const reviewElement = document.createElement('div');
        reviewElement.className = 'review-card highlight';
        reviewElement.dataset.reviewId = review.id;

        reviewElement.innerHTML = `
            <div class="review-header">
                <img class="avatar" src="${PATHS.avatar}" alt="Аватар">
                <div class="name-rating">
                    <div class="name">${name}</div>
                    <div class="rating" data-rating="${selectedRating}">
                        ${`<img src="${PATHS.starActive}" alt="★" style="width:20px;height:20px;">`.repeat(selectedRating)}
                        ${`<img src="${PATHS.starInactive}" alt="★" style="width:20px;height:20px;">`.repeat(5 - selectedRating)}
                    </div>
                </div>
            </div>
            <div class="comment-container">
                <div class="comment-text">${comment || ''}</div>
                ${comment ? '<div class="comment-blur"></div>' : ''}
            </div>
            <div class="expand" onclick="openFullReviewModal(${review.id})">Развернуть</div>
        `;

        // Добавляем отзыв в начало списка
        reviewList.prepend(reviewElement);
        if (comment) {
            limitCommentHeight(reviewElement);
        }
        updateReviewVisibility(); // Всегда обновляем видимость

        // Прокручиваем к началу
        reviewList.scrollTo({ left: 0, behavior: 'smooth' });

        // Сбрасываем форму
        reviewForm.reset();
        stars.forEach(star => star.innerHTML = `<img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★" style="width: 24px; height: 24px;">`);
        selectedRating = 0; // Сбрасываем выбранную оценку
        closeReviewModal();
        updateReviewVisibility();
    });

    reviewList.scrollTo({
        left: 0,
        behavior: 'smooth'
    });

    // Закрытие модального окна при клике вне его области
    document.getElementById('full-review-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeFullReviewModal();
        }
    });

    // Функция закрытия модального окна
    function closeFullReviewModal() {
        document.getElementById('full-review-modal').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
    // Гарантированно скрываем модальное окно при загрузке
        document.getElementById('full-review-modal').style.display = 'none';
    });

    // Обновленная функция открытия модального окна
    function openFullReviewModal(reviewId) {
        const review = reviews.find(r => r.id == reviewId);
        if (!review) return;

        const modal = document.getElementById('full-review-modal');
        const commentElement = modal.querySelector('.review-comment');

        // Сначала скрываем, потом показываем для гарантии
        modal.style.display = 'none';
        void modal.offsetHeight; // Принудительный reflow

        // Заполняем данные
        modal.querySelector('.review-name').textContent = review.name;
        modal.querySelector('.review-rating').innerHTML =
            `<img src="${PATHS.starActive}" alt="★">`.repeat(review.rating) +
            `<img src="${PATHS.starInactive}" alt="★">`.repeat(5 - review.rating);

        commentElement.innerHTML = review.comment.replace(/\n/g, '<br>');

        // Сбрасываем стили перед проверкой
        commentElement.style.maxHeight = '';
        commentElement.style.overflowY = '';

        // Принудительный reflow
        void commentElement.offsetHeight;

        // Устанавливаем фиксированную высоту для контейнера
        const containerHeight = 370; // Фиксированная высота для скролла
        commentElement.style.maxHeight = `${containerHeight}px`;
        commentElement.style.overflowY = 'auto';

        modal.querySelector('.like-count').textContent = review.likes;
        modal.querySelector('.dislike-count').textContent = review.dislikes;

        // Проверяем, голосовал ли уже пользователь
        const likeBtn = modal.querySelector('.like-btn');
        const dislikeBtn = modal.querySelector('.dislike-btn');
        likeBtn.disabled = review.userVoted === 'like';
        dislikeBtn.disabled = review.userVoted === 'dislike';

        modal.dataset.reviewId = reviewId;
        modal.style.display = 'flex';
    }

    // При создании отзыва добавляем поле для отслеживания голосов
    const review = {
        id: Date.now(),
        name: name,
        rating: selectedRating,
        comment: comment,
        likes: 0,
        dislikes: 0,
        userVoted: null // 'like', 'dislike' или null
    };

    // Лайки/дизлайки для модального окна
    function rateReview(isLike) {
        const modal = document.getElementById('full-review-modal');
        const reviewId = modal.dataset.reviewId;
        const review = reviews.find(r => r.id == reviewId);

        if (!review) return;

        // Если пользователь уже голосовал
        if (review.userVoted) {
            // Отменяем предыдущий голос
            if (review.userVoted === 'like') {
                review.likes--;
            } else {
                review.dislikes--;
            }

            // Если кликнул ту же кнопку - просто сбрасываем голос
            if ((isLike && review.userVoted === 'like') ||
                (!isLike && review.userVoted === 'dislike')) {
                review.userVoted = null;
            } else {
                // Если кликнул другую кнопку - засчитываем новый голос
                if (isLike) {
                    review.likes++;
                    review.userVoted = 'like';
                } else {
                    review.dislikes++;
                    review.userVoted = 'dislike';
                }
            }
        } else {
            // Первый голос
            if (isLike) {
                review.likes++;
                review.userVoted = 'like';
            } else {
                review.dislikes++;
                review.userVoted = 'dislike';
            }
        }

        // Обновляем UI
        modal.querySelector('.like-count').textContent = review.likes;
        modal.querySelector('.dislike-count').textContent = review.dislikes;

        const likeBtn = modal.querySelector('.like-btn');
        const dislikeBtn = modal.querySelector('.dislike-btn');
        likeBtn.disabled = review.userVoted === 'like';
        dislikeBtn.disabled = review.userVoted === 'dislike';

        // Исправленная логика затемнения иконок
        const likeImg = likeBtn.querySelector('img');
        const dislikeImg = dislikeBtn.querySelector('img');

        if (review.userVoted === 'like') {
            dislikeImg.style.opacity = '1';
            likeImg.style.opacity = '0.5';
        } else if (review.userVoted === 'dislike') {
            dislikeImg.style.opacity = '0.5';
            likeImg.style.opacity = '1';
        } else {
            dislikeImg.style.opacity = '0.5';
            likeImg.style.opacity = '0.5';
        }
    }

    // Функция для ограничения высоты текста
    function limitCommentHeight(reviewElement) {
        const container = reviewElement.querySelector('.comment-container');
        const textElement = reviewElement.querySelector('.comment-text');
        const blurElement = reviewElement.querySelector('.comment-blur');
        const expandButton = reviewElement.querySelector('.expand');

        // Всегда показываем кнопку "Развернуть"
        expandButton.style.display = 'block';

        // Если комментария нет, скрываем контейнер и размытие
        if (!textElement.textContent.trim()) {
            container.style.display = 'none';
            if (blurElement) blurElement.style.display = 'none';
            return;
        }

        // Вычисляем, нужно ли ограничивать текст
        const lineHeight = parseInt(getComputedStyle(textElement).lineHeight);
        const maxHeight = lineHeight * 5; // 3 строки

        if (textElement.scrollHeight > maxHeight) {
            container.style.maxHeight = `${maxHeight}px`;
            if (blurElement) blurElement.style.display = 'block';
        } else {
            container.style.maxHeight = 'none';
            if (blurElement) blurElement.style.display = 'none';
        }
}

    // Массив для хранения отзывов
    let reviews = [];

    // Общая оценка и статистика
    let overallRating = 0;
    let ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

    // Функция для обновления статистики отзывов
    function updateRatingBars() {
        const totalReviews = reviews.length;
        for (let i = 1; i <= 5; i++) {
            const count = ratingCounts[i];
            const percentage = totalReviews === 0 ? 0 : (count / totalReviews) * 100;
            const bar = document.querySelector(`.rating-bar:nth-child(${6 - i}) .fill`);
            const countSpan = document.querySelector(`.rating-bar:nth-child(${6 - i}) span:last-child`);
            bar.style.width = `${percentage}%`;
            countSpan.textContent = count;
        }
    }

    // Прокрутка отзывов с проверкой границ
    function scrollReviews(direction) {
        const reviewList = document.getElementById('review-list');
        const scrollAmount = 300;

        if (direction === 'left' && reviewList.scrollLeft > 0) {
            reviewList.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        } else if (direction === 'right' &&
                  reviewList.scrollLeft + reviewList.clientWidth < reviewList.scrollWidth) {
            reviewList.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
    }

    // Обновленная функция для обновления видимости отзывов и кнопок
    function updateReviewVisibility() {
        const reviewList = document.getElementById('review-list');
        const visibleReviews = Array.from(reviewList.querySelectorAll('.review-card'))
            .filter(card => window.getComputedStyle(card).display !== 'none');

        const leftButton = document.querySelector('.scroll-button.left');
        const rightButton = document.querySelector('.scroll-button.right');

        // Проверяем возможность прокрутки
        const canScrollLeft = reviewList.scrollLeft > 0;
        const canScrollRight = reviewList.scrollLeft + reviewList.clientWidth < reviewList.scrollWidth;

        // Управляем видимостью и состоянием кнопок
        if (visibleReviews.length === 0) {
            leftButton.style.opacity = '0';
            leftButton.style.pointerEvents = 'none';
            rightButton.style.opacity = '0';
            rightButton.style.pointerEvents = 'none';
        } else {
            leftButton.style.opacity = canScrollLeft ? '1' : '0.5';
            leftButton.style.pointerEvents = canScrollLeft ? 'auto' : 'none';

            rightButton.style.opacity = canScrollRight ? '1' : '0.5';
            rightButton.style.pointerEvents = canScrollRight ? 'auto' : 'none';
        }
    }

    // Обновление состояния стрелочек при прокрутке
    reviewList.addEventListener('scroll', function() {
        const leftButton = document.querySelector('.scroll-button.left');
        const rightButton = document.querySelector('.scroll-button.right');

        const canScrollLeft = this.scrollLeft > 0;
        const canScrollRight = this.scrollLeft + this.clientWidth < this.scrollWidth;

        leftButton.style.opacity = canScrollLeft ? '1' : '0.5';
        leftButton.style.pointerEvents = canScrollLeft ? 'auto' : 'none';

        rightButton.style.opacity = canScrollRight ? '1' : '0.5';
        rightButton.style.pointerEvents = canScrollRight ? 'auto' : 'none';
    });

    // Развёртывание отзыва
    function expandReview(comment) {
        alert(comment); // Можно заменить на модальное окно
    }

    //Карта
    document.addEventListener('DOMContentLoaded', function() {
    // Инициализация карты
    (function(e,t){
        var r=document.getElementById(e);
        if(r) {
            r.contentWindow.document.open();
            r.contentWindow.document.write(atob(t));
            r.contentWindow.document.close();
        }
    })("map_547336407", "PGJvZHk+PHN0eWxlPgogICAgICAgIGh0bWwsIGJvZHkgewogICAgICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgICAgIHBhZGRpbmc6IDA7CiAgICAgICAgfQogICAgICAgIGh0bWwsIGJvZHksICNtYXAgewogICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICAgIH0KICAgICAgICAuYnVsbGV0LW1hcmtlciB7CiAgICAgICAgICAgIHdpZHRoOiAyMHB4OwogICAgICAgICAgICBoZWlnaHQ6IDIwcHg7CiAgICAgICAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6ICNmZmY7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMXB4IDNweCAwIHJnYmEoMCwgMCwgMCwgMC4yKTsKICAgICAgICAgICAgYm9yZGVyOiA0cHggc29saWQgIzAyODFmMjsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgIH0KICAgICAgICAucGVybWFuZW50LXRvb2x0aXAgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiBub25lOwogICAgICAgICAgICBib3gtc2hhZG93OiBub25lOwogICAgICAgICAgICBib3JkZXI6IG5vbmU7CiAgICAgICAgICAgIHBhZGRpbmc6IDZweCAxMnB4OwogICAgICAgICAgICBjb2xvcjogIzI2MjYyNjsKICAgICAgICB9CiAgICAgICAgLnBlcm1hbmVudC10b29sdGlwOmJlZm9yZSB7CiAgICAgICAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICAgICAgfQogICAgICAgIC5kZy1wb3B1cF9oaWRkZW5fdHJ1ZSB7CiAgICAgICAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgICAgIH0KICAgICAgICAubGVhZmxldC1jb250YWluZXIgLmxlYWZsZXQtcG9wdXAgLmxlYWZsZXQtcG9wdXAtY2xvc2UtYnV0dG9uIHsKICAgICAgICAgICAgdG9wOiAwOwogICAgICAgICAgICByaWdodDogMDsKICAgICAgICAgICAgd2lkdGg6IDIwcHg7CiAgICAgICAgICAgIGhlaWdodDogMjBweDsKICAgICAgICAgICAgZm9udC1zaXplOiAyMHB4OwogICAgICAgICAgICBsaW5lLWhlaWdodDogMTsKICAgICAgICB9CiAgICA8L3N0eWxlPjxkaXYgaWQ9Im1hcCI+PC9kaXY+PHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiIHNyYz0iaHR0cHM6Ly9tYXBzLmFwaS4yZ2lzLnJ1LzIuMC9sb2FkZXIuanM/cGtnPWZ1bGwmYW1wO3NraW49bGlnaHQiPjwvc2NyaXB0PjxzY3JpcHQ+KGZ1bmN0aW9uKGUpe3ZhciB0PUpTT04ucGFyc2UoZSkscj10Lm9yZGVyZWRHZW9tZXRyaWVzLG49dC5tYXBQb3NpdGlvbixhPXQuaXNXaGVlbFpvb21FbmFibGVkO2Z1bmN0aW9uIG8oZSl7cmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChhdG9iKGUpLnNwbGl0KCIiKS5tYXAoZnVuY3Rpb24oZSl7cmV0dXJuIiUiKygiMDAiK2UuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC0yKX0pLmpvaW4oIiIpKX1ERy50aGVuKGZ1bmN0aW9uKCl7dmFyIGU9REcubWFwKCJtYXAiLHtjZW50ZXI6W24ubGF0LG4ubG9uXSx6b29tOm4uem9vbSxzY3JvbGxXaGVlbFpvb206YSx6b29tQ29udHJvbDohYX0pO0RHLmdlb0pTT04ocix7c3R5bGU6ZnVuY3Rpb24oZSl7dmFyIHQscixuLGEsbztyZXR1cm57ZmlsbENvbG9yOm51bGw9PT0odD1lKXx8dm9pZCAwPT09dD92b2lkIDA6dC5wcm9wZXJ0aWVzLmZpbGxDb2xvcixmaWxsT3BhY2l0eTpudWxsPT09KHI9ZSl8fHZvaWQgMD09PXI/dm9pZCAwOnIucHJvcGVydGllcy5maWxsT3BhY2l0eSxjb2xvcjpudWxsPT09KG49ZSl8fHZvaWQgMD09PW4/dm9pZCAwOm4ucHJvcGVydGllcy5zdHJva2VDb2xvcix3ZWlnaHQ6bnVsbD09PShhPWUpfHx2b2lkIDA9PT1hP3ZvaWQgMDphLnByb3BlcnRpZXMuc3Ryb2tlV2lkdGgsb3BhY2l0eTpudWxsPT09KG89ZSl8fHZvaWQgMD09PW8/dm9pZCAwOm8ucHJvcGVydGllcy5zdHJva2VPcGFjaXR5fX0scG9pbnRUb0xheWVyOmZ1bmN0aW9uKGUsdCl7cmV0dXJuInJhZGl1cyJpbiBlLnByb3BlcnRpZXM/REcuY2lyY2xlKHQsZS5wcm9wZXJ0aWVzLnJhZGl1cyk6REcubWFya2VyKHQse2ljb246ZnVuY3Rpb24oZSl7cmV0dXJuIERHLmRpdkljb24oe2h0bWw6IjxkaXYgY2xhc3M9J2J1bGxldC1tYXJrZXInIHN0eWxlPSdib3JkZXItY29sb3I6ICIrZSsiOyc+PC9kaXY+IixjbGFzc05hbWU6Im92ZXJyaWRlLWRlZmF1bHQiLGljb25TaXplOlsyMCwyMF0saWNvbkFuY2hvcjpbMTAsMTBdfSl9KGUucHJvcGVydGllcy5jb2xvcil9KX0sb25FYWNoRmVhdHVyZTpmdW5jdGlvbihlLHQpe2UucHJvcGVydGllcy5kZXNjcmlwdGlvbiYmdC5iaW5kUG9wdXAobyhlLnByb3BlcnRpZXMuZGVzY3JpcHRpb24pLHtjbG9zZUJ1dHRvbjohMCxjbG9zZU9uRXNjYXBlS2V5OiEwfSksZS5wcm9wZXJ0aWVzLnRpdGxlJiZ0LmJpbmRUb29sdGlwKG8oZS5wcm9wZXJ0aWVzLnRpdGxlKSx7cGVybWFuZW50OiEwLG9wYWNpdHk6MSxjbGFzc05hbWU6InBlcm1hbmVudC10b29sdGlwIn0pfX0pLmFkZFRvKGUpfSl9KSgneyJvcmRlcmVkR2VvbWV0cmllcyI6W3sidHlwZSI6IkZlYXR1cmUiLCJwcm9wZXJ0aWVzIjp7ImNvbG9yIjoiIzAwMDAwMCIsInRpdGxlIjoiMEpIUXNOR0EwTERSaU5DNjBMZz0iLCJkZXNjcmlwdGlvbiI6IlBIQSswS0RRdGRHQjBZTFF2dEdBMExEUXZTRENxOUNSMExEUmdOQ3cwWWpRdXRDNHdyc2cwTC9SZ05DMTBMVFF1OUN3MExQUXNOQzEwWUlnMFlIUXN0QyswTGpRdkNEUXM5QyswWUhSZ3RHUDBMd2cwTEhRdTlHTzBMVFFzQ0RRczlHQTBZUFF0OUM0MEwzUmdkQzYwTDdRdVNEUXV0R0QwWVhRdmRDNExDRFF2OUdBMExqUXM5QyswWUxRdnRDeTBMdlF0ZEM5MEwzUmk5QzFJTkMvMEw0ZzBZTFJnTkN3MExUUXVOR0cwTGpRdnRDOTBMM1JpOUM4SU5HQTBMWFJodEMxMEwvUmd0Q3cwTHd1UEM5d1BnPT0iLCJ6SW5kZXgiOjEwMDAwMDAwMDB9LCJnZW9tZXRyeSI6eyJ0eXBlIjoiUG9pbnQiLCJjb29yZGluYXRlcyI6WzMxLjIzOTgwMyw1OC41MzE3MzNdfSwiaWQiOjczMX1dLCJtYXBQb3NpdGlvbiI6eyJsYXQiOjU4LjUzMTY3NjIxMDAwNzg2LCJsb24iOjMxLjI0MTk4NDM2NzM3MDYwNSwiem9vbSI6MTZ9LCJpc1doZWVsWm9vbUVuYWJsZWQiOnRydWV9Jyk8L3NjcmlwdD48c2NyaXB0IGFzeW5jPSIiIHNyYz0iaHR0cHM6Ly93d3cuZ29vZ2xldGFnbWFuYWdlci5jb20vZ3RhZy9qcz9pZD1HLVQ4NktNRDAzQzciPjwvc2NyaXB0PjxzY3JpcHQgaWQ9Imdvb2dsZS1hbmFseXRpY3MiPgogICAgICB3aW5kb3cuZGF0YUxheWVyID0gd2luZG93LmRhdGFMYXllciB8fCBbXTsKICAgICAgZnVuY3Rpb24gZ3RhZygpe2RhdGFMYXllci5wdXNoKGFyZ3VtZW50cyk7fQogICAgICBndGFnKCdqcycsIG5ldyBEYXRlKCkpOwogICAgICBndGFnKCdjb25maWcnLCAnRy1UODZLTUQwM0M3JywgeyJjb29raWVfZmxhZ3MiOiJTYW1lU2l0ZT1Ob25lOyBTZWN1cmU7IFBhcnRpdGlvbmVkIiwiY29va2llX3VwZGF0ZSI6ZmFsc2V9KTsKICAgICAgdHJ1ZSAmJiBndGFnKCdldmVudCcsICdmcm9tX2lmcmFtZScpOwogICAgPC9zY3JpcHQ+PC9ib2R5Pg==");
});

// Глобальные переменные
let currentUser = null; // Должно устанавливаться при авторизации
let currentRestaurant = {
    id: 'lambs',
    name: 'Барашки'
};

// Обновляем обработчик формы
document.getElementById('review-form').addEventListener('submit', function(e) {
    e.preventDefault();
    submitReview();
});

// Функция для обновления отзыва
async function updateReview(reviewId, rating, comment) {
    try {
        const token = localStorage.getItem('token');

        const response = await fetch(`/api/reviews/${reviewId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            },
            body: JSON.stringify({
                rating: rating,
                comment: comment
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.message || 'Ошибка при обновлении отзыва');
        }

        // Обновляем UI
        if (data.restaurant.rating) {
            updateRestaurantRating(data.restaurant.rating);
        }
        updateReviewInUI(reviewId, data.review);

        showNotification(data.message);
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

// Функция для удаления отзыва
async function deleteReview(reviewId) {
    try {
        const token = localStorage.getItem('token');

        const response = await fetch(`/api/reviews/${reviewId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': token
            }
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.message || 'Ошибка при удалении отзыва');
        }

        // Обновляем UI
        updateRestaurantRating(data.restaurant.rating, data.restaurant.review_count);
        removeReviewFromUI(reviewId);

        showNotification(data.message);
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

// Функция для проверки можно ли редактировать отзыв
function checkReviewEditAbility(review) {
    if (!review.can_edit) return false;

    const createdAt = new Date(review.created_at);
    const now = new Date();
    const hoursDiff = (now - createdAt) / (1000 * 60 * 60);

    return hoursDiff <= 3;
}

// Функция для загрузки данных ресторана и отзывов
async function loadRestaurantData() {
    try {
        const response = await fetch(`/api/restaurants/${currentRestaurant.id}`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error('Ошибка при загрузке данных');
        }

        // Обновляем рейтинг ресторана
        updateRestaurantRating(data.restaurant.rating, data.restaurant.review_count);

        // Очищаем и добавляем отзывы
        document.getElementById('reviews-list').innerHTML = '';
        data.reviews.forEach(review => {
            addReviewToUI(review);
        });
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

// Вспомогательные функции для обновления UI
function updateRestaurantRating(rating, count) {
    if (rating) {
        document.querySelector('.overall-rating .rating-value').textContent = rating.toFixed(1);
        document.querySelector('.restaurant-rating .rating-value').textContent = rating.toFixed(1);
    }
    if (count) {
        document.querySelector('.overall-rating .reviews-count').textContent = `${count} отзывов`;
    }
}

function addReviewToUI(review) {
    const reviewsContainer = document.getElementById('review-list');

    // Удаляем сообщение "Нет отзывов", если оно есть
    const noReviewsMsg = reviewsContainer.querySelector('.no-reviews');
    if (noReviewsMsg) {
        noReviewsMsg.remove();
    }

    const reviewElement = document.createElement('div');
    reviewElement.className = 'review-card';
    reviewElement.dataset.reviewId = review.id;

    reviewElement.innerHTML = `
        <div class="review-header">
            <img class="avatar" src="{{ url_for('static', filename='Фотки зданий/avatar.png') }}" alt="Аватар">
            <div class="name-rating">
                <div class="name">${review.username}</div>
                <div class="rating">
                    ${'<img src="{{ url_for('static', filename='Фотки зданий/baka.png') }}" alt="★">'.repeat(review.rating)}
                    ${'<img src="{{ url_for('static', filename='Фотки зданий/star.png') }}" alt="★">'.repeat(5 - review.rating)}
                </div>
            </div>
        </div>
        <div class="comment-container">
            <div class="comment-text">${review.comment || ''}</div>
        </div>
        <div class="review-actions">
            <button class="like-btn" onclick="rateReview(${review.id}, true)">
                <img src="{{ url_for('static', filename='Фотки зданий/Лайк.png') }}" alt="Лайк">
                <span class="like-count">${review.likes}</span>
            </button>
            <button class="dislike-btn" onclick="rateReview(${review.id}, false)">
                <img src="{{ url_for('static', filename='Фотки зданий/Дизлайк.png') }}" alt="Дизлайк">
                <span class="dislike-count">${review.dislikes}</span>
            </button>
        </div>
        <div class="review-date">${new Date(review.created_at).toLocaleString()}</div>
    `;

    // Добавляем новый отзыв в начало списка
    reviewsContainer.insertBefore(reviewElement, reviewsContainer.firstChild);

    // Добавляем анимацию появления
    reviewElement.style.opacity = '0';
    setTimeout(() => {
        reviewElement.style.transition = 'opacity 0.3s ease';
        reviewElement.style.opacity = '1';
    }, 10);
}

// Обновляем обработчик формы
document.getElementById('review-form').addEventListener('submit', function(e) {
    e.preventDefault(); // Это предотвращает перезагрузку страницы
    submitReview();
});

function updateReviewInUI(reviewId, updatedData) {
    const reviewElement = document.querySelector(`.review-card[data-review-id="${reviewId}"]`);
    if (!reviewElement) return;

    if (updatedData.rating) {
        const ratingElement = reviewElement.querySelector('.review-rating');
        ratingElement.innerHTML = `
            ${'<svg viewBox="0 0 24 24" class="star-icon filled"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>'.repeat(updatedData.rating)}
            <span>${updatedData.rating.toFixed(1)}</span>
        `;
    }

    if (updatedData.comment !== undefined) {
        const commentElement = reviewElement.querySelector('.review-content p');
        commentElement.textContent = updatedData.comment || '';
    }

    // Обновляем дату редактирования
    if (updatedData.updated_at) {
        const dateElement = reviewElement.querySelector('.review-date');
        dateElement.textContent = `${formatDate(updatedData.updated_at)} (изменен)`;
    }

    // Проверяем можно ли еще редактировать
    const canEdit = checkReviewEditAbility({
        created_at: reviewElement.querySelector('.review-date').dataset.originalDate,
        can_edit: true
    });

    if (!canEdit) {
        const editButtons = reviewElement.querySelector('.review-edit-buttons');
        if (editButtons) editButtons.remove();
    }
}

function removeReviewFromUI(reviewId) {
    const reviewElement = document.querySelector(`.review-card[data-review-id="${reviewId}"]`);
    if (reviewElement) {
        reviewElement.classList.add('fade-out');
        setTimeout(() => reviewElement.remove(), 300);
    }
}

// Модальное окно для редактирования отзыва
function openEditReviewModal(reviewId, currentRating, currentComment) {
    const modal = document.getElementById('edit-review-modal');
    const form = modal.querySelector('form');

    form.dataset.reviewId = reviewId;

    // Устанавливаем текущие значения
    modal.querySelectorAll('.star').forEach((star, index) => {
        star.classList.toggle('filled', index < currentRating);
    });

    modal.querySelector('textarea').value = currentComment || '';

    // Показываем модальное окно
    modal.style.display = 'flex';
}

function closeEditReviewModal() {
    document.getElementById('edit-review-modal').style.display = 'none';
}

// Вспомогательные функции
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    // Установка текущего пользователя (должно приходить из системы авторизации)
    currentUser = 1; // Здесь должен быть ID текущего пользователя

    // Загрузка данных ресторана
    loadRestaurantData();

    // Обработчики для модального окна добавления отзыва
    document.getElementById('review-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const rating = this.querySelector('.star.filled').length;
        const comment = this.querySelector('textarea').value;

        submitReview(rating, comment);
    });

    // Обработчики для модального окна редактирования отзыва
    document.getElementById('edit-review-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const reviewId = this.dataset.reviewId;
        const rating = this.querySelectorAll('.star.filled').length;
        const comment = this.querySelector('textarea').value;

        updateReview(reviewId, rating, comment);
        closeEditReviewModal();
    });

    // Закрытие модальных окон при клике вне их
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                if (this.id === 'review-modal') closeReviewModal();
                if (this.id === 'edit-review-modal') closeEditReviewModal();
            }
        });
    });
});
</script>
</body>
</html>