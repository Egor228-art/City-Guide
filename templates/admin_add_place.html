<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .map-container { height: 400px; border-radius: 8px; overflow: hidden; }
        .map-instructions { background: #e7f3ff; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .coordinates-display { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .auto-generated { background: #e7f3ff; padding: 8px; border-radius: 4px; margin-top: 5px; font-size: 14px; }
        .category-section { border: 1px solid #dee2e6; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .time-slot { border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .menu-builder { border: 1px solid #dee2e6; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .menu-category { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .menu-item { background: white; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #dee2e6; }
        .warning-alert { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .help-text { font-size: 12px; color: #6c757d; }
        .slug-warning { color: #dc3545; font-size: 12px; margin-top: 5px; }

        .input-group-text {
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    min-width: 60px;
    justify-content: center;
}

.menu-item .input-group {
    margin-bottom: 5px;
}

.accuracy-notification {
    margin-top: 10px;
}

.accuracy-notification .alert {
    margin-bottom: 0;
}

.coordinates-display.success {
    background: #d4edda;
    border-color: #c3e6cb;
}

.coordinates-display.warning {
    background: #fff3cd;
    border-color: #ffeaa7;
}

.map-container {
    height: 400px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #e9ecef;
}

.map-instructions {
    background: #e7f3ff;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
    border-left: 4px solid #007bff;
}

.coordinates-display {
    background: #d4edda;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
    border: 1px solid #c3e6cb;
}

.geocode-success {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
}
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/places">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∑–∞–≤–µ–¥–µ–Ω–∏—è–º
            </a>
            <span class="navbar-text">
                –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ</h4>
                    </div>
                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data" onsubmit="return validateForm()">
                            
                            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h5>üìù –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è *</label>
                                        <input type="text" class="form-control" name="title" id="title"
                                               oninput="generateSlug()" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ—Ñ–µ–π–Ω—è '–£—é—Ç–Ω–∞—è'">
                                        <div class="help-text">–¢–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è –±–µ–∑ –∞–¥—Ä–µ—Å–∞</div>
                                    </div>

                                    <!-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è slug -->
                                    <div class="mb-3">
                                        <label class="form-label">–£–ª–∏—Ü–∞ –¥–ª—è URL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="streetForSlug"
                                                   oninput="generateSlug()" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–æ—Å–∫—Ä–µ—Å–µ–Ω—Å–∫–∏–π_–±—É–ª">
                                            <span class="input-group-text">/</span>
                                            <input type="text" class="form-control" id="houseForSlug"
                                                   oninput="generateSlug()" placeholder="17.22">
                                        </div>
                                        <div class="help-text">
                                            –ó–∞–ø–æ–ª–Ω—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–≤–µ–¥–µ–Ω–∏–π. –§–æ—Ä–º–∞—Ç: –£–ª–∏—Ü–∞_–∏_–Ω–æ–º–µ—Ä/–î–æ–ø_–Ω–æ–º–µ—Ä<br>
                                            –ü—Ä–∏–º–µ—Ä: <code>–ì—É—Ä–º–µ—Ç—Ç–æ_–í–æ—Å–∫—Ä–µ—Å–µ–Ω—Å–∫–∏–π_–±—É–ª/17.22</code>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                        <textarea class="form-control" name="description" rows="3" 
                                                  placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è..."></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                        <input type="tel" class="form-control" name="telephone" 
                                               placeholder="+7 XXX XXX-XX-XX">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">–ê–¥—Ä–µ—Å</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="address"
                                                   placeholder="—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 10" id="addressInput">
                                            <button type="button" class="btn btn-outline-primary" id="geocodeButton">
                                                <i class="fas fa-search-location"></i> –ù–∞–π—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
                                            </button>
                                        </div>
                                        <div class="help-text">–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å —Å –Ω–æ–º–µ—Ä–æ–º –¥–æ–º–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π Slug -->
                                    <div class="mb-3">
                                        <label class="form-label">URL –∞–¥—Ä–µ—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</label>
                                        <div class="auto-generated">
                                            <strong>site.com/</strong><span id="slug-preview" class="text-muted">slug-–±—É–¥–µ—Ç-–∑–¥–µ—Å—å</span>
                                            <input type="text" name="slug" id="slug" style="display: none;">
                                        </div>
                                        <div id="slug-warning" class="slug-warning" style="display: none;">
                                            ‚ö†Ô∏è –ó–∞–≤–µ–¥–µ–Ω–∏–µ —Å –ø–æ—Ö–æ–∂–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
                                        </div>
                                    </div>

                                    <!-- –¢–µ–≥–∏ -->
                                    <div class="mb-3">
                                        <label class="form-label">–¢–µ–≥–∏</label>
                                        <input type="text" class="form-control" name="tags" 
                                               placeholder="—Ä–µ—Å—Ç–æ—Ä–∞–Ω, –¥–æ—Å—Ç–∞–≤–∫–∞, –µ–≤—Ä–æ–ø–µ–π—Å–∫–∞—è –∫—É—Ö–Ω—è">
                                        <div class="help-text">–í–≤–æ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</div>
                                    </div>

                                    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                                    <div class="mb-3">
                                        <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è</label>
                                        <input type="file" class="form-control" name="image" accept="image/*">
                                        <div class="help-text">
                                            –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 800x600px, —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF<br>
                                            <small style="color: #dc3545;">
                                                ‚ö†Ô∏è –ï—Å–ª–∏ –∏–º—è —Ñ–∞–π–ª–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã, –æ–Ω–æ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–æ
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>



                            <!-- –ö–∞—Ä—Ç–∞ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5>üìç –í—ã–±–æ—Ä –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è</h5>
                                    <div class="map-instructions">
                                        <i class="fas fa-info-circle"></i> –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫—É –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                                    </div>
                                    <div id="map" class="map-container"></div>

                                    <div id="coordinatesDisplay" class="coordinates-display" style="display: none;">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:</strong>
                                        <span id="currentCoords"></span>
                                        <input type="hidden" name="latitude" id="latInput">
                                        <input type="hidden" name="longitude" id="lonInput">
                                    </div>
                                </div>
                            </div>

                            <!-- –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5>üïí –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</h5>
                                    <div id="timeWorkingsContainer">
                                        <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addTimeSlot()">
                                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
                                    </button>
                                    <input type="hidden" name="working_hours" id="workingHoursInput">
                                </div>
                            </div>

                            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="category-section">
                                        <h5>üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–∞–≤–µ–¥–µ–Ω–∏—è</h5>

                                        <div class="mb-3">
                                            <label class="form-label">–í—ã–±—Ä–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
                                            <select class="form-select" name="existing_category" id="existingCategory" onchange="onExistingCategoryChange()">
                                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>
                                                {% for cat in categories %}
                                                    {% if cat and cat not in ['–ò–∫–æ–Ω–∫–∞', '–§–æ–Ω'] %}
                                                        <option value="{{ cat }}" data-category-en="{{ generate_category_en_for_template(cat) }}">
                                                            {{ cat }}
                                                        </option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–∞ (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –Ω–æ –ø–æ–ª–µ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) -->
                                        {% if current_user.role in ['editor', 'admin'] %}
                                        <div id="categoryBackgroundSection">
                                            <div class="mb-3">
                                                <label class="form-label">–§–æ–Ω –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                                <input type="file" class="form-control" name="category_background" accept="image/*" id="categoryBackgroundInput">
                                                <div class="help-text">
                                                    –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 1920x1080px. –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —Ñ–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
                                            <input type="text" class="form-control" name="new_category" id="newCategory"
                                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" oninput="generateCategoryEn()">

                                            <div class="auto-generated mt-2">
                                                <strong>–ê–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</strong>
                                                <span id="category-en-preview" class="text-muted">–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ</span>
                                                <input type="hidden" name="category_en" id="categoryEn">
                                            </div>

                                            <div class="warning-alert mt-2">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –î–ª—è –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∫–æ–Ω–∫—É —Ä–∞–∑–º–µ—Ä–æ–º 64x64px –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG.
                                            </div>
                                        </div>
                                        {% endif %}

                                        <div class="auto-generated">
                                            <strong>–ò—Ç–æ–≥–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:</strong>
                                            <span id="final-category-preview" class="text-muted">–Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- –ú–µ–Ω—é -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="menu-builder">
                                        <h5>üçΩÔ∏è –ú–µ–Ω—é</h5>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="hasMenuToggle" onchange="toggleMenuBuilder()">
                                            <label class="form-check-label" for="hasMenuToggle">–î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω—é (PDF —Ñ–∞–π–ª)</label>
                                        </div>

                                        <div id="menuBuilder" style="display: none;">
                                            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –º–µ–Ω—é -->
                                            <div class="mb-3">
                                                <label class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç—å PDF –º–µ–Ω—é *</label>
                                                <input type="file" class="form-control" name="menu_pdf" id="menuPdfInput" accept=".pdf" required>
                                                <div class="help-text">
                                                    –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 16MB. –¢–æ–ª—å–∫–æ PDF —Ñ–∞–π–ª—ã.
                                                </div>
                                            </div>

                                            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ -->
                                            <div id="menuFileInfo" class="alert alert-info" style="display: none;">
                                                <i class="fas fa-file-pdf text-danger"></i>
                                                <strong>–§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ:</strong>
                                                <span id="menuFileName" class="fw-bold"></span>
                                                <span id="menuFileSize" class="text-muted ms-2"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                            <div class="row">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–µ–¥–µ–Ω–∏–µ
                                    </button>
                                    <a href="/admin/places" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://api-maps.yandex.ru/2.1/?apikey=fc434fa5-588f-4572-b204-f43136f0a8c3&lang=ru_RU" type="text/javascript"></script>
    <!-- –í–†–ï–ú–ï–ù–ù–´–ô –û–¢–õ–ê–î–û–ß–ù–´–ô –í–´–í–û–î -->
    <script>
        console.log('üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞:');
        {% for cat in categories %}
            console.log('  - {{ cat }} -> {{ generate_category_en_for_template(cat) }}');
        {% endfor %}
    </script>
    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
let map, marker;
let existingPlaces = {{ existing_places|tojson|safe }};
let timeSlots = [];
let menuCategories = [];

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    initEventListeners();
    addTimeSlot();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    const newCategoryInput = document.getElementById('newCategory');
    if (!newCategoryInput) {
        newCategoryInput.addEventListener('input', toggleRequiredFields);
        console.log('üîí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π');
        // –î–µ–ª–∞–µ–º –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –¥–ª—è —Å—Ç–∞–∂–µ—Ä–æ–≤
        document.getElementById('existingCategory').required = true;
    }

    const existingCategory = document.getElementById('existingCategory');
    if (existingCategory) {
        existingCategory.addEventListener('change', toggleRequiredFields);
    }

    updateFinalCategoryPreview();
});

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–°–ï–• –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í ==========
function initEventListeners() {
    // –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
    const geocodeButton = document.getElementById('geocodeButton');
    if (geocodeButton) {
        geocodeButton.addEventListener('click', geocodeAddress);
    }

    // –ê–≤—Ç–æ–ø–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –≤ –ø–æ–ª–µ –∞–¥—Ä–µ—Å–∞
    const addressInput = document.getElementById('addressInput');
    if (addressInput) {
        addressInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                geocodeAddress();
            }
        });
    }

    // ‚úÖ –î–û–ë–ê–í–¨–¢–ï –≠–¢–û: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º slug –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ
    const titleInput = document.getElementById('title');
    if (titleInput && titleInput.value) {
        setTimeout(() => {
            generateSlug();
        }, 100);
    }
}

// ========== –ì–ï–û–ö–û–î–ò–†–û–í–ê–ù–ò–ï ==========
function geocodeAddress() {
    const address = document.getElementById('addressInput').value;
    if (!address) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞');
        return;
    }

    const searchBtn = document.getElementById('geocodeButton');
    const originalText = searchBtn.innerHTML;
    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü–æ–∏—Å–∫...';
    searchBtn.disabled = true;

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Nominatim
    const query = `–í–µ–ª–∏–∫–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥, ${address}`;
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                // –ò—â–µ–º —Å–∞–º—ã–π —Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Å –Ω–æ–º–µ—Ä–æ–º –¥–æ–º–∞)
                let bestResult = data[0];
                let hasHouseNumber = false;

                for (let result of data) {
                    if (result.address && result.address.house_number) {
                        bestResult = result;
                        hasHouseNumber = true;
                        break;
                    }
                }

                const lat = parseFloat(bestResult.lat);
                const lon = parseFloat(bestResult.lon);

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                setCoordinates(lat, lon);

                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
                setTimeout(() => {
                    if (map) {
                        map.setCenter([lat, lon], 17);
                    } else {
                        // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –≤—Å–µ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º ymaps.ready
                        ymaps.ready(function() {
                            if (map) {
                                map.setCenter([lat, lon], 17);
                            }
                        });
                    }
                }, 100);

                // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
                if (typeof ymaps !== 'undefined' && map) {
                    // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, —Å—Ä–∞–∑—É —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä
                    map.setCenter([lat, lon], 17);
                } else {
                    // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞, –∂–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                    ymaps.ready(function() {
                        if (map) {
                            map.setCenter([lat, lon], 17);
                        }
                    });
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ—á–Ω–æ—Å—Ç–∏
                showAlternativeAccuracyNotification(hasHouseNumber, bestResult);

            } else {
                alert('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∞–¥—Ä–µ—Å–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
        })
        .finally(() => {
            searchBtn.innerHTML = originalText;
            searchBtn.disabled = false;
        });
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
function showAlternativeAccuracyNotification(hasHouseNumber, result) {
    let message = '';
    if (!hasHouseNumber) {
        message = `
            <div class="alert alert-warning mt-2">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –ù–µ —É–¥–∞–ª–æ—Å—å —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–º–µ—Ä –¥–æ–º–∞.<br>
                <small>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –µ—ë –≤—Ä—É—á–Ω—É—é.</small>
            </div>
        `;
    } else {
        message = `
            <div class="alert alert-success mt-2">
                <i class="fas fa-check-circle"></i>
                <strong>–£—Å–ø–µ—à–Ω–æ!</strong> –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω —Å –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é.
            </div>
        `;
    }

    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const existingAlert = document.querySelector('.accuracy-notification');
    if (existingAlert) {
        existingAlert.remove();
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = 'accuracy-notification';
    notification.innerHTML = message;
    document.getElementById('coordinatesDisplay').after(notification);
}

// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
function tryAlternativeGeocoding(query, searchBtn, originalText) {
    console.log('–ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è:', query);

    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–¥–µ—Å—å –≤—ã–∑–æ–≤ –∫ —Å–≤–æ–µ–º—É —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É —ç–Ω–¥–ø–æ–∏–Ω—Ç—É
    // –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è

    alert('–°–µ—Ä–≤–∏—Å –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Ä—É—á–Ω—É—é, –∫–ª–∏–∫–Ω—É–≤ –Ω–∞ –∫–∞—Ä—Ç—É.');
    searchBtn.innerHTML = originalText;
    searchBtn.disabled = false;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏
function getPrecisionValue(result) {
    try {
        const precision = result.properties.get('metaDataProperty').GeocoderMetaData.precision;

        const precisionWeights = {
            'exact': 100,      // –¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å
            'number': 90,      // –ù–æ–º–µ—Ä –¥–æ–º–∞
            'range': 80,       // –î–∏–∞–ø–∞–∑–æ–Ω –¥–æ–º–æ–≤
            'street': 70,      // –£–ª–∏—Ü–∞
            'near': 60,        // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ
            'other': 50        // –û–±–ª–∞—Å—Ç—å
        };

        return precisionWeights[precision] || 0;
    } catch (error) {
        return 0;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
function getYandexAccuracyText(result) {
    try {
        var precision = result.properties.get('metaDataProperty').GeocoderMetaData.precision;
        var kind = result.properties.get('metaDataProperty').GeocoderMetaData.kind;

        if (precision === 'exact') {
            return '–¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å (–Ω–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä –¥–æ–º–∞)';
        } else if (precision === 'number') {
            return '–ù–æ–º–µ—Ä –¥–æ–º–∞';
        } else if (precision === 'range') {
            return '–î–∏–∞–ø–∞–∑–æ–Ω –¥–æ–º–æ–≤';
        } else if (precision === 'street') {
            return '–£–ª–∏—Ü–∞ (–Ω–æ–º–µ—Ä –¥–æ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω)';
        } else if (kind === 'house' || kind === 'street') {
            return '–£–ª–∏—Ü–∞ –∏–ª–∏ –¥–æ–º';
        } else if (kind === 'district') {
            return '–†–∞–π–æ–Ω';
        } else {
            return '–û–±–ª–∞—Å—Ç—å';
        }
    } catch (error) {
        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å';
    }
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
function showAccuracyNotification(result) {
    try {
        const accuracy = getYandexAccuracyText(result);
        const precision = result.properties.get('metaDataProperty').GeocoderMetaData.precision;

        let message = '';
        if (precision !== 'exact' && precision !== 'number') {
            message = `
                <div class="alert alert-warning mt-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> ${accuracy}<br>
                    <small>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –µ—ë –≤—Ä—É—á–Ω—É—é.</small>
                </div>
            `;
        } else {
            message = `
                <div class="alert alert-success mt-2">
                    <i class="fas fa-check-circle"></i>
                    <strong>–£—Å–ø–µ—à–Ω–æ!</strong> –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω —Å –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é.
                </div>
            `;
        }

        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const existingAlert = document.querySelector('.accuracy-notification');
        if (existingAlert) {
            existingAlert.remove();
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.className = 'accuracy-notification';
        notification.innerHTML = message;
        document.getElementById('coordinatesDisplay').after(notification);
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
    }
}

// ========== –ö–ê–†–¢–ê ==========
function initMap() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç –±–µ–∑ –∫–ª—é—á–∞ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
    ymaps.ready(function() {
        try {
            map = new ymaps.Map('map', {
                center: [58.5211, 31.2758],
                zoom: 13
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.events.add('click', function(e) {
                var coords = e.get('coords');
                setCoordinates(coords[0], coords[1]);
            });

            console.log('–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
        }
    });
}

// ========== –£–°–¢–ê–ù–û–í–ö–ê –ö–û–û–†–î–ò–ù–ê–¢ ==========
function setCoordinates(lat, lng) {
    const latFixed = lat.toFixed(6);
    const lngFixed = lng.toFixed(6);

    document.getElementById('latInput').value = latFixed;
    document.getElementById('lonInput').value = lngFixed;

    document.getElementById('currentCoords').textContent = `${latFixed}, ${lngFixed}`;
    document.getElementById('coordinatesDisplay').style.display = 'block';

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –º–µ—Ç–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
    if (marker) {
        map.geoObjects.remove(marker);
    }

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
    marker = new ymaps.Placemark([lat, lng], {
        balloonContent: `
            <b>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</b><br>
            –®–∏—Ä–æ—Ç–∞: ${latFixed}<br>
            –î–æ–ª–≥–æ—Ç–∞: ${lngFixed}<br>
            <small>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –º–µ—Ç–∫—É –¥–ª—è —Ç–æ—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</small>
        `
    }, {
        preset: 'islands#blueDotIcon',
        draggable: true
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç—É
    map.geoObjects.add(marker);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏
    marker.events.add('dragend', function() {
        var newCoords = marker.geometry.getCoordinates();
        const newLat = newCoords[0].toFixed(6);
        const newLng = newCoords[1].toFixed(6);

        document.getElementById('latInput').value = newLat;
        document.getElementById('lonInput').value = newLng;
        document.getElementById('currentCoords').textContent = `${newLat}, ${newLng}`;

        marker.properties.set('balloonContent', `
            <b>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</b><br>
            –®–∏—Ä–æ—Ç–∞: ${newLat}<br>
            –î–æ–ª–≥–æ—Ç–∞: ${newLng}<br>
            <small>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –º–µ—Ç–∫—É –¥–ª—è —Ç–æ—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</small>
        `);
    });

    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–ª—É–Ω
    marker.balloon.open();
}
// ========== SLUG –ì–ï–ù–ï–†–ê–¶–ò–Ø ==========
function generateSlug() {
    const title = document.getElementById('title').value;
    const street = document.getElementById('streetForSlug').value;
    const house = document.getElementById('houseForSlug').value;

    if (!title) {
        document.getElementById('slug-preview').textContent = 'slug-–±—É–¥–µ—Ç-–∑–¥–µ—Å—å';
        document.getElementById('slug').value = '';
        document.getElementById('slug-warning').style.display = 'none';
        return;
    }

    // –ü—Ä–æ—Å—Ç–∞—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
    const translitDict = {
        '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'yo',
        '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm',
        '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
        '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sch',
        '—ä': '', '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya'
    };

    // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    let titleSlug = title.toLowerCase().split('').map(char => {
        return translitDict[char] || (char.match(/[a-z0-9]/) ? char : '-');
    }).join('').replace(/-+/g, '-').replace(/^-|-$/g, '');

    let slug = titleSlug;

    // –î–æ–±–∞–≤–ª—è–µ–º —É–ª–∏—Ü—É –∏ –¥–æ–º –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã
    if (street) {
        let streetSlug = street.toLowerCase().split('').map(char => {
            return translitDict[char] || (char.match(/[a-z0-9]/) ? char : '-');
        }).join('').replace(/-+/g, '-').replace(/^-|-$/g, '');

        if (streetSlug) {
            slug += '_' + streetSlug;
        }
    }

    if (house) {
        slug += '/' + house.replace(/[^a-zA-Z0-9\-_\.\/]/g, '');
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
    const isDuplicate = existingPlaces.some(place =>
        place.slug && place.slug.toLowerCase() === slug.toLowerCase()
    );

    if (isDuplicate) {
        document.getElementById('slug-warning').style.display = 'block';
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –µ—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç
        let counter = 1;
        let finalSlug = slug + '-' + counter;
        while (existingPlaces.some(place =>
            place.slug && place.slug.toLowerCase() === finalSlug.toLowerCase()
        )) {
            counter++;
            finalSlug = slug + '-' + counter;
        }
        slug = finalSlug;
    } else {
        document.getElementById('slug-warning').style.display = 'none';
    }

    document.getElementById('slug-preview').textContent = slug;
    document.getElementById('slug').value = slug;
    console.log('‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω slug:', slug);
}

// ========== –ö–ê–¢–ï–ì–û–†–ò–ò ==========
function generateCategoryEn() {
    const newCategoryInput = document.getElementById('newCategory');
    if (!newCategoryInput) return;

    const category = newCategoryInput.value;
    if (!category) {
        document.getElementById('category-en-preview').textContent = '–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ';
        return;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ category_en
    fetch('/api/generate_category_en', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ category: category })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('category-en-preview').textContent = data.category_en;
            document.getElementById('categoryEn').value = data.category_en;
            updateFinalCategoryPreview();
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ category_en:', error);
        // Fallback –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
        const categoryEn = category.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
        document.getElementById('category-en-preview').textContent = categoryEn;
        document.getElementById('categoryEn').value = categoryEn;
        updateFinalCategoryPreview();
    });
}

function onExistingCategoryChange() {
    const select = document.getElementById('existingCategory');
    const selectedOption = select.options[select.selectedIndex];
    const selectedCategory = select.value;

    if (selectedCategory) {
        const categoryEn = selectedOption.getAttribute('data-category-en');

        // ‚úÖ –ü–†–û–í–ï–†–ö–ê: category_en –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
        if (categoryEn && !/^[a-z0-9_]+$/.test(categoryEn)) {
            console.warn('‚ö†Ô∏è category_en —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã:', categoryEn);
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π category_en
            generateCategoryEnForExisting(selectedCategory);
            return;
        }

        document.getElementById('final-category-preview').textContent = selectedCategory;
        document.getElementById('category-en-preview').textContent = categoryEn;
        document.getElementById('categoryEn').value = categoryEn;

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const newCategoryInput = document.getElementById('newCategory');
        if (newCategoryInput) {
            newCategoryInput.value = '';
        }

        updateFinalCategoryPreview();
    }
}

function generateCategoryEnForExisting(category) {
    fetch('/api/generate_category_en', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ category: category })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('category-en-preview').textContent = data.category_en;
            document.getElementById('categoryEn').value = data.category_en;
            updateFinalCategoryPreview();
        }
    });
}

        // ========== –í–†–ï–ú–Ø –†–ê–ë–û–¢–´ ==========
        function addTimeSlot() {
            const container = document.getElementById('timeWorkingsContainer');
            const slotId = timeSlots.length;
            
            const slotHTML = `
                <div class="time-slot" id="timeSlot${slotId}">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">–î–Ω–∏ –Ω–µ–¥–µ–ª–∏</label>
                            <input type="text" class="form-control days-input" placeholder="–ü–Ω-–ü—Ç, –°–±-–í—Å" 
                                   onchange="updateWorkingHours()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">–í—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è</label>
                            <input type="time" class="form-control open-time" onchange="updateWorkingHours()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">–í—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è</label>
                            <input type="time" class="form-control close-time" onchange="updateWorkingHours()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                                    onclick="removeTimeSlot(${slotId})">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', slotHTML);
            timeSlots.push(slotId);
        }

        function removeTimeSlot(slotId) {
            const element = document.getElementById(`timeSlot${slotId}`);
            if (element) element.remove();
            timeSlots = timeSlots.filter(id => id !== slotId);
            updateWorkingHours();
        }

        function updateWorkingHours() {
            const workingHours = {};
            
            timeSlots.forEach(slotId => {
                const slotElement = document.getElementById(`timeSlot${slotId}`);
                if (slotElement) {
                    const days = slotElement.querySelector('.days-input').value;
                    const openTime = slotElement.querySelector('.open-time').value;
                    const closeTime = slotElement.querySelector('.close-time').value;
                    
                    if (days && openTime && closeTime) {
                        workingHours[days] = `${openTime}-${closeTime}`;
                    }
                }
            });
            
            document.getElementById('workingHoursInput').value = JSON.stringify(workingHours);
        }

        // ========== –ú–ï–ù–Æ ==========
        function toggleMenuBuilder() {
    const menuBuilder = document.getElementById('menuBuilder');
    const toggle = document.getElementById('hasMenuToggle');
    const menuPdfInput = document.getElementById('menuPdfInput');

    menuBuilder.style.display = toggle.checked ? 'block' : 'none';

    // –£–ø—Ä–∞–≤–ª—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –ø–æ–ª—è
    if (menuPdfInput) {
        menuPdfInput.required = toggle.checked;
    }

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏
    if (!toggle.checked) {
        resetMenuFile();
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –º–µ–Ω—é
document.addEventListener('DOMContentLoaded', function() {
    const menuPdfInput = document.getElementById('menuPdfInput');
    if (menuPdfInput) {
        menuPdfInput.addEventListener('change', function(e) {
            handleMenuFileSelect(e);
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª—è
    const toggle = document.getElementById('hasMenuToggle');
    if (toggle && menuPdfInput) {
        menuPdfInput.required = toggle.checked;
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –º–µ–Ω—é
function handleMenuFileSelect(event) {
    const file = event.target.files[0];
    const fileInfo = document.getElementById('menuFileInfo');
    const fileName = document.getElementById('menuFileName');
    const fileSize = document.getElementById('menuFileSize');

    if (file) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        if (file.type !== 'application/pdf') {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF');
            resetMenuFile();
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (16MB)
        const maxSize = 16 * 1024 * 1024; // 16MB –≤ –±–∞–π—Ç–∞—Ö
        if (file.size > maxSize) {
            alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 16MB');
            resetMenuFile();
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        fileName.textContent = file.name;
        fileSize.textContent = `(${formatFileSize(file.size)})`;
        fileInfo.style.display = 'block';

        console.log('‚úÖ PDF –º–µ–Ω—é –≤—ã–±—Ä–∞–Ω:', file.name, formatFileSize(file.size));
    } else {
        resetMenuFile();
    }
}

// –°–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –º–µ–Ω—é
function resetMenuFile() {
    const menuPdfInput = document.getElementById('menuPdfInput');
    const fileInfo = document.getElementById('menuFileInfo');

    if (menuPdfInput) {
        menuPdfInput.value = '';
    }
    if (fileInfo) {
        fileInfo.style.display = 'none';
    }
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';

    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ========== –í–ê–õ–ò–î–ê–¶–ò–Ø –§–û–†–ú–´ ==========
function validateForm() {
    const title = document.getElementById('title').value;
    const existingCategory = document.getElementById('existingCategory').value;
    const newCategoryInput = document.getElementById('newCategory');
    const newCategory = newCategoryInput ? newCategoryInput.value : '';
    const bgFile = document.getElementById('categoryBackgroundInput')?.files[0];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ñ–æ–Ω
    const isCreatingBackground = bgFile && bgFile.name !== '';

    // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ñ–æ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    if (isCreatingBackground) {
        if (!existingCategory && !newCategory) {
            alert('‚ùå –î–ª—è —Ñ–æ–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
            return false;
        }
        console.log('‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è —Ñ–æ–Ω –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        return true;
    }

    // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –º–µ—Å—Ç –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    if (!title) {
        alert('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
        return false;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –º–µ—Å—Ç
    if (!existingCategory && !newCategory) {
        if (newCategoryInput) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é');
        } else {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞');
        }
        return false;
    }

    console.log('‚úÖ –§–æ—Ä–º–∞ –ø—Ä–æ—à–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é');
    return true;
}
    </script>
</body>
</html>