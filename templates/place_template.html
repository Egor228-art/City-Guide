<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–ì–æ—Ä–æ–¥—Å–∫–æ–π –≥–∏–¥ - {{ place.title if place else title }}</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ CSS —Ñ–∞–π–ª–∞ -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/PersonalPage.css') }}">
    <!-- –£–∫—Ä–∞—à–∞–µ–º –≤–∫–ª–∞–¥–∫—É –≤–∞—à–∏–º –ª–æ–≥–æ—Ç–∏–ø–æ–º -->
    <link rel="icon" href="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–ª–æ–≥–æ.png') }}" type="image/png">

    <script src="{{ url_for('static', filename='js/RegistrationLogin.js') }}"></script>
</head>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

<body>
    <!-- –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
<nav class="navbar">
    <div class="nav-container">
        <div class="logo" onclick="window.location.href='/';">
            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–ª–æ–≥–æ.png') }}" alt="–õ–æ–≥–æ—Ç–∏–ø" height="50px" width="70px">
            <span>–ì–æ—Ä–æ–¥—Å–∫–æ–π –ì–∏–¥</span>
        </div>

        <!-- –ü–æ–∏—Å–∫ –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ HTML —Å –≤–∏–∑—É–∞–ª–æ–º –Ω–æ–≤–æ–≥–æ -->
        <form class="search-box" action="/search" method="POST">
            <input type="text" name="query" placeholder="–ü–æ–∏—Å–∫ –∑–∞–≤–µ–¥–µ–Ω–∏–π..." class="search-input" id="search-input">
            <button type="submit" class="search-button">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M21 21L16.65 16.65" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </form>

        <!-- –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ HTML -->
        <div class="favorites-wrapper">
            <div class="favorite-wrapper" id="header-favorites-btn" style="display: none;" onclick="window.location.href='/favorites'">
              <span class="particle particle-1">‚ú¶</span>
              <span class="particle particle-2">‚ú¶</span>
              <span class="particle particle-3">‚ú¶</span>
              <span class="particle particle-4">‚ú¶</span>
              <span class="particle particle-5">‚ú¶</span>
                <span class="particle particle-6">‚ú¶</span>
              <span class="particle particle-7">‚ú¶</span>
              <span class="heart-icon">‚ù§</span>
              <span class="favorites-counter" id="favorites-count">0</span>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ HTML —Å –≤–∏–∑—É–∞–ª–æ–º –Ω–æ–≤–æ–≥–æ -->
        <div class="auth-buttons">
            <button id="loginButton" class="btn-login" onclick="showWindow()">–í—Ö–æ–¥</button>
            <button id="registerButton" class="btn-register" onclick="showWindow1()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <div id="userInfo" style="display: none;">
                <div class="–ö–æ—Ä–æ–±–∫–∞">
                    <img id="avatar" src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/avatar.png') }}" alt="Avatar">
                    <span id="welcomeUser"></span>
                </div>
                <button class="btn-logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
            </div>
        </div>
    </div>
    <div class="clouds"></div>
</nav>

<!-- –û–∫–Ω–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ HTML -->
<div id="overlay" style="display: none;"></div>

<div id="content_window" class="popup-window">
    <form id="loginForm" method="POST" action="/login">
        <h1>–í—Ö–æ–¥</h1>
        <span class="btnX" onclick="hideWindow()">√ó</span>
        <div class="form-group">
            <label for="username">–õ–æ–≥–∏–Ω</label>
            <input type="text" class="form-control" id="username" name="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" required>
        </div>
        <div class="form-group">
            <label for="password">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" class="form-control" id="password" name="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
        </div>
        <button type="submit" class="btnA">–í–æ–π—Ç–∏</button>
    </form>
</div>

<div id="content_window2" class="popup-window">
    <form id="regForm" method="POST" action="/register">
        <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
        <span class="btnX" onclick="hideWindow1()">√ó</span>
        <div class="form-group">
            <label for="username1">–õ–æ–≥–∏–Ω</label>
            <input type="text" id="username1" name="username" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" required>
        </div>
        <div class="form-group">
            <label for="password1">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="password1" name="password" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
        </div>
        <div class="form-group">
            <label for="password2">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="password2" name="confirm_password" class="form-control" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
        </div>
        <div class="form-group">
            <label for="secret_key">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á</label>
            <input type="password" id="secret_key" name="secret_key" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á" required>
        </div>
        <button type="submit" class="btnB">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </form>
</div>

    <!-- –ó–∞–¥–Ω–∏–π —Ñ–æ–Ω -->
    <div class="image-container">
        <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–†–µ—Å—Ç–æ—Ä–∞–Ω–§–æ–Ω.jpg') }}" class="img-top-center" alt="–†–µ—Å—Ç–æ—Ä–∞–Ω–§–æ–Ω.jpg">
    </div>

    <div class="box">
        <div class="container">
            <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –∫–∞—Ä—Ç–∏–Ω–∫–∞ -->
            <div class="image-section">
                <div class="image-flip-container">
                    <!-- –ü–µ—Ä–µ–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ (–∫–∞—Ä—Ç–∏–Ω–∫–∞) -->
                    <div class="image-front">
                        {% if place.image_path %}
                            <img src="{{ url_for('static', filename=place.image_path) }}" alt="{{ place.title }}">
                        {% else %}
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/placeholder.png') }}" alt="–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                        {% endif %}

                        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è -->
                        <button class="favorite-btn js-favorite-btn"
                                data-item-id="{{ place.slug }}"
                                data-item='{"id":"{{ place.slug }}",
                                            "name":"{{ place.title }}",
                                            "description":"{{ place.description }}",
                                            "image":"{{ url_for('static', filename=place.image_path) if place.image_path else url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/placeholder.png') }}",
                                            "address":"{{ place.address }}",
                                            "telephone":"{{ place.telephone }}",
                                            "category":"{{ place.category }}",
                                            "page_url":"/place/{{ place.slug }}"}'>
                          ‚ù§
                        </button>

                        <!-- –ö–Ω–æ–ø–∫–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É -->
                        <button class="expand-btn" onclick="expandImage(this)">‚Üó</button>

                        <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–Ω–∏–∑—É -->
                        <button class="map-btn" onclick="flipCard()">–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É</button>

                        <!-- –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
                        <div class="schedule-dropdown">
                            <button class="schedule-btn">–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã ‚ñº</button>
                            <div class="schedule-content" id="schedule-content">
                                {{ place.get_working_hours_display()|safe }}
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–Ω–∏–∑—É -->
                        <button class="menu-btn" onclick="openMenuModal()">–ú–µ–Ω—é</button>
                    </div>

                    <!-- –ó–∞–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ (–∫–∞—Ä—Ç–∞) -->
                    <div class="image-back">
                        <div class="map-container">
                            {% if place.latitude and place.longitude %}
                            <div id="yandex-map" style="width: 100%; height: 400px;"></div>
                            <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
                            <script>
                                ymaps.ready(function() {
                                    var map = new ymaps.Map('yandex-map', {
                                        center: [{{ place.latitude }}, {{ place.longitude }}],
                                        zoom: 16
                                    });

                                    var placemark = new ymaps.Placemark([{{ place.latitude }}, {{ place.longitude }}], {
                                        hintContent: '{{ place.title }}',
                                        balloonContent: '{{ place.address }}'
                                    });

                                    map.geoObjects.add(placemark);
                                });
                            </script>
                            {% else %}
                            <p>–ö–∞—Ä—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>
                            {% endif %}
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–Ω–∏–∑—É -->
                        <button class="back-btn" onclick="flipCard()">–ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –æ–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="details-section">
                <h1>{{ place.title }}</h1>
                <p>{{ place.description }}</p>

                <div class="contact-info" style="display: flex; align-items: center; gap: 8px;">
                    <svg style="width: 18px; height: 18px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                    <p style="margin: 0;">{{ place.telephone if place.telephone else '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω' }}</p>
                </div>

                <div class="address-info" style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                    <svg style="width: 18px; height: 18px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <p style="margin: 0;">{{ place.address if place.address else '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω' }}</p>
                </div>
            </div>
        </div>

        <!-- –¢–µ–≥–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è -->
        <div class="tags-section">
            <h3>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</h3>
            <div class="tags-container">
                <div class="tags-scroller">
                    {% if place.tags %}
                        {% set tags_list = place.tags.split(',') %}
                        {% for tag in tags_list %}
                            <span class="tag">{{ tag }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="tag">–ù–µ—Ç –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π</span>
                    {% endif %}
                </div>
                <button class="tags-scroll-btn left" onclick="scrollTags('left')">‚Äπ</button>
                <button class="tags-scroll-btn right" onclick="scrollTags('right')">‚Ä∫</button>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
        <div class="reviews">
            <h2>–û—Ç–∑—ã–≤—ã</h2>
            <p>–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: <strong id="overall-rating">0.0</strong> (–Ω–∞ –æ—Å–Ω–æ–≤–µ <span id="total-reviews">0</span> –æ—Ç–∑—ã–≤–æ–≤)</p>
            <div class="rating-bars">
                <div class="rating-bar">
                    <span>5 –∑–≤—ë–∑–¥</span>
                    <div class="bar" style="margin-left: 10px"><div class="fill" style="width: 0;"></div></div>
                    <span>0</span>
                </div>
                <div class="rating-bar">
                    <span>4 –∑–≤—ë–∑–¥—ã</span>
                    <div class="bar"><div class="fill" style="width: 0;"></div></div>
                    <span>0</span>
                </div>
                <div class="rating-bar">
                    <span>3 –∑–≤—ë–∑–¥—ã</span>
                    <div class="bar"><div class="fill" style="width: 0;"></div></div>
                    <span>0</span>
                </div>
                <div class="rating-bar">
                    <span>2 –∑–≤—ë–∑–¥—ã</span>
                    <div class="bar"><div class="fill" style="width: 0;"></div></div>
                    <span>0</span>
                </div>
                <div class="rating-bar">
                    <span>1 –∑–≤–µ–∑–¥–∞</span>
                    <div class="bar"><div class="fill" style="width: 0;"></div></div>
                    <span>0</span>
                </div>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä –æ—Ç–∑—ã–≤–æ–≤ -->
            <div class="review-filter">
                <label>–§–∏–ª—å—Ç—Ä –ø–æ –æ—Ü–µ–Ω–∫–∞–º:</label>
                <div class="filter-controls">
                    <div class="stars" id="filter-stars">
                        <span class="star" data-value="1">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="2">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="3">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="4">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="5">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                    </div>
                    <div class="reaction-filters">
                        <span class="filter-btn" data-type="likes" title="–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–∑—ã–≤—ã —Å –ª–∞–π–∫–∞–º–∏">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–õ–∞–π–∫.png') }}" alt="–õ–∞–π–∫–∏">
                        </span>
                        <span class="filter-btn" data-type="dislikes" title="–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–∑—ã–≤—ã —Å –¥–∏–∑–ª–∞–π–∫–∞–º–∏">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–î–∏–∑–ª–∞–π–∫.png') }}" alt="–î–∏–∑–ª–∞–π–∫–∏">
                        </span>
                    </div>
                </div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ -->
            <div class="review-container">
                <button class="scroll-button left" onclick="scrollReviews('left')">‚óÑ</button>
                <div class="review-list" id="review-list">
                    <!-- –û—Ç–∑—ã–≤—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
                </div>
                <button class="scroll-button right" onclick="scrollReviews('right')">‚ñ∫</button>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ "–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤" -->
            <button class="review-container-button" onclick="openReviewModal()">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>

            <script>
            function resetAllLimits() {
                localStorage.removeItem('reviewLimits');
                console.log('‚úÖ –í—Å–µ –ª–∏–º–∏—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã');
                showNotification('–í—Å–µ –ª–∏–º–∏—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã - –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å', 'success');
            }
            </script>
        </div>

        <!-- –í –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –º–µ–Ω—é -->
        <div class="modal" id="menu-modal">
            <div class="modal-content">
                <span class="close" onclick="closeMenuModal()">&times;</span>
                <h2>–ú–µ–Ω—é - {{ place.title }}</h2>
                <div id="menu-content">
                    {% set menu_data = place.get_menu_data() %}
                    {% if menu_data %}
                        {% for category, items in menu_data.items() %}
                            <h3 style="color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 5px;">
                                {{ category }}
                            </h3>
                            <ul style="list-style: none; padding: 0;">
                                {% for item in items %}
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="font-weight: bold;">{{ item.name }}</span>
                                            <span style="color: #000000;">{{ item.price }}</span>
                                        </div>
                                            <span style="display: block;">{{ item.description }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                            <br>
                        {% endfor %}
                    {% else %}
                        <p>–ú–µ–Ω—é –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ</p>
                    {% endif %}
                </div>
                <button class="review-menu-container-button" onclick="closeMenuModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–∑—ã–≤–∞ -->
        <div class="modal" id="review-modal">
            <div class="modal-content">
                <span class="close" onclick="closeReviewModal()">&times;</span>
                <h2>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h2>
                <form id="review-form">
                    <label class="review-form-name" for="name">–ò–º—è:</label>
                    <input class="pp" type="text" id="name" required><br><br>
                    <label>–û—Ü–µ–Ω–∫–∞: <span id="rating-error" style="color: red; display: none; font-size: 11px">*–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ</span></label>
                    <div class="stars" id="review-stars">
                        <span class="star" data-value="1">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="2">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="3">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="4">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="5">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                    </div><br>
                    <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label><br>
                    <textarea id="comment" rows="4"></textarea><br><br>
                    <button class="review-form-button" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </form>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–≥–æ –æ—Ç–∑—ã–≤–∞ -->
        <div class="modal" id="full-review-modal">
            <div class="modal-content">
                <span class="close" onclick="closeFullReviewModal()">&times;</span>
                <h2>–ü–æ–ª–Ω—ã–π –æ—Ç–∑—ã–≤</h2>
                <div class="review-header">
                    <img class="avatar" src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/avatar.png') }}" alt="–ê–≤–∞—Ç–∞—Ä">
                    <div class="name-rating-modal">
                        <div class="review-name"></div>
                        <div class="review-rating"></div>
                    </div>
                </div>
                <div class="review-comment"></div>
                <div class="review-actions">
                    <button class="like-btn" onclick="likeReview()">
                        <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–õ–∞–π–∫.png') }}" alt="–õ–∞–π–∫">
                        <span class="like-count">0</span>
                    </button>
                    <button class="dislike-btn" onclick="dislikeReview()">
                        <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–î–∏–∑–ª–∞–π–∫.png') }}" alt="–î–∏–∑–ª–∞–π–∫">
                        <span class="dislike-count">0</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
    <div class="modal" id="edit-review-modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤</h2>
            <form id="edit-review-form">
                <input type="hidden" id="edit-review-id">
                <input type="hidden" id="edit-user-token" value="">

                <div class="form-group">
                    <label>–û—Ü–µ–Ω–∫–∞:</label>
                    <div class="stars" id="edit-stars">
                        <span class="star" data-value="1" onclick="setEditRating(1)">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="2" onclick="setEditRating(2)">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="3" onclick="setEditRating(3)">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="4" onclick="setEditRating(4)">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                        <span class="star" data-value="5" onclick="setEditRating(5)">
                            <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">
                        </span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                    <textarea id="edit-comment" rows="4" style="width: 430px;" required></textarea>
                </div>

                <div class="form-buttons">
                    <button style="margin-right: 100px;" type="button" class="review-form-button" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–û –ø—Ä–æ–µ–∫—Ç–µ" -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <h2>–û –ø—Ä–æ–µ–∫—Ç–µ "–ì–æ—Ä–æ–¥—Å–∫–æ–π –ì–∏–¥"</h2>
            <p>"–ì–æ—Ä–æ–¥—Å–∫–æ–π –ì–∏–¥" - —ç—Ç–æ —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø—É—Ç–µ–≤–æ–¥–∏—Ç–µ–ª—å –ø–æ –í–µ–ª–∏–∫–æ–º—É –ù–æ–≤–≥–æ—Ä–æ–¥—É, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è –∂–∏—Ç–µ–ª–µ–π –∏ –µ–≥–æ –≥–æ—Å—Ç–µ–π. –ù–∞—à –ø—Ä–æ–µ–∫—Ç –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤ —Å–µ–±–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∞–º—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö, –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö, –∫–∞—Ñ–µ, —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö –∏ –º—É–∑–µ—è—Ö.</p>
            <p>–ú—ã —Å—Ç—Ä–µ–º–∏–º—Å—è —Å–¥–µ–ª–∞—Ç—å –ø—Ä–µ–±—ã–≤–∞–Ω–∏–µ –≤ –í–µ–ª–∏–∫–æ–º –ù–æ–≤–≥–æ—Ä–æ–¥–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Ä–æ–¥–µ –≤ —É–¥–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.</p>
            <p>–ù–∞—à –≥–∏–¥ —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–æ–≤—ã–º–∏ –ª–æ–∫–∞—Ü–∏—è–º–∏, —á—Ç–æ–±—ã –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–≥–ª–∏ –Ω–∞–π—Ç–∏ —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –¥–ª—è —Å–µ–±—è.</p>
            <h3>–ù–∞—à–∏ —Ü–µ–ª–∏:</h3>
            <ul>
                <li>–ü–æ–ø—É–ª—è—Ä–∏–∑–∞—Ü–∏—è –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –Ω–∞—Å–ª–µ–¥–∏—è –í–µ–ª–∏–∫–æ–≥–æ –ù–æ–≤–≥–æ—Ä–æ–¥–∞</li>
                <li>–£–ø—Ä–æ—â–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –≥–æ—Ä–æ–¥—É –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤</li>
                <li>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ—Å—Ç–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞</li>
                <li>–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –ª—é–±–∏—Ç–µ–ª–µ–π –≥–æ—Ä–æ–¥–∞</li>
            </ul>
        </div>
    </div>

    <!-- –ì–æ—Ä–æ–¥—Å–∫–æ–π —Å–∏–ª—É—ç—Ç –ø–µ—Ä–µ–¥ —Ñ—É—Ç–µ—Ä–æ–º -->
    <div class="skyscrapers"></div>

    <!-- –§—É—Ç–µ—Ä -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section about">
                <img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–ª–æ–≥–æ.png') }}" style="width: 120px;" alt="–õ–æ–≥–æ—Ç–∏–ø">
                <p>–ì–æ—Ä–æ–¥—Å–∫–æ–π –≥–∏–¥ - –≤–∞—à –ø—É—Ç–µ–≤–æ–¥–∏—Ç–µ–ª—å –ø–æ –ª—É—á—à–∏–º –º–µ—Å—Ç–∞–º –í–µ–ª–∏–∫–æ–≥–æ –ù–æ–≤–≥–æ—Ä–æ–¥–∞</p>
                <div class="socials">
                    <a href="https://web.telegram.org/"><img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/TG.png') }}" alt="Telegram"></a>
                    <a href="https://www.youtube.com/"><img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/YT.png') }}" style="margin-bottom: 0; margin-top: 8px" alt="YouTube"></a>
                    <a href="https://vk.ru/"><img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/vk.png') }}" alt="VK"></a>
                    <a href="https://ok.ru/"><img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/OK.png') }}" alt="OK"></a>
                </div>
            </div>

            <div class="footer-section links">
                <h3>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                <ul>
                    <li><a href="#" id="homeLink">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li><a href="#" id="aboutLink">–û –ø—Ä–æ–µ–∫—Ç–µ</a></li>
                    <li><a href="#" id="contactsLink">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                    <li><a href="https://vk.com/egorsvistinov" target="_blank" id="helpLink">–ü–æ–º–æ—â—å</a></li>
                </ul>
            </div>

            <div class="footer-section contact">
                <h3 id="contactsTitle">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
                <p><i class="phone-icon"></i> +7 (123) 456-78-90</p>
                <p><i class="email-icon"></i> info@gorodskoygid.ru</p>
                <p><i class="location-icon"></i> –í–µ–ª–∏–∫–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥</p>
            </div>
        </div>

        <div class="footer-bottom">
            &copy; 2025 –ì–æ—Ä–æ–¥—Å–∫–æ–π –ì–∏–¥ | –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã
        </div>
    </footer>
    <script>
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
const PATHS = {
    starActive: "/static/–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/baka.png",
    starInactive: "/static/–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png",
    avatar: "/static/–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/avatar.png",
    like: "/static/–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–õ–∞–π–∫.png",
    dislike: "/static/–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–î–∏–∑–ª–∞–π–∫.png"
};

//–ö–Ω–æ–ø–∫–∏ –§—É—Ç–µ—Ä–∞ - –ù–∞—á–∞–ª–æ

const homeLink = document.getElementById('homeLink');
const aboutLink = document.getElementById('aboutLink');
const contactsLink = document.getElementById('contactsLink');
const helpLink = document.getElementById('helpLink');
const aboutModal = document.getElementById('aboutModal');
const closeModal = document.getElementById('closeModal');
const arrowContainer = document.getElementById('arrowContainer');
const arrowLine = document.getElementById('arrowLine');
const arrowHead = document.getElementById('arrowHead');
const contactsTitle = document.getElementById('contactsTitle');

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ì–ª–∞–≤–Ω–∞—è"
homeLink.addEventListener('click', function(e) {
    e.preventDefault();
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    window.location.href = "/";
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û –ø—Ä–æ–µ–∫—Ç–µ"
aboutLink.addEventListener('click', function(e) {
    e.preventDefault();
    aboutModal.style.display = 'flex';
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
closeModal.addEventListener('click', function() {
    aboutModal.style.display = 'none';
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.addEventListener('click', function(e) {
    if (e.target === aboutModal) {
        aboutModal.style.display = 'none';
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ö–æ–Ω—Ç–∞–∫—Ç—ã"
contactsLink.addEventListener('click', function(e) {
    e.preventDefault();

    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    const contactsLinkRect = contactsLink.getBoundingClientRect();
    const contactsTitle = document.querySelector('.footer-section.contact h3');
    const contactsTitleRect = contactsTitle.getBoundingClientRect();

    // –î–æ–±–∞–≤–ª—è–µ–º scroll offset –∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
    const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
    const scrollY = window.pageYOffset || document.documentElement.scrollTop;

    const startX = contactsLinkRect.left + scrollX + contactsLinkRect.width + 10;
    const startY = contactsLinkRect.top + scrollY + contactsLinkRect.height / 2;

    const endX = contactsTitleRect.left + scrollX - 5;
    const endY = contactsTitleRect.top + scrollY + contactsTitleRect.height;

    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–µ–ª–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
    const existingArrow = document.querySelector('.arrow-to-contacts');
    if (existingArrow) {
        existingArrow.remove();
    }

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è SVG —Å—Ç—Ä–µ–ª–∫–∏
    const arrowContainer = document.createElement('div');
    arrowContainer.className = 'arrow-to-contacts';
    document.body.appendChild(arrowContainer);

    // –°–æ–∑–¥–∞–µ–º SVG –¥–ª—è —Å—Ç—Ä–µ–ª–∫–∏ —Å –∑–∞–≤–∏—Ç—É—à–∫–æ–π
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("width", "100%");
    svg.setAttribute("height", "100%");
    svg.style.position = 'absolute';
    svg.style.top = '0';
    svg.style.left = '0';
    svg.style.pointerEvents = 'none';

    // –í—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è SVG
    const minX = Math.min(startX, endX) - 50;
    const minY = Math.min(startY, endY) - 50;
    const maxX = Math.max(startX, endX) + 50;
    const maxY = Math.max(startY, endY) + 50;
    const width = maxX - minX;
    const height = maxY - minY;

    // –°–æ–∑–¥–∞–µ–º –ø—É—Ç—å —Å –∑–∞–≤–∏—Ç—É—à–∫–æ–π
    const path = document.createElementNS(svgNS, "path");
    const curveIntensity = 80;

    // –ü—É—Ç—å —Å –∫—Ä–∞—Å–∏–≤–æ–π –∫—Ä–∏–≤–æ–π
    const pathData = `M ${startX - minX} ${startY - minY}
                     C ${startX - minX + curveIntensity} ${startY - minY - curveIntensity},
                       ${endX - minX - curveIntensity} ${endY - minY - curveIntensity},
                       ${endX - minX} ${endY - minY}`;

    path.setAttribute("d", pathData);
    path.setAttribute("class", "arrow-path");
    path.style.filter = 'drop-shadow(0 0 2px rgba(52, 152, 219, 0.5))';

    // –°–æ–∑–¥–∞–µ–º –≥–æ–ª–æ–≤–∫—É —Å—Ç—Ä–µ–ª–∫–∏
    const arrowHead = document.createElementNS(svgNS, "polygon");
    arrowHead.setAttribute("points", "0,0 -10,-7 -10,7");
    arrowHead.setAttribute("class", "arrow-head");
    arrowHead.setAttribute("fill", "#3498db");

    // –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª –¥–ª—è –≥–æ–ª–æ–≤–∫–∏ —Å—Ç—Ä–µ–ª–∫–∏
    const pathElement = document.createElementNS(svgNS, "path");
    pathElement.setAttribute("d", pathData);
    const pathLength = pathElement.getTotalLength();
    const point = pathElement.getPointAtLength(Math.max(0, pathLength - 1));
    const pointBefore = pathElement.getPointAtLength(Math.max(0, pathLength - 20));
    const angle = Math.atan2(point.y - pointBefore.y, point.x - pointBefore.x) * 180 / Math.PI;

    arrowHead.setAttribute("transform", `translate(${endX - minX},${endY - minY}) rotate(${angle})`);
    arrowHead.style.filter = 'drop-shadow(0 0 2px rgba(52, 152, 219, 0.5))';

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã SVG
    svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
    arrowContainer.style.width = width + 'px';
    arrowContainer.style.height = height + 'px';
    arrowContainer.style.left = minX + 'px';
    arrowContainer.style.top = minY + 'px';
    arrowContainer.style.position = 'absolute'; // –ú–µ–Ω—è–µ–º fixed –Ω–∞ absolute

    svg.appendChild(path);
    svg.appendChild(arrowHead);
    arrowContainer.appendChild(svg);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É
    arrowContainer.style.opacity = '1';
    arrowContainer.style.transition = 'opacity 0.5s';

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è
    contactsTitle.classList.add('contacts-underline');

    // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø—Ä–æ—Ä–∏—Å–æ–≤–∫—É –ø—É—Ç–∏
    setTimeout(() => {
        path.style.transition = 'stroke-dashoffset 1.2s ease-in-out';
        path.style.strokeDashoffset = '0';
        setTimeout(() => {contactsTitle.classList.add('animate');}, 450)
    }, 100);

    // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ –≥–æ–ª–æ–≤–∫–∏ —Å—Ç—Ä–µ–ª–∫–∏ –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ
    setTimeout(() => {
        arrowHead.style.opacity = '1';
        arrowHead.style.transition = 'opacity 0.3s ease-in-out';
    }, 550);

    // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–µ–ª–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        arrowContainer.style.opacity = '0';
        contactsTitle.classList.remove('animate');

        setTimeout(() => {
            if (arrowContainer.parentNode) {
                arrowContainer.parentNode.removeChild(arrowContainer);
            }
            contactsTitle.classList.remove('contacts-underline');
        }, 500);
    }, 2000);
});

//–ö–Ω–æ–ø–∫–∏ –§—É—Ç–µ—Ä–∞ - –ö–æ–Ω–µ—Ü

let isReviewsLoading = false;

// –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤
    let reviews = [];
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
let editRating = 0;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const currentRestaurantId = '{{ place.slug }}';
        console.log('Current restaurant ID:', currentRestaurantId);
let selectedRating = 0;
let lastReviewTime = localStorage.getItem('lastReviewTime') || 0;
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∞–π–∫–∞–º–∏/–¥–∏–∑–ª–∞–π–∫–∞–º–∏
let currentReviewId = null;
let currentUserRating = null;
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
let pageReloaded = false;
let reviewCreationInProgress = false;

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –°–†–ê–ó–£ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
let userToken = localStorage.getItem('userToken') || generatePersistentUserToken();

let currentFilters = {
    rating: 0,
    reaction: 'none'
};

document.addEventListener('DOMContentLoaded', function() {
    trackPageReload(); // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É
    updateFavoritesCount(); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    initStats(); // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –æ—Ç–∑—ã–≤–æ–≤ –í–º–µ—Å—Ç–æ updateOverallRating()
    initFilters(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ß–ö–£!
    loadReviews(); // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤
    markExistingFavorites();
    initFavorites();
    setInterval(saveRatingsToStorage, 30000); // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)

    document.getElementById('full-review-modal').style.display = 'none';

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º/–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω
    userToken = localStorage.getItem('userToken') || generatePersistentUserToken();
    console.log('User token –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', userToken);
    console.log('DOM loaded, initializing favorites...');

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ localStorage
    localStorage.setItem('userToken', userToken);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞
    const reviewList = document.getElementById('review-list');
    if (reviewList) {
        reviewList.addEventListener('scroll', updateScrollButtons);
    }

    const tagsScroller = document.querySelector('.tags-scroller');
    if (tagsScroller) {
        tagsScroller.addEventListener('scroll', updateTagsScrollButtons);
        setTimeout(updateTagsScrollButtons, 100);
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω
    userToken = generateUserToken();
    console.log('User token:', userToken);


    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
    document.querySelectorAll('.js-favorite-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const itemId = this.dataset.itemId;
      const itemData = JSON.parse(this.dataset.item);
      toggleFavorite(itemId, itemData);
    });
    });

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
    window.addEventListener('storage', function(event) {
    if (event.key === 'favorites') {
      updateFavoritesCount();
    }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
    const headerFavBtn = document.getElementById('header-favorites-btn');
    const particles = headerFavBtn.querySelectorAll('.particle');

    // –ê–Ω–∏–º–∞—Ü–∏—è —á–∞—Å—Ç–∏—Ü
    headerFavBtn.addEventListener('mouseenter', function() {
    this.classList.add('active');
    });

    headerFavBtn.addEventListener('mouseleave', function() {
    this.classList.remove('active');
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
    const closeBtn = document.querySelector('#review-modal .close');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeReviewModal);
    }

    // –£–ë–ï–†–ò–¢–ï –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è review-form –∏ –æ—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç:
    const reviewForm = document.getElementById('review-form');
    if (reviewForm) {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        reviewForm.onsubmit = null;
        reviewForm.addEventListener('submit', function(e) {
            submitReview(e);
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const modal = document.getElementById('review-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeReviewModal();
            }
        });
    }

    const editForm = document.getElementById('edit-review-form');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            submitEditReview(e);
        });
    }

    const stars = document.querySelectorAll('#review-stars .star');
    stars.forEach(star => {
        star.addEventListener('click', () => {
            selectedRating = parseInt(star.getAttribute('data-value'));

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–≤–µ–∑–¥
            stars.forEach((s, index) => {
                const starValue = parseInt(s.getAttribute('data-value'));
                const starImage = starValue <= selectedRating ? PATHS.starActive : PATHS.starInactive;
                s.innerHTML = `<img src="${starImage}" alt="‚òÖ">`;
            });

            document.getElementById('rating-error').style.display = 'none';
        });
    });


    setTimeout(() => {updateScrollButtons();}, 500);
    setTimeout(updateScrollButtons, 1000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

    setTimeout(() => {
        updateScrollButtons();
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
        setTimeout(updateScrollButtons, 1000);
    }, 500);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setTimeout(() => {
        migrateLegacyReviews().then(success => {
            if (success) {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
                loadReviews();
            }
        });
    }, 2000);

    // –û—Å—Ç–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
});

// –¢–∞–∫–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–≥–¥–∞ –≤—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
window.addEventListener('load', function() {
    console.log('Window loaded, finalizing favorites initialization...');
    setTimeout(initFavorites, 100);
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–µ—Ä–∞ —Ç–µ–≥–æ–≤
function scrollTags(direction) {
    const scroller = document.querySelector('.tags-scroller');
    const scrollAmount = 200;

    if (direction === 'left') {
        scroller.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    } else {
        scroller.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }

    setTimeout(updateTagsScrollButtons, 150);
}

function updateTagsScrollButtons() {
    const scroller = document.querySelector('.tags-scroller');
    const leftBtn = document.querySelector('.tags-scroll-btn.left');
    const rightBtn = document.querySelector('.tags-scroll-btn.right');

    if (!scroller || !leftBtn || !rightBtn) return;

    const canScrollLeft = scroller.scrollLeft > 0;
    const canScrollRight = scroller.scrollLeft + scroller.clientWidth < scroller.scrollWidth - 1;

    leftBtn.classList.toggle('hidden', !canScrollLeft);
    rightBtn.classList.toggle('hidden', !canScrollRight);
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ —Å–∫—Ä–æ–ª–ª–∞
function initScrollButtons() {
    const reviewList = document.getElementById('review-list');
    const leftButton = document.querySelector('.scroll-button.left');
    const rightButton = document.querySelector('.scroll-button.right');

    if (!reviewList || !leftButton || !rightButton) {
        console.log('Scroll elements not found during init');
        return;
    }

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    leftButton.style.display = 'block';
    rightButton.style.display = 'block';

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
    setTimeout(() => {
        const hasContent = reviewList.children.length > 0;
        const canScroll = reviewList.scrollWidth > reviewList.clientWidth;

        console.log('Init scroll check:', {
            children: reviewList.children.length,
            scrollWidth: reviewList.scrollWidth,
            clientWidth: reviewList.clientWidth,
            canScroll: canScroll
        });

        if (hasContent && canScroll) {
            leftButton.style.display = 'block';
            rightButton.style.display = 'block';
            updateScrollButtons();
        } else {
            leftButton.style.display = 'none';
            rightButton.style.display = 'none';
        }
    }, 100);
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
function generateUserToken() {
    let token = localStorage.getItem('userToken');

    if (!token) {
        const deviceId = getDeviceFingerprint();
        const randomPart = Math.random().toString(36).substr(2, 8);
        const timestamp = Date.now().toString(36);
        token = `token-${deviceId}-${randomPart}-${timestamp}`;
        localStorage.setItem('userToken', token);
        console.log('üÜï –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π user token:', token);
    } else {
        console.log('üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π user token:', token);
    }

    return token;
}

function validateReviewForm() {
    const name = document.getElementById('name').value.trim();
    const rating = selectedRating;

    if (!name) {
        document.getElementById('name').style.borderColor = '#ff4444';
        return false;
    }

    if (rating === 0) {
        document.getElementById('rating-error').style.display = 'inline';
        return false;
    }

    return true;
}

// –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–æ–∫ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
function forceShowEditButtons() {
    const modal = document.getElementById('full-review-modal');
    if (!modal) return;

    const reviewId = modal.dataset.reviewId;
    const review = reviews.find(r => r.id == reviewId);
    if (!review) return;

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
    review.user_token = userToken;
    review.device_fingerprint = getDeviceFingerprint();

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–Ω–æ–ø–∫–∏
    addEditDeleteButtonsToModal(modal, review);
    console.log('–ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑–∞–Ω—ã');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
function trackPageReload() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞
    if (performance.navigation.type === 1 || performance.getEntriesByType("navigation")[0]?.type === 'reload') {
        console.log('üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—ã–ª–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        pageReloaded = true;

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º userToken –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        userToken = localStorage.getItem('userToken') || generatePersistentUserToken();
        console.log('üîÑ UserToken –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:', userToken);
    }
}

// üî• –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
function formatTimeUntilNextReview(restaurantId) {
    const timeUntilNext = getTimeUntilNextReview(restaurantId);

    if (!timeUntilNext) {
        return '—Å–ª–µ–¥—É—é—â–∏–π –æ—Ç–∑—ã–≤ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å';
    }

    const { hours, minutes } = timeUntilNext;

    if (hours > 0 && minutes > 0) {
        return `${hours}—á ${minutes}–º`;
    } else if (hours > 0) {
        return `${hours}—á`;
    } else if (minutes > 0) {
        return `${minutes}–º`;
    } else {
        return '–º–µ–Ω–µ–µ –º–∏–Ω—É—Ç—ã';
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞
function updateUserReviewLimit(restaurantId, action = 'add') {
    try {
        const reviewLimits = JSON.parse(localStorage.getItem('reviewLimits')) || {};

        console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞:', {
            action: action,
            restaurantId: restaurantId,
            currentUserToken: userToken,
            currentLimits: reviewLimits[userToken]
        });

        if (action === 'add') {
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–º–∏—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞
            reviewLimits[userToken] = {
                lastReviewDate: new Date().toISOString(),
                restaurantId: restaurantId
            };
            console.log('‚úÖ –õ–∏–º–∏—Ç –£–°–¢–ê–ù–û–í–õ–ï–ù –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:', restaurantId);
        } else if (action === 'remove') {
            // –£–¥–∞–ª—è–µ–º –ª–∏–º–∏—Ç –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞
            if (reviewLimits[userToken]) {
                console.log('üîç –ù–∞–π–¥–µ–Ω –ª–∏–º–∏—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:', reviewLimits[userToken]);
                if (reviewLimits[userToken].restaurantId === restaurantId) {
                    delete reviewLimits[userToken];
                    console.log('‚úÖ –õ–∏–º–∏—Ç –°–ù–Ø–¢ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:', restaurantId);
                } else {
                    console.log('‚ö†Ô∏è –õ–∏–º–∏—Ç –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:', reviewLimits[userToken].restaurantId);
                }
            } else {
                console.log('‚ö†Ô∏è –õ–∏–º–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }

        localStorage.setItem('reviewLimits', JSON.stringify(reviewLimits));
        console.log('üìä –¢–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', reviewLimits);

    } catch (error) {
        console.error('‚ùå Error updating review limit:', error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞ –æ—Ç–∑—ã–≤–æ–≤ (1 –≤ –¥–µ–Ω—å)
function canUserPostReview(restaurantId) {
    try {
        const reviewLimits = JSON.parse(localStorage.getItem('reviewLimits')) || {};
        const userLimit = reviewLimits[userToken];

        if (!userLimit) {
            console.log('‚úÖ –ù–µ—Ç –ª–∏–º–∏—Ç–æ–≤ - –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤');
            return true;
        }

        // üî• –ö–ª—é—á–µ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä—è–µ–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ—Ç –∂–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω
        if (userLimit.restaurantId === restaurantId) {
            const lastReviewDate = new Date(userLimit.lastReviewDate);
            const now = new Date();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ 24 —á–∞—Å–∞?
            const timeDiff = now - lastReviewDate;
            const hoursDiff = timeDiff / (1000 * 60 * 60);

            const canPost = hoursDiff >= 24;

            console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:', {
                restaurantId: restaurantId,
                lastReviewRestaurant: userLimit.restaurantId,
                hoursDiff: hoursDiff.toFixed(2),
                canPost: canPost
            });

            return canPost;
        }

        // üî• –ï—Å–ª–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω –î–†–£–ì–û–ô - —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ–≥–¥–∞!
        console.log('‚úÖ –î—Ä—É–≥–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω - –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤');
        return true;

    } catch (error) {
        console.error('Error checking review limit:', error);
        return true;
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–∑—ã–≤–∞
function getTimeUntilNextReview(restaurantId) {
    try {
        const reviewLimits = JSON.parse(localStorage.getItem('reviewLimits')) || {};
        const userLimit = reviewLimits[userToken];

        if (!userLimit || userLimit.restaurantId !== restaurantId) {
            return null;
        }

        const lastReviewDate = new Date(userLimit.lastReviewDate);
        const now = new Date();

        // üî• –í—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–∑—ã–≤–∞ = lastReviewDate + 24 —á–∞—Å–∞
        const nextReviewTime = new Date(lastReviewDate.getTime() + 24 * 60 * 60 * 1000);
        const timeDiff = nextReviewTime - now;

        if (timeDiff <= 0) {
            return null; // –í—Ä–µ–º—è –≤—ã—à–ª–æ
        }

        const hours = Math.floor(timeDiff / (1000 * 60 * 60));
        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));

        console.log('‚è∞ –í—Ä–µ–º—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–∑—ã–≤–∞:', {
            lastReview: lastReviewDate.toLocaleString(),
            nextReview: nextReviewTime.toLocaleString(),
            now: now.toLocaleString(),
            hours: hours,
            minutes: minutes
        });

        return { hours, minutes };

    } catch (error) {
        console.error('Error getting time until next review:', error);
        return null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;

    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease;
    `;

    if (type === 'error') {
        notification.style.backgroundColor = '#f44336';
    } else if (type === 'success') {
        notification.style.backgroundColor = '#4CAF50';
    } else {
        notification.style.backgroundColor = '#2196F3';
    }

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞
async function submitReview(e) {
    if (e) e.preventDefault();

    console.log('=== –ù–ê–ß–ê–õ–û –û–¢–ü–†–ê–í–ö–ò –û–¢–ó–´–í–ê ===');
    console.log('currentRestaurantId:', currentRestaurantId);
    console.log('userToken:', userToken);

    const payload = {
        restaurant_id: currentRestaurantId,
        username: document.getElementById('name').value.trim(),
        rating: selectedRating,
        comment: document.getElementById('comment').value.trim(),
        user_token: userToken,
        device_fingerprint: getDeviceFingerprint()
    };

    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', payload);

    // üî• –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ò–ú –ü–†–û–í–ï–†–ö–£ –õ–ò–ú–ò–¢–ê
    if (!canUserPostReview(currentRestaurantId)) {
        const timeUntilNext = getTimeUntilNextReview(currentRestaurantId);
        let message = '–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è. ';

        if (timeUntilNext) {
            const formattedTime = formatTimeUntilNextReview(currentRestaurantId);
            message += `–°–ª–µ–¥—É—é—â–∏–π –æ—Ç–∑—ã–≤ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ ${formattedTime}`;
        }

        showNotification(message, 'error');
        return false;
    }

    const name = document.getElementById('name').value.trim();
    const comment = document.getElementById('comment').value.trim();
    const deviceFingerprint = getDeviceFingerprint();

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    if (!name) {
        document.getElementById('name').style.borderColor = '#ff4444';
        return false;
    }

    if (selectedRating === 0) {
        document.getElementById('rating-error').style.display = 'inline';
        return false;
    }

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
    if (reviewCreationInProgress) {
        console.log('–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∑—ã–≤–∞');
        return false;
    }

    reviewCreationInProgress = true;
    const submitButton = document.querySelector('#review-form button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    submitButton.disabled = true;

    try {
        const payload = {
            restaurant_id: currentRestaurantId,
            username: name,
            rating: selectedRating,
            comment: comment,
            user_token: userToken,
            device_fingerprint: deviceFingerprint
        };

        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', payload);

        const response = await fetch('/api/reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (response.ok) {
        // üî• –û–ë–ù–û–í–õ–Ø–ï–ú –õ–ò–ú–ò–¢ –î–õ–Ø –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –†–ï–°–¢–û–†–ê–ù–ê
        updateUserReviewLimit(currentRestaurantId, 'add'); // üî• –î–û–ë–ê–í–õ–ï–ù –ü–ê–†–ê–ú–ï–¢–† 'add'

        console.log('‚úÖ –õ–∏–º–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω, –æ—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:', currentRestaurantId);
            // ‚úÖ –£—Å–ø–µ—Ö - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            if (data.review) {
                // üî• –û–ë–ù–û–í–õ–Ø–ï–ú –õ–ò–ú–ò–¢ –î–õ–Ø –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –†–ï–°–¢–û–†–ê–ù–ê
                updateUserReviewLimit(currentRestaurantId);

                console.log('‚úÖ –õ–∏–º–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω, –æ—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:', currentRestaurantId);

                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤ –≤ UI
                const existingIndex = reviews.findIndex(r => r.id === data.review.id);

                if (existingIndex === -1) {
                    reviews.unshift(data.review);
                } else {
                    reviews[existingIndex] = data.review;
                }

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã
                await loadReviews();

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                closeReviewModal();

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                resetReviewForm();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                setTimeout(() => {
                    initStats();
                }, 500);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showNotification('–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');

            } else {
                throw new Error('–û—Ç–∑—ã–≤ –Ω–µ –≤–µ—Ä–Ω—É–ª—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞');
            }
        } else {
            // ‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            if (data.error && data.error.includes('—É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤')) {
                // ‚ö° –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—á–∏—Å—Ç–∏–ª localStorage, –Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ—Ç–∑—ã–≤ –µ—Å—Ç—å
                updateUserReviewLimit(currentRestaurantId); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º localStorage
                showNotification(data.error, 'error');
            } else {
                throw new Error(data.error);
            }
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞', 'error');
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        reviewCreationInProgress = false;
        if (submitButton) {
            submitButton.textContent = originalText;
            submitButton.disabled = false;
        }
    }

    return false;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
function showLoadingIndicator() {
    let loader = document.getElementById('loading-indicator');
    if (!loader) {
        loader = document.createElement('div');
        loader.id = 'loading-indicator';
        loader.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 10000;
        `;
        loader.innerHTML = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
        document.body.appendChild(loader);
    }
    loader.style.display = 'block';
}

function hideLoadingIndicator() {
    const loader = document.getElementById('loading-indicator');
    if (loader) {
        loader.style.display = 'none';
    }
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ –≤ UI
function addReviewToUIImmediately(review) {
    console.log('=== –î–û–ë–ê–í–õ–ï–ù–ò–ï –û–¢–ó–´–í–ê –í UI ===');

    const reviewList = document.getElementById('review-list');
    if (!reviewList) {
        console.error('Review list not found');
        return;
    }

    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤"
    const noReviewsMsg = reviewList.querySelector('.no-reviews');
    if (noReviewsMsg) {
        noReviewsMsg.remove();
    }

    // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –ü–ï–†–í–´–ú
    const existingIndex = reviews.findIndex(r => r.id === review.id);
    if (existingIndex === -1) {
        reviews.unshift(review); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –º–∞—Å—Å–∏–≤–∞
    } else {
        reviews[existingIndex] = review;
    }

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –æ—Ç–∑—ã–≤–∞
    const reviewElement = createReviewElement(review);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    reviewElement.dataset.reviewId = review.id;
    reviewElement.dataset.rating = review.rating;
    reviewElement.dataset.likes = review.likes || 0;
    reviewElement.dataset.dislikes = review.dislikes || 0;

    // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM –≤ –Ω–∞—á–∞–ª–æ (–Ω–æ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤)
    if (reviewList.firstChild) {
        reviewList.insertBefore(reviewElement, reviewList.firstChild);
    } else {
        reviewList.appendChild(reviewElement);
    }

    // –ü–†–ò–ú–ï–ù–Ø–ï–ú –¢–ï–ö–£–©–ò–ï –§–ò–õ–¨–¢–†–´ –ö –ù–û–í–û–ú–£ –û–¢–ó–´–í–£
    applyFiltersToSingleReview(reviewElement, review);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    reviewElement.style.opacity = '0';
    reviewElement.style.transform = 'translateY(-20px)';

    setTimeout(() => {
        reviewElement.style.transition = 'all 0.3s ease';
        reviewElement.style.opacity = '1';
        reviewElement.style.transform = 'translateY(0)';
    }, 10);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä–æ–ª–ª-–∫–Ω–æ–ø–∫–∏
    setTimeout(updateScrollButtons, 100);
}

// –ù–û–í–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∫ –æ–¥–Ω–æ–º—É –æ—Ç–∑—ã–≤—É
function applyFiltersToSingleReview(reviewElement, review) {
    if (!reviewElement || !review) return;

    const cardRating = review.rating;
    const likes = parseInt(review.likes || 0);
    const dislikes = parseInt(review.dislikes || 0);

    const matchesRating = currentFilters.rating === 0 || cardRating === currentFilters.rating;
    const matchesReaction = checkReactionMatch(likes, dislikes);

    if (matchesRating && matchesReaction) {
        reviewElement.style.display = 'flex';
        console.log(`Review ${review.id} matches filters - showing`);
    } else {
        reviewElement.style.display = 'none';
        console.log(`Review ${review.id} doesn't match filters - hiding`);
    }
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∫ –Ω–æ–≤–æ–º—É –æ—Ç–∑—ã–≤—É
function applyFiltersToNewReview(reviewElement, review) {
    const cardRating = review.rating;
    const likes = parseInt(review.likes || 0);
    const dislikes = parseInt(review.dislikes || 0);

    const matchesRating = currentFilters.rating === 0 || cardRating === currentFilters.rating;
    const matchesReaction = checkReactionMatch(likes, dislikes);

    if (matchesRating && matchesReaction) {
        reviewElement.style.display = 'flex';
    } else {
        reviewElement.style.display = 'none';
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤
function displayReviews(reviewsData) {
    const reviewList = document.getElementById('review-list');
    if (!reviewList) return;

    reviewList.innerHTML = '';
    reviews = reviewsData || [];

    if (!reviewsData || reviewsData.length === 0) {
        reviewList.innerHTML = '<div class="no-reviews">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
        updateScrollButtons();
        return;
    }

    // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    reviewsData.forEach(review => {
        const reviewElement = createReviewElement(review);
        reviewList.appendChild(reviewElement);
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä–æ–ª–ª
    setTimeout(updateScrollButtons, 100);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateRatingStats(stats) {
    document.getElementById('overall-rating').textContent = stats.average_rating.toFixed(1);
    document.getElementById('total-reviews').textContent = stats.total_reviews;

    // –û–±–Ω–æ–≤–ª—è–µ–º —à–∫–∞–ª—ã —Ä–µ–π—Ç–∏–Ω–≥–∞
    for (let i = 1; i <= 5; i++) {
        const count = stats.ratings[i] || 0;
        const percentage = stats.total_reviews > 0 ? (count / stats.total_reviews) * 100 : 0;
        const bar = document.querySelector(`.rating-bar:nth-child(${6 - i}) .fill`);
        const countSpan = document.querySelector(`.rating-bar:nth-child(${6 - i}) span:last-child`);

        if (bar) bar.style.width = `${percentage}%`;
        if (countSpan) countSpan.textContent = count;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π UI –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function updateReviewsUI(reviews) {
    const reviewList = document.getElementById('review-list');
    reviewList.innerHTML = '';

    if (!reviews || reviews.length === 0) {
        reviewList.innerHTML = '<div class="no-reviews">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
        return;
    }

    reviews.forEach(review => {
        const canEdit = checkEditPermission(review);
        const reviewElement = createReviewElement(review, canEdit);
        reviewList.appendChild(reviewElement);
    });

    updateReviewVisibility();
}

function createReviewElement(review) {
    const reviewElement = document.createElement('div');
    reviewElement.className = 'review-card';
    reviewElement.dataset.reviewId = review.id || Date.now();
    reviewElement.dataset.rating = review.rating;
    reviewElement.dataset.likes = review.likes || 0;  // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–∞–π–∫–∏
    reviewElement.dataset.dislikes = review.dislikes || 0;  // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∏–∑–ª–∞–π–∫–∏

    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    const safeComment = review.comment ? review.comment.replace(/'/g, "&#39;").replace(/"/g, "&quot;") : '';
    const safeUsername = review.username ? review.username.replace(/'/g, "&#39;").replace(/"/g, "&quot;") : '';

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
    const reviewDate = review.created_at ?
        formatDate(review.created_at) :
        '–¢–æ–ª—å–∫–æ —á—Ç–æ';

    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∑–≤–µ–∑–¥ —Ä–µ–π—Ç–∏–Ω–≥–∞
    let starsHTML = '';
    for (let i = 0; i < 5; i++) {
        if (i < review.rating) {
            starsHTML += `<img src="${PATHS.starActive}" alt="‚òÖ" style="width:20px;height:20px;">`;
        } else {
            starsHTML += `<img src="${PATHS.starInactive}" alt="‚òÖ" style="width:20px;height:20px;">`;
        }
    }

    reviewElement.innerHTML = `
        <div class="review-header">
            <div class="date-avatar">
                <img class="avatar" src="${PATHS.avatar}" alt="–ê–≤–∞—Ç–∞—Ä">
                <div class="review-date-small">${reviewDate}</div>
            </div>
            <div class="name-rating">
                <div class="name">${safeUsername}</div>
                <div class="review-rating">
                    ${starsHTML}
                </div>
            </div>
        </div>
        <div class="comment-container">
            <div class="comment-text">${review.comment || ''}</div>
            <div class="comment-blur"></div>
        </div>
        ${review.comment ? `
            <div class="review-actions-bottom">
                <button class="expand-text-link" onclick="openFullReviewModal(${review.id || Date.now()})">
                    –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å
                </button>
            </div>
        ` : ''}
    `;

    return reviewElement;
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
async function checkEditPermission(review) {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Ç–æ–∫–µ–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –¢–û–õ–¨–ö–û –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        if (review.user_token !== userToken) {
            console.log('Edit denied: different user token');
            return false;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –æ—Ç–ø–µ—á–∞—Ç–∫—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        if (!isSameDevice(review)) {
            console.log('Edit denied: different device');
            return false;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è (3 —á–∞—Å–∞)
        const createdAt = new Date(review.created_at);
        const now = new Date();
        const hoursDiff = (now - createdAt) / (1000 * 60 * 60);

        if (hoursDiff > 3) {
            console.log('Edit denied: time expired', hoursDiff);
            return false;
        }

        console.log('Edit allowed');
        return true;
    } catch (error) {
        console.error('Error checking edit permission:', error);
        return false;
    }
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–≥–æ –∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
function isSameDevice(review) {
    try {
        // –ü–æ–ª—É—á–∞–µ–º fingerprint —Ç–µ–∫—É—â–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        const currentFingerprint = getDeviceFingerprint();

        // –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π fingerprint –Ω–∞ –æ—Å–Ω–æ–≤–µ userAgent –∏ –¥—Ä—É–≥–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const backupFingerprint = btoa(navigator.userAgent + navigator.language + screen.width);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
        const isSame = review.device_fingerprint === currentFingerprint ||
                      review.device_fingerprint === backupFingerprint;

        console.log('Device check:', {
            stored: review.device_fingerprint,
            current: currentFingerprint,
            backup: backupFingerprint,
            isSame: isSame
        });

        return isSame;
    } catch (error) {
        console.error('Error checking device:', error);
        return false;
    }
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–ø–µ—á–∞—Ç–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
function getDeviceFingerprint() {
    const components = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset(),
        navigator.hardwareConcurrency || 'unknown'
    ];

    // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ö—ç—à
    return btoa(components.join('|')).substring(0, 32);
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
function formatDate(dateString) {
    if (!dateString) return '<div>–¢–æ–ª—å–∫–æ —á—Ç–æ</div><div></div>';

    try {
        const date = new Date(dateString);
        const formattedDate = date.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'numeric',
            year: 'numeric'
        });
        const formattedTime = date.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
        });

        return `<div>${formattedDate}</div><div>${formattedTime}</div>`;
    } catch (e) {
        return '<div>–¢–æ–ª—å–∫–æ —á—Ç–æ</div><div></div>';
    }
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function openEditModal(reviewId, currentRating, currentComment) {
    const modal = document.getElementById('edit-modal');
    modal.dataset.reviewId = reviewId;

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
    const stars = modal.querySelectorAll('.star');
    stars.forEach((star, index) => {
        star.innerHTML = `<img src="${index < currentRating ? PATHS.starActive : PATHS.starInactive}" alt="‚òÖ">`;
    });

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    modal.querySelector('#edit-comment').value = currentComment || '';

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modal.style.display = 'flex';
}

// –£–°–ò–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞
async function deleteReview(reviewId) {
    try {
        console.log(`=== –ü–û–ü–´–¢–ö–ê –£–î–ê–õ–ï–ù–ò–Ø –û–¢–ó–´–í–ê ${reviewId} ===`);

        const review = reviews.find(r => r.id == reviewId);
        if (!review) {
            console.log('‚ùå –û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –º–∞—Å—Å–∏–≤–µ');
            return;
        }

        console.log('üìã –î–∞–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤–∞:', {
            id: review.id,
            restaurant_id: review.restaurant_id,
            user_token: review.user_token
        });

        // –î–í–û–ô–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä
        if (!checkIsAuthor(review)) {
            console.log('‚ùå Permission denied: user is not author');
            return;
        }

        const response = await fetch(`/api/reviews/${reviewId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_token: userToken,
                device_fingerprint: getDeviceFingerprint()
            })
        });

        const data = await response.json();
        console.log('üì® –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);

        if (response.ok) {
            // üî• –í–ê–ñ–ù–û: –°–ù–ò–ú–ê–ï–ú –õ–ò–ú–ò–¢ –ü–ï–†–ï–î –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π –æ—Ç–∑—ã–≤–æ–≤
            console.log('üîÑ –°–Ω–∏–º–∞–µ–º –ª–∏–º–∏—Ç –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:', review.restaurant_id);
            updateUserReviewLimit(review.restaurant_id, 'remove'); // üî• –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ 'remove'

            // üî• –ü–†–û–í–ï–†–Ø–ï–ú –°–†–ê–ó–£ –ü–û–°–õ–ï –£–î–ê–õ–ï–ù–ò–Ø
            setTimeout(() => {
                console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è...');
                const canPostNow = canUserPostReview(currentRestaurantId);
                console.log('‚úÖ –ú–æ–∂–Ω–æ –ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è?', canPostNow);

                if (!canPostNow) {
                    console.log('‚ö†Ô∏è –õ–∏–º–∏—Ç –Ω–µ —Å–Ω—è–ª—Å—è! –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–º–∞–µ–º...');
                    forceRemoveLimit(currentRestaurantId);
                }
            }, 100);

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            closeFullReviewModal();
            const confirmModal = document.getElementById('delete-confirmation-modal');
            if (confirmModal) {
                document.body.removeChild(confirmModal);
            }

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã
            setTimeout(() => {
                console.log('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è...');
                loadReviews();
                initStats();
            }, 500);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('–û—Ç–∑—ã–≤ —É–¥–∞–ª–µ–Ω. –í—ã –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –æ—Ç–∑—ã–≤.', 'success');

        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        }
    } catch (error) {
        console.error('‚ùå Error deleting review:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞', 'error');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    loadReviews();
    updateOverallRating();

    const stars = document.querySelectorAll('#review-stars .star');
    stars.forEach(star => {
        star.addEventListener('click', () => {
            selectedRating = parseInt(star.getAttribute('data-value'));
            stars.forEach((s, index) => {
                s.innerHTML = `<img src="${index < selectedRating ? PATHS.starActive : PATHS.starInactive}" alt="‚òÖ">`;
            });
        });
    });
});

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞
function generateEnhancedUserToken() {
    // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–∞—É–∑–µ—Ä–µ (–∞–Ω–æ–Ω–∏–º–Ω–æ)
    const browserInfo = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        screen: `${screen.width}x${screen.height}`
    };

    // –°–æ–∑–¥–∞–µ–º —Ö—ç—à –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    const browserHash = btoa(JSON.stringify(browserInfo)).substr(0, 12);

    const token = `token-${browserHash}-${Math.random().toString(36).substr(2, 6)}-${Date.now().toString(36)}`;

    localStorage.setItem('userToken', token);
    return token;
}















// –í —Ñ—É–Ω–∫—Ü–∏–∏ flipCard() –¥–ª—è –∫–∞—Ä—Ç—ã –∑–∞–≤–µ–¥–µ–Ω–∏—è
function initRestaurantMap() {
    if (typeof ymaps !== 'undefined') {
        ymaps.ready(function() {
            var map = new ymaps.Map('yandex-map', {
                center: [{{ place.latitude }}, {{ place.longitude }}],
                zoom: 16,
                controls: ['zoomControl', 'fullscreenControl']
            });

            // –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∏–∫–æ–Ω–∫—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
            var restaurantPlacemark = new ymaps.Placemark(
                [{{ place.latitude }}, {{ place.longitude }}],
                {
                    hintContent: '{{ place.title }}',
                    balloonContent: `
                        <div style="max-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">{{ place.title }}</h3>
                            <p style="margin: 5px 0; font-size: 14px;">üìç {{ place.address }}</p>
                            <p style="margin: 5px 0; font-size: 14px;">üìû {{ place.telephone }}</p>
                        </div>
                    `
                },
                {
                    // –ò–∫–æ–Ω–∫–∞ –µ–¥—ã (–ª–æ–∂–∫–∞ –∏ –≤–∏–ª–∫–∞)
                    preset: 'islands#blueFoodIcon',
                    iconColor: '#ff6b6b', // –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
                    balloonCloseButton: true
                }
            );

            map.geoObjects.add(restaurantPlacemark);
        });
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
function initFilters() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–≤–µ–∑–¥
    const filterStars = document.querySelectorAll('#filter-stars .star');
    filterStars.forEach(star => {
        star.addEventListener('click', function() {
            const value = parseInt(this.getAttribute('data-value'));

            // –ï—Å–ª–∏ –∫–ª–∏–∫–∞–µ–º –Ω–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–≤–µ–∑–¥—É - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
            if (currentFilters.rating === value) {
                currentFilters.rating = 0;
                resetStarFilter();
            } else {
                currentFilters.rating = value;
                highlightStars(value);
            }

            applyFilters();
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–∞–∫—Ü–∏–π
    const filterButtons = document.querySelectorAll('.filter-btn[data-type]');
    filterButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const filterType = this.getAttribute('data-type');

            // –ï—Å–ª–∏ –∫–ª–∏–∫–∞–µ–º –Ω–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
            if (currentFilters.reaction === filterType) {
                currentFilters.reaction = 'none';
                resetReactionFilter();
            } else {
                currentFilters.reaction = filterType;
                highlightReactionButton(filterType);
            }

            applyFilters();
        });
    });

    resetScroll();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
function resetAllFilters() {
    currentFilters = {
        rating: 0,
        reaction: 'none'
    };

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–≤–µ–∑–¥—ã
    const filterStars = document.querySelectorAll('#filter-stars .star');
    filterStars.forEach(star => {
        star.innerHTML = `<img src="${PATHS.starInactive}" alt="‚òÖ">`;
    });

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–∞–∫—Ü–∏–π
    const filterButtons = document.querySelectorAll('.filter-btn[data-type]');
    filterButtons.forEach(btn => {
        btn.classList.remove('active');
    });

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã (–ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ –æ—Ç–∑—ã–≤—ã)
    applyFilters();

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª
    resetScroll();
}

function updateFilterButtons() {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–∞–∫—Ü–∏–π
    const filterButtons = document.querySelectorAll('.filter-btn[data-type]');
    filterButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-type') === currentFilters.reaction) {
            btn.classList.add('active');
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–≤–µ–∑–¥—ã —Ñ–∏–ª—å—Ç—Ä–∞
    const filterStars = document.querySelectorAll('#filter-stars .star');
    filterStars.forEach((star, index) => {
        const starValue = index + 1;
        const starImage = starValue <= currentFilters.rating ? PATHS.starActive : PATHS.starInactive;
        star.innerHTML = `<img src="${starImage}" alt="‚òÖ">`;
    });
}

// –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
function applyFilters() {
    const reviewList = document.getElementById('review-list');
    if (!reviewList) return;

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤"
    const oldMsg = document.getElementById('no-reviews-message');
    if (oldMsg) oldMsg.remove();

    let hasMatches = false;

    // –í–ê–ñ–ù–û: –ü–æ–ª—É—á–∞–µ–º –í–°–ï –æ—Ç–∑—ã–≤—ã –∏–∑ DOM (–Ω–µ —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ)
    const allReviewCards = Array.from(reviewList.querySelectorAll('.review-card'));

    // –í–ê–ñ–ù–û: –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç–∑—ã–≤—ã –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ –∏ –≤ –º–∞—Å—Å–∏–≤–µ reviews
    allReviewCards.sort((a, b) => {
        const aId = parseInt(a.dataset.reviewId);
        const bId = parseInt(b.dataset.reviewId);
        const aIndex = reviews.findIndex(r => r.id === aId);
        const bIndex = reviews.findIndex(r => r.id === bId);
        return aIndex - bIndex; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
    });

    // –ü–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    allReviewCards.forEach(card => {
        reviewList.appendChild(card);
    });

    // –¢–µ–ø–µ—Ä—å –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    allReviewCards.forEach(card => {
        const reviewId = card.dataset.reviewId;
        const review = reviews.find(r => r.id == reviewId);

        if (review) {
            const cardRating = review.rating;
            const likes = parseInt(review.likes || 0);
            const dislikes = parseInt(review.dislikes || 0);

            const matchesRating = currentFilters.rating === 0 || cardRating === currentFilters.rating;
            const matchesReaction = checkReactionMatch(likes, dislikes);

            if (matchesRating && matchesReaction) {
                card.style.display = 'flex';
                hasMatches = true;
            } else {
                card.style.display = 'none';
            }
        }
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    if (!hasMatches) {
        showNoReviewsMessage();
    }

    // –í–ê–ñ–ù–û: –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä–µ–∞–∫—Ü–∏—è–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
    if (currentFilters.reaction !== 'none' && hasMatches) {
        sortReviewsByReaction();
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä–æ–ª–ª –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    setTimeout(updateScrollButtons, 150);
}

function resetScroll() {
    const reviewList = document.getElementById('review-list');
    if (reviewList) {
        reviewList.scrollLeft = 0;
        setTimeout(updateScrollButtons, 150);
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ñ–∏–ª—å—Ç—Ä—É —Ä–µ–∞–∫—Ü–∏–π
function checkReactionMatch(likes, dislikes) {
    switch (currentFilters.reaction) {
        case 'likes':
            return likes > 0;
        case 'dislikes':
            return dislikes > 0;
        case 'none':
        default:
            return true;
    }
}

// –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–≤–µ–∑–¥ —Ñ–∏–ª—å—Ç—Ä–∞
function highlightStars(rating) {
    const filterStars = document.querySelectorAll('#filter-stars .star');
    filterStars.forEach((star, index) => {
        const starValue = index + 1;
        const starImage = starValue <= rating ? PATHS.starActive : PATHS.starInactive;
        star.innerHTML = `<img src="${starImage}" alt="‚òÖ">`;
    });
}

// –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ —Ä–µ–∞–∫—Ü–∏–∏
function highlightReactionButton(filterType) {
    const filterButtons = document.querySelectorAll('.filter-btn[data-type]');
    filterButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-type') === filterType) {
            btn.classList.add('active');
        }
    });
}

// –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞ –∑–≤–µ–∑–¥
function resetStarFilter() {
    const filterStars = document.querySelectorAll('#filter-stars .star');
    filterStars.forEach(star => {
        star.innerHTML = `<img src="${PATHS.starInactive}" alt="‚òÖ">`;
    });
}

// –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞ —Ä–µ–∞–∫—Ü–∏–π
function resetReactionFilter() {
    const filterButtons = document.querySelectorAll('.filter-btn[data-type]');
    filterButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-type') === 'none') {
            btn.classList.add('active');
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –æ—Ç–∑—ã–≤–æ–≤
function sortReviews(reviewsArray) {
    if (currentFilter.reaction === 'likes') {
        reviewsArray.sort((a, b) => b.likes - a.likes);
    } else if (currentFilter.reaction === 'dislikes') {
        reviewsArray.sort((a, b) => b.dislikes - a.dislikes);
    }
}

// –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—Ç–∑—ã–≤–æ–≤
function showNoReviewsMessage() {
    const reviewList = document.getElementById('review-list');

    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—â–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
    if (reviewList.querySelector('#no-reviews-message')) {
        return;
    }

    const msg = document.createElement('div');
    msg.id = 'no-reviews-message';

    let messageText = '–û—Ç–∑—ã–≤–æ–≤ –Ω–µ—Ç';
    if (currentFilters.rating !== 0) {
        messageText += ` —Å ${currentFilters.rating} –∑–≤–µ–∑–¥–∞–º–∏`;
    }
    if (currentFilters.reaction !== 'none') {
        messageText += currentFilters.rating !== 0 ? ' –∏' : ' —Å';
        messageText += currentFilters.reaction === 'likes' ? ' –ª–∞–π–∫–∞–º–∏' : ' –¥–∏–∑–ª–∞–π–∫–∞–º–∏';
    }

    msg.textContent = messageText + '!';
    msg.style.textAlign = 'center';
    msg.style.padding = '20px';
    msg.style.color = '#666';
    msg.style.width = '100%';

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–æ –ù–ï –æ—á–∏—â–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫!
    reviewList.appendChild(msg);

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Å–∫—Ä–æ–ª–ª–∞
    updateScrollButtons();
}

// –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
function resetOppositeFilter() {
    // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–≤–µ–∑–¥ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∞–∫—Ü–∏–∏
    if (currentFilter.rating !== 0 && currentFilter.reaction !== 'none') {
        currentFilter.reaction = 'none';
        const filterButtons = document.querySelectorAll('.filter-btn[data-type]');
        filterButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-type') === 'none') {
                btn.classList.add('active');
            }
        });
    }

    // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–µ–∞–∫—Ü–∏–π —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–≤–µ–∑–¥—ã
    if (currentFilter.reaction !== 'none' && currentFilter.rating !== 0) {
        currentFilter.rating = 0;
        const filterStars = document.querySelectorAll('#filter-stars .star');
        filterStars.forEach(star => {
            star.innerHTML = `<img src="${PATHS.starInactive}" alt="‚òÖ">`;
        });
    }
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —Ä–µ–∞–∫—Ü–∏—è–º
function sortReviewsByReaction() {
    const reviewList = document.getElementById('review-list');
    const visibleReviews = Array.from(reviewList.querySelectorAll('.review-card'))
        .filter(card => card.style.display !== 'none');

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ –æ—Ç–∑—ã–≤—ã
    visibleReviews.sort((a, b) => {
        const aLikes = parseInt(a.dataset.likes || 0);
        const bLikes = parseInt(b.dataset.likes || 0);
        const aDislikes = parseInt(a.dataset.dislikes || 0);
        const bDislikes = parseInt(b.dataset.dislikes || 0);

        if (currentFilters.reaction === 'likes') {
            return bLikes - aLikes; // –ü–æ —É–±—ã–≤–∞–Ω–∏—é –ª–∞–π–∫–æ–≤
        } else if (currentFilters.reaction === 'dislikes') {
            return bDislikes - aDislikes; // –ü–æ —É–±—ã–≤–∞–Ω–∏—é –¥–∏–∑–ª–∞–π–∫–æ–≤
        }
        return 0;
    });

    // –ü–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    visibleReviews.forEach(review => {
        reviewList.appendChild(review);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ –º–∞—Å—Å–∏–≤—É reviews
function refreshReviewsOrder() {
    const reviewList = document.getElementById('review-list');
    if (!reviewList) return;

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç–∑—ã–≤–æ–≤
    const allCards = Array.from(reviewList.querySelectorAll('.review-card'));

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ –∏ –≤ –º–∞—Å—Å–∏–≤–µ reviews
    allCards.sort((a, b) => {
        const aId = parseInt(a.dataset.reviewId);
        const bId = parseInt(b.dataset.reviewId);
        const aIndex = reviews.findIndex(r => r.id === aId);
        const bIndex = reviews.findIndex(r => r.id === bId);
        return aIndex - bIndex;
    });

    // –ü–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    allCards.forEach(card => {
        reviewList.appendChild(card);
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä–æ–ª–ª
    setTimeout(updateScrollButtons, 100);
}



// ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====
const STORAGE_KEY = 'restaurant_reviews_ratings';

// ===== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò =====

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ü–µ–Ω–æ–∫ –≤ LocalStorage
function saveRatingsToStorage() {
    const ratingsData = {
        version: '2.0', // –û–±–Ω–æ–≤–∏–ª–∏ –≤–µ—Ä—Å–∏—é
        timestamp: new Date().toISOString(),
        ratings: reviews.reduce((acc, review) => {
            if (review.id) {
                acc[review.id] = {
                    likes: review.likes || 0,
                    dislikes: review.dislikes || 0,
                    user_ratings: review.user_ratings || {} // –•—Ä–∞–Ω–∏–º –æ—Ü–µ–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                };
            }
            return acc;
        }, {})
    };

    localStorage.setItem(STORAGE_KEY, JSON.stringify(ratingsData));
    console.log('Ratings saved to localStorage');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ü–µ–Ω–æ–∫ –∏–∑ LocalStorage
function loadRatingsFromStorage() {
    try {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (!storedData) return {};

        const data = JSON.parse(storedData);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é
        if (data.version === '2.0') {
            return data.ratings || {};
        }
    } catch (error) {
        console.error('Error loading ratings from storage:', error);
    }
    return {};
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫
function applyStoredRatings() {
    const storedRatings = loadRatingsFromStorage();

    reviews.forEach(review => {
        if (review.id && storedRatings[review.id]) {
            const stored = storedRatings[review.id];
            review.likes = stored.likes;
            review.dislikes = stored.dislikes;
            review.user_ratings = stored.user_ratings || {};
        }
    });

    console.log('Stored ratings applied');
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
function updateReviewUI(reviewId, likes, dislikes, userRating) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = document.getElementById('full-review-modal');
    if (modal && modal.dataset.reviewId == reviewId) {
        updateModalRatingUI(likes, dislikes, userRating);
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –æ—Ç–∑—ã–≤–∞ –≤ —Å–ø–∏—Å–∫–µ
    const reviewElement = document.querySelector(`.review-card[data-review-id="${reviewId}"]`);
    if (reviewElement) {
        reviewElement.dataset.likes = likes || 0;
        reviewElement.dataset.dislikes = dislikes || 0;
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
function updateModalRatingUI(likes, dislikes, userRating) {
    const likeCountElem = document.querySelector('#full-review-modal .like-count');
    const dislikeCountElem = document.querySelector('#full-review-modal .dislike-count');
    const likeBtn = document.querySelector('#full-review-modal .like-btn');
    const dislikeBtn = document.querySelector('#full-review-modal .dislike-btn');

    if (likeCountElem) likeCountElem.textContent = likes || 0;
    if (dislikeCountElem) dislikeCountElem.textContent = dislikes || 0;

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    if (likeBtn) likeBtn.classList.remove('active');
    if (dislikeBtn) dislikeBtn.classList.remove('active');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (userRating === 'like' && likeBtn) {
        likeBtn.classList.add('active');
    } else if (userRating === 'dislike' && dislikeBtn) {
        dislikeBtn.classList.add('active');
    }

    console.log('UI –æ–±–Ω–æ–≤–ª–µ–Ω:', { likes, dislikes, userRating });
}

// ===== –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø rateReview =====
// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ü–µ–Ω–∫–∏ –æ—Ç–∑—ã–≤–∞
async function rateReview(isLike, reviewId) {
    try {
        console.log(`=== –û–¶–ï–ù–ö–ê –û–¢–ó–´–í–ê ===`);
        console.log(`reviewId=${reviewId}, isLike=${isLike}`);

        const review = reviews.find(r => r.id == reviewId);
        if (!review) return;

        const currentUserRating = getUserRating(reviewId);
        let action = isLike ? 'like' : 'dislike';

        console.log(`–û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ: ${action}`);

        const response = await fetch(`/api/reviews/${reviewId}/rate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action, user_token: userToken })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }

        const data = await response.json();
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤–∞
        updateReviewData(reviewId, data);

        // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
            updateReviewUI(reviewId, data.likes, data.dislikes, data.user_rating);
        }, 600);

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ –æ—Ç–∑—ã–≤–∞:', error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –æ—Ü–µ–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function getUserRating(reviewId) {
    const review = reviews.find(r => r.id == reviewId);
    if (!review || !review.user_ratings) return null;
    const rating = review.user_ratings[userToken] || null;
    console.log(`getUserRating: ${rating} –¥–ª—è –æ—Ç–∑—ã–≤–∞ ${reviewId}`);
    return rating;
}

// –ü–†–û–°–¢–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç–∑—ã–≤–∞
function updateReviewData(reviewId, serverData) {
    const reviewIndex = reviews.findIndex(r => r.id == reviewId);

    if (reviewIndex !== -1) {
        console.log(`=== –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–¢–ó–´–í–ê ${reviewId} ===`);

        // –ü–†–û–°–¢–û –∑–∞–º–µ–Ω—è–µ–º –æ–±—ä–µ–∫—Ç –æ—Ç–∑—ã–≤–∞
        reviews[reviewIndex] = {
            ...reviews[reviewIndex],
            ...serverData
        };

        console.log('–û—Ç–∑—ã–≤ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –º–∞—Å—Å–∏–≤–µ:', {
            user_token: reviews[reviewIndex].user_token,
            isAuthor: checkIsAuthor(reviews[reviewIndex])
        });

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        saveRatingsToStorage();

        console.log('=== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û ===');
    } else {
        console.warn(`–û—Ç–∑—ã–≤ ${reviewId} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –º–∞—Å—Å–∏–≤–µ`);
    }
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
function validateRatingAction(isLike, currentUserRating) {
    if (isLike) {
        if (currentUserRating === 'like') {
            return 'remove_like';
        } else if (currentUserRating === 'dislike') {
            return 'like'; // –ú–µ–Ω—è–µ–º –¥–∏–∑–ª–∞–π–∫ –Ω–∞ –ª–∞–π–∫
        } else {
            return 'like'; // –°—Ç–∞–≤–∏–º –Ω–æ–≤—ã–π –ª–∞–π–∫
        }
    } else {
        if (currentUserRating === 'dislike') {
            return 'remove_dislike';
        } else if (currentUserRating === 'like') {
            return 'dislike'; // –ú–µ–Ω—è–µ–º –ª–∞–π–∫ –Ω–∞ –¥–∏–∑–ª–∞–π–∫
        } else {
            return 'dislike'; // –°—Ç–∞–≤–∏–º –Ω–æ–≤—ã–π –¥–∏–∑–ª–∞–π–∫
        }
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function getRatingActionText(newRating, oldRating) {
    if (!oldRating) return '–ø–æ—Å—Ç–∞–≤–ª–µ–Ω';
    if (oldRating !== newRating) return '–∏–∑–º–µ–Ω–µ–Ω';
    return '—Å–Ω—è—Ç';
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—Ü–µ–Ω–∫–µ
function showRatingNotification(newRating, previousRating) {
    if (newRating === null) {
    } else if (previousRating && previousRating !== newRating) {
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞
async function testServerResponse() {
    try {
        const testData = {
            restaurant_id: 'lambs',
            username: 'test',
            rating: 5,
            comment: 'test',
            user_token: 'test_token_123',
            device_fingerprint: 'test_fingerprint_123'
        };

        console.log('=== –¢–ï–°–¢ –°–ï–†–í–ï–†–ê ===');
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º:', testData);

        const response = await fetch('/api/reviews', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testData)
        });

        const data = await response.json();
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);

        if (response.ok) {
            console.log('‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
            console.log('user_token –≤ –æ—Ç–≤–µ—Ç–µ:', data.review?.user_token);
            console.log('device_fingerprint –≤ –æ—Ç–≤–µ—Ç–µ:', data.review?.device_fingerprint);
        } else {
            console.log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', data);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞:', error);
    }
}

// –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
const style = document.createElement('style');
style.textContent = `
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–Ω–æ–ø–æ–∫ */
    .like-btn.highlight {
        color: #00a820;
        border: 2px solid #4CAF50;
        animation: likePulse 0.5s ease;
    }

    .dislike-btn.highlight {
        color: #ff0000;
        border: 2px solid #f44336;
        animation: dislikePulse 0.5s ease;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –¥–ª—è –ª–∞–π–∫–∞ */
    @keyframes likePulse {
        0% {
            color: #00a820;
            transform: scale(1);
        }
        50% {
            color: #00a820;
            transform: scale(1.1);
        }
        100% {
            color: #00a820;
            transform: scale(1);
        }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –¥–ª—è –¥–∏–∑–ª–∞–π–∫–∞ */
    @keyframes dislikePulse {
        0% {
            color: red;
            transform: scale(1);
        }
        50% {
            color: red;
            transform: scale(1.1);
        }
        100% {
            color: red;
            transform: scale(1);
        }
    }

    /* –ò–∫–æ–Ω–∫–∏ –ø—Ä–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–µ */
    .like-btn.highlight img {
        filter: none; /* –£–±–∏—Ä–∞–µ–º –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ */
        /* –î–µ–ª–∞–µ–º –∏–∫–æ–Ω–∫—É –∑–µ–ª–µ–Ω–æ–π —á–µ—Ä–µ–∑ —Ñ–∏–ª—å—Ç—Ä */
        filter: brightness(0) saturate(100%) invert(48%) sepia(90%) saturate(1300%) hue-rotate(80deg) brightness(95%) contrast(105%);
    }

    .dislike-btn.highlight img {
        filter: none; /* –£–±–∏—Ä–∞–µ–º –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ */
        /* –î–µ–ª–∞–µ–º –∏–∫–æ–Ω–∫—É –∫—Ä–∞—Å–Ω–æ–π —á–µ—Ä–µ–∑ —Ñ–∏–ª—å—Ç—Ä */
        filter: brightness(0) saturate(100%) invert(27%) sepia(85%) saturate(7400%) hue-rotate(355deg) brightness(95%) contrast(120%);
    }

    /* –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ) */
    .like-btn.active {
        background-color: #4CAF50;
        color: black;
        border: 2px solid #4CAF50;
    }

    .dislike-btn.active {
        background-color: #f44336;
        color: black;
        border: 2px solid #f44336;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã –æ—Ü–µ–Ω–∫–∏ */
    @keyframes cancelPulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(0.9);
            opacity: 0.7;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .like-btn.cancel, .dislike-btn.cancel {
        animation: cancelPulse 0.5s;
    }

    /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ–±–≤–æ–¥–∫—É —É –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
    .like-btn:focus,
    .dislike-btn:focus,
    .like-btn:active,
    .dislike-btn:active {
        outline: none;
        box-shadow: none;
        border-color: transparent;
    }
`;
document.head.appendChild(style);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –æ—Ç–∑—ã–≤–µ
function debugReviewInfo(reviewId) {
    const review = reviews.find(r => r.id == reviewId);
    if (!review) {
        console.log('Review not found');
        return;
    }

    console.log('=== REVIEW DEBUG INFO ===');
    console.log('Review ID:', review.id);
    console.log('User token in review:', review.user_token);
    console.log('Current user token:', userToken);
    console.log('Is same user:', review.user_token === userToken);
    console.log('Device fingerprint:', review.device_fingerprint);
    console.log('Current device fingerprint:', getDeviceFingerprint());
    console.log('Is same device:', isSameDevice(review));
    console.log('Created at:', review.created_at);
    console.log('Time difference (hours):', getTimeDifferenceHours(review.created_at));
    console.log('Can edit:', checkEditPermissionSync(review));
    console.log('Can delete:', checkDeletePermissionSync(review));
    console.log('=========================');
}

// –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏
function addRating(review, isLike) {
    if (isLike) {
        review.likes = (review.likes || 0) + 1;
    } else {
        review.dislikes = (review.dislikes || 0) + 1;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏
async function removeRating(reviewId) {
    try {
        console.log(`Removing rating for review ${reviewId}`);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç–µ–∫—É—â–µ–π –æ—Ü–µ–Ω–∫–∏ –¥–ª—è —Å–Ω—è—Ç–∏—è
        const isLike = currentUserRating === 'like';

        const response = await fetch(`/api/reviews/${reviewId}/rate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                is_like: isLike, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –æ—Ü–µ–Ω–∫–∏ –¥–ª—è —Å–Ω—è—Ç–∏—è
                user_token: userToken
            })
        });

        if (response.ok) {
            const data = await response.json();
            console.log('Server response:', data);

            updateReviewData(reviewId, data);

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –æ—Ü–µ–Ω–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentUserRating = data.user_rating;
            updateLikeDislikeButtons();

        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
    } catch (error) {
        console.error('Error removing rating:', error);
        throw error;
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
function updateRatingUI(reviewId, likes, dislikes) {
    const modal = document.getElementById('full-review-modal');
    if (modal && modal.dataset.reviewId == reviewId) {
        const likeCountElem = modal.querySelector('.like-count');
        const dislikeCountElem = modal.querySelector('.dislike-count');

        if (likeCountElem) likeCountElem.textContent = likes || 0;
        if (dislikeCountElem) dislikeCountElem.textContent = dislikes || 0;
    }

    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –æ—Ç–∑—ã–≤–∞ –≤ —Å–ø–∏—Å–∫–µ
    const reviewElement = document.querySelector(`.review-card[data-review-id="${reviewId}"]`);
    if (reviewElement) {
        reviewElement.dataset.likes = likes || 0;
        reviewElement.dataset.dislikes = dislikes || 0;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –æ—Ü–µ–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function resetUserRating(reviewId) {
    const review = reviews.find(r => r.id == reviewId);
    if (!review || !review.user_ratings) return;

    const userRating = review.user_ratings[userToken];
    if (!userRating) return;

    // –£–¥–∞–ª—è–µ–º –æ—Ü–µ–Ω–∫—É
    if (userRating === 'like') {
        review.likes = Math.max(0, (review.likes || 0) - 1);
    } else {
        review.dislikes = Math.max(0, (review.dislikes || 0) - 1);
    }

    // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –æ—Ü–µ–Ω–∫–µ
    delete review.user_ratings[userToken];

    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    updateRatingUI(reviewId, review.likes, review.dislikes);
    saveRatingsToStorage();

}

// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
// –í—ã–∑–æ–≤–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤
async function loadReviews() {
    if (isReviewsLoading) {
        console.log('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...');
        return;
    }

    isReviewsLoading = true;

    try {
        console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –æ—Ç–∑—ã–≤–æ–≤...');
        const response = await fetch(`/api/reviews?restaurant_id=${currentRestaurantId}&_=${Date.now()}`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const reviewsData = await response.json();
        console.log('‚úÖ –û—Ç–∑—ã–≤—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', reviewsData.length);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
        reviews = reviewsData;

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã
        displayReviews(reviews);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        initStats();

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤', 'error');
    } finally {
        isReviewsLoading = false;
    }
}

// –ü–†–û–°–¢–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä—Å—Ç–≤–∞
function checkIsAuthor(review) {
    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: user_token –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å
    const isAuthor = review.user_token === userToken;

    console.log('Author check:', {
        reviewToken: review.user_token,
        currentToken: userToken,
        isAuthor: isAuthor,
        reviewId: review.id
    });

    return isAuthor;
}

async function migrateMyLegacyReviews() {
    try {
        console.log('=== MIGRATING MY LEGACY REVIEWS ===');

        // –ù–∞—Ö–æ–¥–∏–º legacy –æ—Ç–∑—ã–≤—ã —Å –Ω–∞—à–∏–º username
        const myLegacyReviews = reviews.filter(review =>
            review.user_token &&
            review.user_token.startsWith('legacy_token_') &&
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–≤–æ–∏—Ö –æ—Ç–∑—ã–≤–æ–≤
            // –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ IP –∏–ª–∏ –¥—Ä—É–≥–∏–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º
            review.username === getCurrentUsername() // –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –µ—Å—Ç—å —Ç–∞–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        );

        if (myLegacyReviews.length === 0) {
            console.log('No my legacy reviews found');
            return;
        }

        console.log(`Found ${myLegacyReviews.length} of my legacy reviews to migrate`);

        for (const review of myLegacyReviews) {
            console.log(`Migrating my review ${review.id}: ${review.user_token} -> ${userToken}`);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏
            const response = await fetch(`/api/reviews/${review.id}/migrate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_token: userToken,
                    device_fingerprint: getDeviceFingerprint()
                })
            });

            if (response.ok) {
                const data = await response.json();
                console.log(`Review ${review.id} migrated successfully`);

                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                review.user_token = userToken;
                review.device_fingerprint = getDeviceFingerprint();
            } else {
                console.error(`Failed to migrate review ${review.id}`);
            }
        }

        console.log('=== MY LEGACY REVIEWS MIGRATED ===');

    } catch (error) {
        console.error('Error migrating my legacy reviews:', error);
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ username
function getCurrentUsername() {
    // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ username
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ —Ñ–æ—Ä–º—ã –∏–ª–∏ –∏–∑ –∫–∞–∫–∏—Ö-—Ç–æ –¥—Ä—É–≥–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    return document.getElementById('name')?.value || '–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤
function debugReviews() {
    console.log('=== DEBUG REVIEWS ===');
    console.log('Current user token:', userToken);
    console.log('All reviews:', reviews);

    reviews.forEach((review, index) => {
        console.log(`Review ${index}:`, {
            id: review.id,
            user_token: review.user_token,
            device_fingerprint: review.device_fingerprint,
            canEdit: checkEditPermission(review)
        });
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è user_token –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∑—ã–≤–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function fixUserTokensForCurrentUser() {
    try {
        console.log('=== FIXING USER TOKENS FOR CURRENT USER ===');

        const reviewsToUpdate = reviews.filter(review =>
            (!review.user_token || review.user_token.startsWith('legacy_token_')) &&
            review.username // –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –æ—Ç–∑—ã–≤—ã —Å –Ω–∞—à–∏–º username - –Ω–∞—à–∏
        );

        if (reviewsToUpdate.length === 0) {
            console.log('No reviews to fix');
            return;
        }

        console.log(`Found ${reviewsToUpdate.length} reviews to fix`);

        for (const review of reviewsToUpdate) {
            console.log(`Fixing review ${review.id}: ${review.user_token} -> ${userToken}`);
            review.user_token = userToken;
            review.device_fingerprint = getDeviceFingerprint();
        }

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º UI —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        displayReviews(reviews);
        console.log('=== USER TOKENS FIXED ===');

    } catch (error) {
        console.error('Error fixing user tokens:', error);
    }
}

function debugReviewTokens() {
    console.log('=== DEBUG REVIEW TOKENS ===');
    console.log('Current user token:', userToken);
    console.log('All reviews:');

    reviews.forEach((review, index) => {
        const isCurrentUser = review.user_token === userToken;
        const isLegacy = review.user_token && review.user_token.startsWith('legacy_token_');

        console.log(`Review ${index + 1}:`, {
            id: review.id,
            username: review.username,
            user_token: review.user_token,
            is_current_user: isCurrentUser,
            is_legacy: isLegacy,
            should_show_buttons: isCurrentUser && !isLegacy
        });
    });
    console.log('===========================');
}
function debugReviewState(reviewId) {
    const review = reviews.find(r => r.id == reviewId);
    if (!review) {
        console.log('Review not found in array');
        return;
    }

    console.log('=== REVIEW DEBUG ===');
    console.log('ID:', review.id);
    console.log('User token in review:', review.user_token);
    console.log('Current user token:', userToken);
    console.log('Is author:', checkIsAuthor(review));
    console.log('Is legacy:', review.user_token.startsWith('legacy_token_'));
    console.log('====================');
}


// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï =====

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
function toggleReviewExpand(reviewId) {
    const reviewElement = document.querySelector(`.review-card[data-review-id="${reviewId}"]`);
    if (!reviewElement) return;

    reviewElement.classList.toggle('expanded');

    const button = reviewElement.querySelector('.expand-btn-bottom');
    if (button) {
        if (reviewElement.classList.contains('expanded')) {
            button.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
        } else {
            button.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ü–µ–Ω–∫–∏
async function setRating(isLike, reviewId) {
    try {
        console.log(`Setting rating: is_like=${isLike} for review ${reviewId}`);

        const response = await fetch(`/api/reviews/${reviewId}/rate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                is_like: isLike,
                user_token: userToken
            })
        });

        if (response.ok) {
            const data = await response.json();
            console.log('Server response:', data);

            updateReviewData(reviewId, data);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –æ—Ü–µ–Ω–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentUserRating = data.user_rating;
            updateLikeDislikeButtons();

        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
    } catch (error) {
        console.error('Error setting rating:', error);
        throw error;
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã –æ—Ç–∑—ã–≤–∞
function resetReviewForm() {
    document.getElementById('review-form').reset();
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–≤–µ–∑–¥—ã —Ä–µ–π—Ç–∏–Ω–≥–∞
    const stars = document.querySelectorAll('#review-stars .star');
    stars.forEach(star => {
        star.innerHTML = `<img src="${PATHS.starInactive}" alt="‚òÖ">`;
    });
    selectedRating = 0;
    document.getElementById('rating-error').style.display = 'none';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
async function initStats() {
    try {
        const response = await fetch(`/api/restaurants/${currentRestaurantId}/stats`);
        if (response.ok) {
            const stats = await response.json();
            updateRatingStats(stats);
        }
    } catch (error) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('overall-rating').textContent = '0.0';
        document.getElementById('total-reviews').textContent = '0';

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –±–∞—Ä—ã
        for (let i = 1; i <= 5; i++) {
            const bar = document.querySelector(`.rating-bar:nth-child(${6 - i}) .fill`);
            const countSpan = document.querySelector(`.rating-bar:nth-child(${6 - i}) span:last-child`);
            if (bar) bar.style.width = '0%';
            if (countSpan) countSpan.textContent = '0';
        }
    }
}

// –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞
function updateStatsLocally(newRating) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤
    const totalReviewsElem = document.getElementById('total-reviews');
    const currentTotal = parseInt(totalReviewsElem.textContent) || 0;
    totalReviewsElem.textContent = currentTotal + 1;

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥
    const overallRatingElem = document.getElementById('overall-rating');
    const currentRating = parseFloat(overallRatingElem.textContent) || 0;
    const newOverallRating = ((currentRating * currentTotal) + newRating) / (currentTotal + 1);
    overallRatingElem.textContent = newOverallRating.toFixed(1);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
    const ratingBars = document.querySelectorAll('.rating-bar');
    const targetBarIndex = 6 - newRating; // –ò–Ω–¥–µ–∫—Å –±–∞—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
    const targetBar = ratingBars[targetBarIndex - 1];

    if (targetBar) {
        const countSpan = targetBar.querySelector('span:last-child');
        const currentCount = parseInt(countSpan.textContent) || 0;
        countSpan.textContent = currentCount + 1;

        // –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        const barFill = targetBar.querySelector('.fill');
        const newTotal = currentTotal + 1;
        const newPercentage = ((currentCount + 1) / newTotal) * 100;
        barFill.style.width = `${newPercentage}%`;
    }

    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–∞—Ä—ã (–ø—Ä–æ—Ü–µ–Ω—Ç—ã –º–µ–Ω—è—é—Ç—Å—è)
    updateAllBarsPercentages(currentTotal + 1);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –≤—Å–µ—Ö –±–∞—Ä–æ–≤
function updateAllBarsPercentages(totalReviews) {
    if (totalReviews === 0) return;

    for (let i = 1; i <= 5; i++) {
        const barIndex = 6 - i;
        const bar = document.querySelector(`.rating-bar:nth-child(${barIndex})`);

        if (bar) {
            const countSpan = bar.querySelector('span:last-child');
            const count = parseInt(countSpan.textContent) || 0;
            const percentage = (count / totalReviews) * 100;

            const barFill = bar.querySelector('.fill');
            barFill.style.width = `${percentage}%`;
        }
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
// –ü—Ä–∏ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –æ–∫–Ω–∞
window.addEventListener('load', function() {
    console.log('Window fully loaded - updating scroll');
    setTimeout(updateScrollButtons, 300);
});

// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.addEventListener('resize', function() {
    setTimeout(updateScrollButtons, 200);
});

// –ü—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö DOM (MutationObserver)
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'childList' || mutation.type === 'attributes') {
            setTimeout(updateScrollButtons, 100);
        }
    });
});

// –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ
const reviewList = document.getElementById('review-list');
if (reviewList) {
    observer.observe(reviewList, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style']
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—â–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
async function updateOverallRating() {
    try {
        const response = await fetch(`/api/restaurants/${currentRestaurantId}/stats`);
        if (!response.ok) return; // –ù–µ –±—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É, —Ç.–∫. —ç—Ç–æ —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

        const stats = await response.json();
        updateRatingStats(stats);
    } catch (error) {
        console.error('Error updating overall rating:', error);
        // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, —Ç.–∫. —ç—Ç–æ —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å
    }
}

// –í—ã–∑—ã–≤–∞–µ–º —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞
document.addEventListener('DOMContentLoaded', () => {
    updateOverallRating();
    loadReviews();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤–µ–∑–¥ —Ä–µ–π—Ç–∏–Ω–≥–∞
    const stars = document.querySelectorAll('#review-stars .star');
    stars.forEach(star => {
        star.addEventListener('click', () => {
            selectedRating = parseInt(star.getAttribute('data-value'));
            stars.forEach((s, index) => {
                s.innerHTML = `<img src="${index < selectedRating ? PATHS.starActive : PATHS.starInactive}" alt="‚òÖ">`;
            });
            document.getElementById('rating-error').style.display = 'none';
        });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤
    loadReviews();
});
















// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–æ–≤ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
function resetReviewLimits() {
    const reviewLimits = JSON.parse(localStorage.getItem('reviewLimits')) || {};

    if (reviewLimits[userToken]) {
        delete reviewLimits[userToken];
        localStorage.setItem('reviewLimits', JSON.stringify(reviewLimits));
    }

    console.log('‚úÖ –õ–∏–º–∏—Ç—ã –æ—Ç–∑—ã–≤–æ–≤ —Å–±—Ä–æ—à–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userToken);
    showNotification('–õ–∏–º–∏—Ç—ã –æ—Ç–∑—ã–≤–æ–≤ —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
}

// üî• –£–ª—É—á—à–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
function generatePersistentUserToken() {
    let token = localStorage.getItem('userToken');

    if (!token) {
        // –°–æ–∑–¥–∞–µ–º –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤—ã–π —Ç–æ–∫–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        const persistentData = {
            userAgent: navigator.userAgent,
            language: navigator.language,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            screen: `${screen.width}x${screen.height}`,
            hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
            random: Math.random().toString(36).substr(2, 10),
            timestamp: Date.now().toString(36)
        };

        const persistentString = JSON.stringify(persistentData);
        token = 'token-' + btoa(persistentString).substr(0, 32);

        localStorage.setItem('userToken', token);
        console.log('üÜï –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π —É—Å—Ç–æ–π—á–∏–≤—ã–π user token:', token);
    } else {
        console.log('üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π user token:', token);
    }

    return token;
}

// –ê–±—Å–æ–ª—é—Ç–Ω–æ –Ω–∞–¥–µ–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è
function closeReviewModal() {
    const modal = document.getElementById('review-modal');
    if (modal) {
        modal.style.display = 'none';
    }

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    const form = document.getElementById('review-form');
    if (form) {
        form.reset();
    }

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–≤–µ–∑–¥—ã
    const stars = document.querySelectorAll('#review-stars .star');
    stars.forEach(star => {
        star.innerHTML = `<img src="${PATHS.starInactive}" alt="‚òÖ">`;
    });

    selectedRating = 0;
}








// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    loadReviews();
});

function initFavorites() {
    console.log('Initializing favorites...');

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    updateFavoritesCount();

    // –û—Ç–º–µ—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ
    markExistingFavorites();

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    document.querySelectorAll('.js-favorite-btn').forEach(btn => {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        btn.replaceWith(btn.cloneNode(true));
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    document.querySelectorAll('.js-favorite-btn').forEach(btn => {
        btn.addEventListener('click', function(event) {
            console.log('Favorite button clicked');
            const itemId = this.dataset.itemId;
            const itemData = JSON.parse(this.dataset.item);
            toggleFavorite(event, itemId, itemData);
        });
    });

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
    window.addEventListener('storage', function(event) {
        if (event.key === 'favorites') {
            console.log('Favorites updated from storage');
            updateFavoritesCount();
            markExistingFavorites();
        }
    });

    console.log('Favorites initialized');
}

function toggleFavorite(event, itemId, itemData) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    const button = event ? event.currentTarget : this;

    try {
        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
        if (!itemData && button) {
            const itemDataStr = button.getAttribute('data-item');
            if (itemDataStr) {
                itemData = JSON.parse(itemDataStr);
            }
        }

        // –ï—Å–ª–∏ itemId –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –ø–æ–ª—É—á–∞–µ–º –∏–∑ –¥–∞–Ω–Ω—ã—Ö
        if (!itemId && itemData) {
            itemId = itemData.id;
        }

        if (!itemId || !itemData) {
            console.error('Missing item data for favorite toggle');
            return;
        }

        const favorites = getFavorites();
        const existingIndex = favorites.findIndex(fav => fav.id === itemId);

        if (existingIndex === -1) {
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            favorites.push(itemData);
            if (button) button.classList.add('active');
            console.log(`‚úÖ "${itemData.name}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ`);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showFavoriteNotification(`"${itemData.name}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ`, 'success');
        } else {
            // –£–¥–∞–ª—è–µ–º –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
            favorites.splice(existingIndex, 1);
            if (button) button.classList.remove('active');
            console.log(`‚ùå "${itemData.name}" —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ`);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showFavoriteNotification(`"${itemData.name}" —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ`, 'remove');
        }

        saveFavorites(favorites);
        updateFavoritesCount();

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        markExistingFavorites();

    } catch (error) {
        console.error('Error toggling favorite:', error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∏–∑–±—Ä–∞–Ω–Ω–æ–º
function showFavoriteNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `favorite-notification ${type}`;
    notification.textContent = message;

    notification.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: ${type === 'success' ? '#4CAF50' : '#ff4757'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease;
        max-width: 300px;
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö
function markExistingFavorites() {
    try {
        const favorites = getFavorites();
        console.log(`Marking existing favorites: ${favorites.length} items`);

        document.querySelectorAll('.js-favorite-btn').forEach(btn => {
            try {
                const itemData = JSON.parse(btn.getAttribute('data-item'));
                if (itemData && itemData.id) {
                    const isFavorite = favorites.some(fav => fav.id === itemData.id);
                    if (isFavorite) {
                        btn.classList.add('active');
                        console.log(`Marked as favorite: ${itemData.name}`);
                    } else {
                        btn.classList.remove('active');
                    }
                }
            } catch (error) {
                console.error('Error marking favorite button:', error);
            }
        });
    } catch (error) {
        console.error('Error in markExistingFavorites:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞
function updateFavoritesCount() {
    try {
        const favorites = getFavorites();
        const count = favorites.length;
        const counter = document.getElementById('favorites-count');
        const headerBtn = document.getElementById('header-favorites-btn');

        console.log(`Updating favorites count: ${count}`);

        if (counter) {
            counter.textContent = count;
        }

        if (headerBtn) {
            if (count > 0) {
                headerBtn.style.display = 'inline-block';
                setTimeout(() => {
                    headerBtn.style.opacity = '1';
                    headerBtn.style.transform = 'translateY(0)';
                }, 10);
            } else {
                headerBtn.style.opacity = '0';
                headerBtn.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    headerBtn.style.display = 'none';
                }, 300);
            }
        }
    } catch (error) {
        console.error('Error updating favorites count:', error);
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getFavorites() {
    try {
        return JSON.parse(localStorage.getItem('favorites')) || [];
    } catch (error) {
        console.error('Error getting favorites:', error);
        return [];
    }
}

function saveFavorites(favorites) {
    try {
        localStorage.setItem('favorites', JSON.stringify(favorites));
        // –¢—Ä–∏–≥–≥–µ—Ä–∏–º custom event –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
        window.dispatchEvent(new Event('favoritesUpdated'));
    } catch (error) {
        console.error('Error saving favorites:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
function forceUIUpdate() {
  const headerBtn = document.getElementById('header-favorites-btn');
  if (headerBtn) {
    // 1. –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
    headerBtn.classList.add('hide');

    // 2. –ß–µ—Ä–µ–∑ 300ms (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏) –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    setTimeout(() => {
      updateFavoritesVisibility();
      headerBtn.classList.remove('hide');
    }, 300);
  } else {
    updateFavoritesVisibility();
  }
}

// –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏
function updateFavoritesVisibility() {
  const favorites = JSON.parse(localStorage.getItem('favorites')) || {};
  const count = Object.keys(favorites).length;
  const headerBtn = document.getElementById('header-favorites-btn');
  const counter = document.getElementById('favorites-count');

  if (counter) counter.textContent = count;

  if (!headerBtn) return;

  if (count > 0) {
    showHeaderButton();
  } else {
    hideHeaderButton();
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –≤ —à–∞–ø–∫–µ
function showHeaderButton() {
  const btn = document.getElementById('header-favorites-btn');
  if (!btn.classList.contains('visible')) {
    btn.style.display = 'inline-block';
    setTimeout(() => {
      btn.classList.add('visible');
    }, 10);
  }
}

// –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
function hideHeaderButton() {
  const btn = document.getElementById('header-favorites-btn');
  if (btn.classList.contains('visible')) {
    btn.classList.remove('visible');
    setTimeout(() => {
      btn.style.display = 'none';
    }, 300); // –î–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é transition
  }
}


    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–∫–æ–Ω –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function showWindow() {
        document.getElementById('overlay').style.display = 'block';
        const windowElement = document.getElementById('content_window');
        windowElement.classList.add('show');
        windowElement.style.display = 'block';
        document.body.classList.add('no-scroll');
    }

    function hideWindow() {
        document.getElementById('overlay').style.display = 'none';
        const windowElement = document.getElementById('content_window');
        windowElement.classList.remove('show');
        windowElement.style.display = 'none';
        document.body.classList.remove('no-scroll');
    }

    function showWindow1() {
        document.getElementById('overlay').style.display = 'block';
        const windowElement = document.getElementById('content_window2');
        windowElement.classList.add('show');
        windowElement.style.display = 'block';
        document.body.classList.add('no-scroll');
    }

    function hideWindow1() {
        document.getElementById('overlay').style.display = 'none';
        const windowElement = document.getElementById('content_window2');
        windowElement.classList.remove('show');
        windowElement.style.display = 'none';
        document.body.classList.remove('no-scroll');
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.getElementById('overlay').addEventListener('click', function() {
        const window1 = document.getElementById('content_window');
        const window2 = document.getElementById('content_window2');
        if (window1.classList.contains('show')) {
            hideWindow();
        } else if (window2.classList.contains('show')) {
            hideWindow1();
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    document.getElementById('regForm').onsubmit = function(event) {
        event.preventDefault();

        const username = document.getElementById('username1').value;
        const password = document.getElementById('password1').value;
        const confirmPassword = document.getElementById('password2').value;
        const secretKey = document.getElementById('secret_key').value;

        if (password !== confirmPassword) {
            alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
            return;
        }

        fetch('/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'username': username,
                'password': password,
                'secret_key': secretKey
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('welcomeUser').innerText = data.username;
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('registerButton').style.display = 'none';
                hideWindow1();
                localStorage.setItem('username', data.username);
            } else {
                alert(data.message);
            }
        });
    };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
    document.getElementById('loginForm').onsubmit = function(event) {
        event.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        fetch('/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'username': username,
                'password': password
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('welcomeUser').innerText = data.username;
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('registerButton').style.display = 'none';
                hideWindow();
                localStorage.setItem('username', data.username);
            } else {
                alert(data.message);
            }
        });
    };

    // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
    function logout() {
        fetch('/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('loginButton').style.display = 'block';
                document.getElementById('registerButton').style.display = 'block';
                localStorage.removeItem('username');
            } else {
                alert(data.message);
            }
        });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', function() {
        const username = localStorage.getItem('username');
        if (username) {
            document.getElementById('welcomeUser').innerText = username;
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('loginButton').style.display = 'none';
            document.getElementById('registerButton').style.display = 'none';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        FavoritesManager.init();
    });

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
    window.addEventListener('storage', function(event) {
        if (event.key === 'username') {
            if (event.newValue) {
                document.getElementById('welcomeUser').innerText = event.newValue;
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('registerButton').style.display = 'none';
            } else {
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('loginButton').style.display = 'block';
                document.getElementById('registerButton').style.display = 'block';
            }
        }
    });

    // –ú–µ–Ω–µ–¥–∂–µ—Ä –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ HTML
    const FavoritesManager = {
        init: function() {
            this.bindEvents();
            this.updateCounter();
            this.markExistingFavorites();
        },

        bindEvents: function() {
            document.querySelectorAll('.js-favorite-btn').forEach(btn => {
                btn.addEventListener('click', this.handleFavoriteClick.bind(this));
            });
        },

        handleFavoriteClick: function(event) {
            const button = event.currentTarget;
            if (!button) return;

            try {
                const itemData = button.getAttribute('data-item');
                if (!itemData) {
                    console.error('No data-item attribute found');
                    return;
                }

                const item = JSON.parse(itemData);
                if (!item || !item.id) {
                    console.error('Invalid item data');
                    return;
                }

                const favorites = this.getFavorites();
                const existingIndex = favorites.findIndex(fav => fav.id === item.id);

                if (existingIndex === -1) {
                    favorites.push(item);
                    button.classList.add('active');
                    this.showNotification(`"${item.name}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ`);
                } else {
                    favorites.splice(existingIndex, 1);
                    button.classList.remove('active');
                    this.showNotification(`"${item.name}" —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ`);
                }

                this.saveFavorites(favorites);
                this.updateCounter();
            } catch (error) {
                console.error('Error handling favorite click:', error);
            }
        },

        markExistingFavorites: function() {
            const favorites = this.getFavorites();
            document.querySelectorAll('.js-favorite-btn').forEach(btn => {
                try {
                    const itemData = btn.getAttribute('data-item');
                    if (!itemData) return;

                    const item = JSON.parse(itemData);
                    if (item && item.id && favorites.some(fav => fav.id === item.id)) {
                        btn.classList.add('active');
                    }
                } catch (error) {
                    console.error('Error marking existing favorite:', error);
                }
            });
        },

        getFavorites: function() {
            try {
                return JSON.parse(localStorage.getItem('favorites')) || [];
            } catch (error) {
                console.error('Error getting favorites:', error);
                return [];
            }
        },

        saveFavorites: function(favorites) {
            try {
                localStorage.setItem('favorites', JSON.stringify(favorites));
            } catch (error) {
                console.error('Error saving favorites:', error);
            }
        },

        updateCounter: function() {
            try {
                const count = this.getFavorites().length;
                const counter = document.getElementById('favorites-count');
                if (counter) counter.textContent = count;
            } catch (error) {
                console.error('Error updating counter:', error);
            }
        },

        showNotification: function(message) {
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.backgroundColor = 'rgba(0,0,0,0.8)';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '1000';
            notification.style.transition = 'opacity 0.5s';
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 2000);
        }
    };

    // –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏
    function flipCard() {
        document.querySelector('.image-flip-container').classList.toggle('flipped');
    }

    // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    function expandImage(btn) {
        const img = btn.closest('.image-front').querySelector('img');
        const imgSrc = img.src;

        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.9)';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        overlay.style.zIndex = '1000';
        overlay.style.cursor = 'zoom-out';

        const expandedImg = document.createElement('img');
        expandedImg.src = imgSrc;
        expandedImg.style.maxWidth = '90%';
        expandedImg.style.maxHeight = '90%';
        expandedImg.style.objectFit = 'contain';

        overlay.appendChild(expandedImg);
        overlay.onclick = function() {
            document.body.removeChild(overlay);
        };

        document.body.appendChild(overlay);
    }

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–µ–Ω—é
    function openMenuModal() {
        document.getElementById('menu-modal').style.display = 'flex';
    }
    function closeMenuModal() {
        document.getElementById('menu-modal').style.display = 'none';
    }

// üî• –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ç–∑—ã–≤–∞
function openReviewModal() {
    console.log('=== –û–¢–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ===');

    // üî• –†–ê–°–ö–û–ú–ú–ï–ù–¢–ò–†–£–ô–¢–ï –≠–¢–û–¢ –ë–õ–û–ö –û–ë–†–ê–¢–ù–û:
    if (!canUserPostReview(currentRestaurantId)) {
        const timeUntilNext = getTimeUntilNextReview(currentRestaurantId);
        let message = '–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è. ';

        if (timeUntilNext) {
            const formattedTime = formatTimeUntilNextReview(currentRestaurantId);
            message += `–°–ª–µ–¥—É—é—â–∏–π –æ—Ç–∑—ã–≤ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ ${formattedTime}`;
        } else {
            message += '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
        }

        console.log('‚ùå –û—Ç–∑—ã–≤ –∑–∞–ø—Ä–µ—â–µ–Ω:', message);
        showNotification(message, 'error');
        return;
    }

    console.log('‚úÖ –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É');

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º/–ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
    if (!localStorage.getItem('userToken')) {
        userToken = generateUserToken();
    }

    document.getElementById('review-modal').style.display = 'flex';
}

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –æ–±–ª–∞—Å—Ç–∏
    document.getElementById('review-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReviewModal();
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
    document.querySelector('#review-modal .close').addEventListener('click', function() {
        closeReviewModal();
    });

    function filterReviewsByRating(rating) {
    const reviewList = document.getElementById('review-list');
    const reviewCards = reviewList.querySelectorAll('.review-card');
    let hasMatches = false;

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤"
    const oldMsg = document.getElementById('no-reviews-message');
    if (oldMsg) oldMsg.remove();

    // –§–∏–ª—å—Ç—Ä—É–µ–º –æ—Ç–∑—ã–≤—ã (–≤–∫–ª—é—á–∞—è —Ç–µ, —á—Ç–æ –µ—â–µ –Ω–µ –≤ –ë–î)
    reviewCards.forEach(card => {
        // –ò—â–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –¥–≤—É–º—è —Å–ø–æ—Å–æ–±–∞–º–∏ (–¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ –∏–∑ –ë–î –∏ –Ω–æ–≤—ã—Ö)
        let cardRating;

        // –°–ø–æ—Å–æ–± 1: –ü–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –∑–≤–µ–∑–¥–∞–º (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –æ—Ç–∑—ã–≤–æ–≤)
        const filledStars = card.querySelectorAll('.review-rating img[src*="baka.png"]');
        if (filledStars.length > 0) {
            cardRating = filledStars.length;
        }
        // –°–ø–æ—Å–æ–± 2: –ü–æ data-–∞—Ç—Ä–∏–±—É—Ç—É (–¥–ª—è –Ω–æ–≤—ã—Ö –æ—Ç–∑—ã–≤–æ–≤)
        else {
            const ratingElem = card.querySelector('.rating');
            cardRating = ratingElem ? parseInt(ratingElem.dataset.rating) : 0;
        }

        if (rating === 0 || cardRating === rating) {
            card.style.display = 'flex';
            hasMatches = true;
        } else {
            card.style.display = 'none';
        }
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    if (!hasMatches && rating !== 0) {
        const msg = document.createElement('div');
        msg.id = 'no-reviews-message';
        msg.textContent = '–¢–∞–∫–∏—Ö –æ—Ç–∑—ã–≤–æ–≤ –Ω–µ—Ç!';
        msg.style.textAlign = 'center';
        msg.style.padding = '20px';
        msg.style.color = '#666';
        msg.style.width = '100%';
        reviewList.appendChild(msg);
    }

    // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    setTimeout(updateScrollButtons, 150);
}

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–≤–µ–∑–¥ —Ñ–∏–ª—å—Ç—Ä–∞
    const filterStars = document.querySelectorAll('#filter-stars .star');
    let currentFilter = {
        rating: 0,      // –§–∏–ª—å—Ç—Ä –ø–æ –∑–≤–µ–∑–¥–∞–º (0 - –≤—Å–µ)
        reaction: 'none' // –§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–∞–∫—Ü–∏—è–º ('none', 'likes', 'dislikes')
    };

    filterStars.forEach(star => {
        star.addEventListener('click', function() {
            const value = parseInt(this.getAttribute('data-value'));

            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–≤–µ–∑–¥—É - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
            if (currentFilter === value) {
                currentFilter = 0;
                filterStars.forEach(s => {
                    s.innerHTML = `<img src="${PATHS.starInactive}" alt="‚òÖ">`;
                });
            } else {
                currentFilter = value;
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∑–≤–µ–∑–¥—ã –¥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                filterStars.forEach((s, index) => {
                    const starValue = index + 1;
                    s.innerHTML = `<img src="${starValue <= value ? PATHS.starActive : PATHS.starInactive}"
                                       alt="‚òÖ">`;
                });
            }

            filterReviewsByRating(currentFilter);
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–∞–∫—Ü–∏–π
    const filterButtons = document.querySelectorAll('.filter-btn[data-type]');
    filterButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const filterType = this.getAttribute('data-type');

            // –ï—Å–ª–∏ –∫–ª–∏–∫–∞–µ–º –Ω–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
            if (currentFilter.reaction === filterType) {
                currentFilter.reaction = 'none';
                filterButtons.forEach(b => b.classList.remove('active'));
                document.querySelector('.filter-btn[data-type="none"]').classList.add('active');
            } else {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
                currentFilter.reaction = filterType;
                filterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            }

            applyFilters();
        });
    });


    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –æ—Ç–∑—ã–≤–æ–≤
    function showAllReviews() {
        currentFilter = 0;
        filterStars.forEach(star => {
            star.innerHTML = `<img src="${PATHS.starInactive}" alt="‚òÖ">`;
        });
        filterReviewsByRating(0);
    }

    // –õ–∞–π–∫–∏ –∏ –¥–∏–∑–ª–∞–π–∫–∏
    let likeCount = 0;
    let dislikeCount = 0;

function animateReaction(isLike) {
    const likeBtn = document.querySelector('#full-review-modal .like-btn');
    const dislikeBtn = document.querySelector('#full-review-modal .dislike-btn');
    const currentUserRating = getUserRating(currentReviewId);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –Ω—É–∂–Ω–∞
    if (isLike) {
        if (currentUserRating === 'like') {
            // –°–Ω–∏–º–∞–µ–º –ª–∞–π–∫ - –∞–Ω–∏–º–∞—Ü–∏—è –æ—Ç–º–µ–Ω—ã
            likeBtn.classList.add('cancel-animate');
            setTimeout(() => likeBtn.classList.remove('cancel-animate'), 500);
        } else {
            // –°—Ç–∞–≤–∏–º –ª–∞–π–∫ - –∞–Ω–∏–º–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            likeBtn.classList.add('animate');
            setTimeout(() => likeBtn.classList.remove('animate'), 600);
        }
    } else {
        if (currentUserRating === 'dislike') {
            // –°–Ω–∏–º–∞–µ–º –¥–∏–∑–ª–∞–π–∫ - –∞–Ω–∏–º–∞—Ü–∏—è –æ—Ç–º–µ–Ω—ã
            dislikeBtn.classList.add('cancel-animate');
            setTimeout(() => dislikeBtn.classList.remove('cancel-animate'), 500);
        } else {
            // –°—Ç–∞–≤–∏–º –¥–∏–∑–ª–∞–π–∫ - –∞–Ω–∏–º–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            dislikeBtn.classList.add('animate');
            setTimeout(() => dislikeBtn.classList.remove('animate'), 600);
        }
    }
}

// ===== –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö =====

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤
function likeReview() {
    if (!currentReviewId) return;
    animateReaction(true);
    rateReview(true, currentReviewId);
}

function dislikeReview() {
    if (!currentReviewId) return;
    animateReaction(false);
    rateReview(false, currentReviewId);
}

    // –û—Ü–µ–Ω–∫–∞ –∑–≤—ë–∑–¥–∞–º–∏
    const stars = document.querySelectorAll('#review-stars .star');

    stars.forEach(star => {
        star.addEventListener('click', () => {
            const value = parseFloat(star.getAttribute('data-value'));
            selectedRating = value; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ—Ü–µ–Ω–∫—É

            stars.forEach((s, index) => {
                const starValue = parseFloat(s.getAttribute('data-value'));
                if (starValue <= value) {
                    s.innerHTML = `<img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/baka.png') }}" alt="‚òÖ" style="width: 24px; height: 24px;">`;
                } else {
                    s.innerHTML = `<img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ" style="width: 24px; height: 24px;">`;
                }
            });
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ü–µ–Ω–æ–∫
function debugRatings(reviewId) {
    const review = reviews.find(r => r.id == reviewId);
    if (!review) {
        console.log('–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }

    console.log('=== –î–ï–ë–ê–ì –û–¶–ï–ù–û–ö ===');
    console.log('ID –æ—Ç–∑—ã–≤–∞:', reviewId);
    console.log('–õ–∞–π–∫–∏:', review.likes);
    console.log('–î–∏–∑–ª–∞–π–∫–∏:', review.dislikes);
    console.log('User ratings:', review.user_ratings);
    console.log('–¢–µ–∫—É—â–∏–π user token:', userToken);
    console.log('–û—Ü–µ–Ω–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', review.user_ratings?.[userToken]);
    console.log('===================');
}

// –í—ã–∑—ã–≤–∞–π—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–ª–∞–¥–∫–∏
// debugRatings(currentReviewId);


    reviewList.scrollTo({
        left: 0,
        behavior: 'smooth'
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –æ–±–ª–∞—Å—Ç–∏
    document.getElementById('full-review-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeFullReviewModal();
        }
    });

// –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeFullReviewModal() {
    const modal = document.getElementById('full-review-modal');
    if (modal) {
        modal.style.display = 'none';
        currentReviewId = null;
        currentUserRating = null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ª–∞–π–∫–∞/–¥–∏–∑–ª–∞–π–∫–∞
async function handleReaction(isLike) {
    if (!currentReviewId) {
        return;
    }

    try {
        const review = reviews.find(r => r.id == currentReviewId);
        if (!review) {
            return;
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞–∂–∞—Ç–∏—è
        const likeBtn = document.querySelector('#full-review-modal .like-btn');
        const dislikeBtn = document.querySelector('#full-review-modal .dislike-btn');

        if (isLike && likeBtn) {
            likeBtn.classList.add('click-animation');
            setTimeout(() => likeBtn.classList.remove('click-animation'), 300);
        } else if (!isLike && dislikeBtn) {
            dislikeBtn.classList.add('click-animation');
            setTimeout(() => dislikeBtn.classList.remove('click-animation'), 300);
        }

        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ü–µ–Ω–æ–∫
        if (currentUserRating === (isLike ? 'like' : 'dislike')) {
            // –ï—Å–ª–∏ –∫–ª–∏–∫–∞–µ–º –Ω–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É - —Å–Ω–∏–º–∞–µ–º –æ—Ü–µ–Ω–∫—É
            await removeRating(currentReviewId);
        } else {
            // –ï—Å–ª–∏ –≤—ã–±–∏—Ä–∞–µ–º –¥—Ä—É–≥—É—é –æ—Ü–µ–Ω–∫—É - –º–µ–Ω—è–µ–º
            await setRating(isLike, currentReviewId);
        }

    } catch (error) {
        console.error('Error handling reaction:', error);
    }
}

    function updateLikeDislikeHandlers(reviewId) {
    const likeBtn = document.querySelector('#full-review-modal .like-btn');
    const dislikeBtn = document.querySelector('#full-review-modal .dislike-btn');

    if (likeBtn) {
        likeBtn.onclick = () => handleReaction(true, reviewId);
    }
    if (dislikeBtn) {
        dislikeBtn.onclick = () => handleReaction(false, reviewId);
    }
}

// ===== –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–ö–†–´–¢–ò–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê =====
// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function openFullReviewModal(reviewId) {
    console.log('Opening full review modal for ID:', reviewId);

    // –ò—â–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤–∞
    let reviewData = reviews.find(r => r.id == reviewId);

    if (!reviewData) {
        console.error('Review not found in local array:', reviewId);
        return;
    }

    const modal = document.getElementById('full-review-modal');
    if (!modal) {
        console.error('Modal not found');
        return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–∑—ã–≤–∞
    currentReviewId = reviewId;
    modal.dataset.reviewId = reviewId;

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∞–Ω–Ω—ã–º–∏
    const reviewNameElem = modal.querySelector('.review-name');
    const reviewRatingElem = modal.querySelector('.review-rating');
    const reviewCommentElem = modal.querySelector('.review-comment');
    const likeCountElem = modal.querySelector('.like-count');
    const dislikeCountElem = modal.querySelector('.dislike-count');

    if (reviewNameElem) reviewNameElem.textContent = reviewData.username;
    if (reviewCommentElem) reviewCommentElem.textContent = reviewData.comment;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤
    if (likeCountElem) likeCountElem.textContent = reviewData.likes || 0;
    if (dislikeCountElem) dislikeCountElem.textContent = reviewData.dislikes || 0;

    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∑–≤–µ–∑–¥ —Ä–µ–π—Ç–∏–Ω–≥–∞
    let starsHTML = '';
    for (let i = 0; i < 5; i++) {
        if (i < reviewData.rating) {
            starsHTML += `<img src="${PATHS.starActive}" alt="‚òÖ" style="width:20px;height:20px;">`;
        } else {
            starsHTML += `<img src="${PATHS.starInactive}" alt="‚òÖ" style="width:20px;height:20px;">`;
        }
    }
    if (reviewRatingElem) reviewRatingElem.innerHTML = starsHTML;

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –æ—Ü–µ–Ω–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    currentUserRating = getUserRating(reviewId);

    // –û–±–Ω–æ–≤–ª—è–µ–º UI –æ—Ü–µ–Ω–æ–∫
    updateModalRatingUI(
        reviewData.likes || 0,
        reviewData.dislikes || 0,
        currentUserRating
    );

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
    const oldButtonsContainer = modal.querySelector('.modal-action-buttons');
    if (oldButtonsContainer) {
        oldButtonsContainer.remove();
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è
    addEditDeleteButtonsToModal(modal, reviewData);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modal.style.display = 'flex';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
function updateLikeDislikeButtons() {
    const likeBtn = document.querySelector('#full-review-modal .like-btn');
    const dislikeBtn = document.querySelector('#full-review-modal .dislike-btn');

    if (!likeBtn || !dislikeBtn) return;

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    likeBtn.classList.remove('active');
    dislikeBtn.classList.remove('active');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (currentUserRating === 'like') {
        likeBtn.classList.add('active');
    } else if (currentUserRating === 'dislike') {
        dislikeBtn.classList.add('active');
    }

    console.log(`Updated buttons: user_rating=${currentUserRating}`);
}

// –ü–ï–†–ï–ü–ò–°–ê–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
function addEditDeleteButtonsToModal(modal, reviewData) {
    console.log('=== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–û–ö –î–õ–Ø –û–¢–ó–´–í–ê ===');

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –∏ –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    const oldButtonsContainer = modal.querySelector('.modal-action-buttons');
    if (oldButtonsContainer) oldButtonsContainer.remove();

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    const oldDebugInfo = modal.querySelector('.debug-info');
    if (oldDebugInfo) oldDebugInfo.remove();

    // –°–¢–†–û–ì–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä—Å—Ç–≤–∞ - —Ç–æ–ª—å–∫–æ –ø–æ user_token
    const isAuthor = checkIsAuthor(reviewData);
    console.log('Author check result:', {
        isAuthor: isAuthor,
        reviewToken: reviewData.user_token,
        currentToken: userToken
    });

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –∞–≤—Ç–æ—Ä - –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏—á–µ–≥–æ (–Ω–∏ –∫–Ω–æ–ø–æ–∫, –Ω–∏ –æ—Ç–ª–∞–¥–∫–∏)
    if (!isAuthor) {
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä - –∫–Ω–æ–ø–∫–∏ –Ω–µ –ø–æ–∫–∞–∑–∞–Ω—ã');
        return; // –ü—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
    }

    // –î–û–°–¢–ò–ì–õ–ò –°–Æ–î–ê –¢–û–õ–¨–ö–û –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ - –ê–í–¢–û–†

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è
    const canEdit = checkEditPermissionSync(reviewData);
    const canDelete = checkDeletePermissionSync(reviewData);

    console.log('Permissions for author:', { canEdit, canDelete });

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'modal-action-buttons';
    buttonsContainer.style.cssText = 'justify-content: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; flex-wrap: wrap;';

    // –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∞)
    if (canEdit) {
        const editButton = document.createElement('button');
        editButton.className = 'edit-review-btn';
        editButton.innerHTML = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        editButton.style.cssText = 'padding: 8px 16px; background: rgb(40, 167, 69); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;';
        editButton.onclick = (e) => {
            e.stopPropagation();
            closeFullReviewModal();
            setTimeout(() => {
                openEditReviewModal(reviewData.id, reviewData.rating, reviewData.comment);
            }, 100);
        };
        buttonsContainer.appendChild(editButton);
    } else {
        // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¢–û–õ–¨–ö–û –¥–ª—è –∞–≤—Ç–æ—Ä–∞)
        const timeMessage = document.createElement('div');
        timeMessage.className = 'edit-time-expired';
        timeMessage.innerHTML = '‚è∞ –í—Ä–µ–º—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ (3 —á–∞—Å–∞)';
        timeMessage.style.cssText = 'color: #ff6b6b; font-size: 14px; padding: 8px 12px; background: #fff5f5; border-radius: 4px; border: 1px solid #ffd6d6;';
        buttonsContainer.appendChild(timeMessage);
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞ –æ—Ç–∑—ã–≤–æ–≤ (1 –≤ –¥–µ–Ω—å)
function canUserPostReview(restaurantId) {
    try {
        const reviewLimits = JSON.parse(localStorage.getItem('reviewLimits')) || {};
        const userLimit = reviewLimits[userToken];

        if (!userLimit) {
            console.log('‚úÖ –ù–µ—Ç –ª–∏–º–∏—Ç–æ–≤ - –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤');
            return true;
        }

        // üî• –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –ö–û–ù–ö–†–ï–¢–ù–û–ú–£ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É
        if (userLimit.restaurantId === restaurantId) {
            const lastReviewDate = new Date(userLimit.lastReviewDate);
            const now = new Date();

            // üî• –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ø—Ä–æ—à–ª–æ –ª–∏ 24 —á–∞—Å–∞?
            const timeDiff = now - lastReviewDate;
            const hoursDiff = timeDiff / (1000 * 60 * 60);

            const canPost = hoursDiff >= 24;

            console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:', {
                restaurantId: restaurantId,
                lastReviewRestaurant: userLimit.restaurantId,
                lastReviewDate: lastReviewDate.toLocaleString(),
                currentTime: now.toLocaleString(),
                hoursDiff: hoursDiff.toFixed(2),
                canPost: canPost
            });

            return canPost;
        }

        // üî• –î–ª—è –¥—Ä—É–≥–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–µ—Ç
        console.log('‚úÖ –î—Ä—É–≥–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω - –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤');
        return true;

    } catch (error) {
        console.error('Error checking review limit:', error);
        return true;
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞
function updateUserReviewLimit(restaurantId, action = 'add') {
    console.log('üîÑ –í–´–ó–í–ê–ù–ê –§–£–ù–ö–¶–ò–Ø updateUserReviewLimit:', {
        restaurantId,
        action,
        functionVersion: 'NEW_VERSION_WITH_ACTION_PARAM'
    });
    try {
        const reviewLimits = JSON.parse(localStorage.getItem('reviewLimits')) || {};

        console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞:', { action, restaurantId, currentLimits: reviewLimits[userToken] });

        if (action === 'add') {
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–º–∏—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞
            reviewLimits[userToken] = {
                lastReviewDate: new Date().toISOString(),
                restaurantId: restaurantId
            };
            console.log('‚úÖ –õ–∏–º–∏—Ç –£–°–¢–ê–ù–û–í–õ–ï–ù –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:', restaurantId);
        } else if (action === 'remove') {
            // –£–¥–∞–ª—è–µ–º –ª–∏–º–∏—Ç –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞
            if (reviewLimits[userToken] && reviewLimits[userToken].restaurantId === restaurantId) {
                delete reviewLimits[userToken];
                console.log('‚úÖ –õ–∏–º–∏—Ç –°–ù–Ø–¢ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:', restaurantId);
            } else {
                console.log('‚ö†Ô∏è –õ–∏–º–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:', restaurantId);
            }
        }

        localStorage.setItem('reviewLimits', JSON.stringify(reviewLimits));
        console.log('üìä –¢–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', reviewLimits);

    } catch (error) {
        console.error('Error updating review limit:', error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–∑—ã–≤–∞
function getTimeUntilNextReview(restaurantId = null) {
    try {
        const reviewLimits = JSON.parse(localStorage.getItem('reviewLimits')) || {};
        const userLimit = reviewLimits[userToken];

        if (!userLimit) {
            return null;
        }

        // üî• –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ—Ç –∂–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω
        if (restaurantId && userLimit.restaurantId === restaurantId) {
            const lastReviewDate = new Date(userLimit.lastReviewDate);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);

            const timeDiff = tomorrow - today;
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));

            console.log('‚è∞ –í—Ä–µ–º—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–∑—ã–≤–∞ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:', { hours, minutes, restaurantId });

            return { hours, minutes };
        }

        return null;
    } catch (error) {
        console.error('Error getting time until next review:', error);
        return null;
    }
}

    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∞)
    if (canDelete) {
        const deleteButton = document.createElement('button');
        deleteButton.className = 'delete-review-btn';
        deleteButton.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
        deleteButton.style.cssText = 'padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;';
        deleteButton.onclick = (e) => {
            e.stopPropagation();
            showCustomDeleteConfirmation(reviewData.id);
        };
        buttonsContainer.appendChild(deleteButton);
    } else {
        // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ —É–¥–∞–ª–µ–Ω–∏—è (–¢–û–õ–¨–ö–û –¥–ª—è –∞–≤—Ç–æ—Ä–∞)
        const timeMessage = document.createElement('div');
        timeMessage.className = 'delete-time-expired';
        timeMessage.innerHTML = '‚è∞ –í—Ä–µ–º—è —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ (6 —á–∞—Å–æ–≤)';
        timeMessage.style.cssText = 'color: #ff9500; font-size: 14px; padding: 8px 12px; background: #fff4e6; border-radius: 4px; border: 1px solid #ffe0b2;';
        buttonsContainer.appendChild(timeMessage);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å)
    if (buttonsContainer.children.length > 0) {
        modal.querySelector('.modal-content').appendChild(buttonsContainer);
        console.log('–ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–ª—è –∞–≤—Ç–æ—Ä–∞');
    }

    console.log('=== –ö–ù–û–ü–ö–ò –î–û–ë–ê–í–õ–ï–ù–´ –¢–û–õ–¨–ö–û –î–õ–Ø –ê–í–¢–û–†–ê ===');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
function showCustomDeleteConfirmation(reviewId) {
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    const confirmModal = document.createElement('div');
    confirmModal.id = 'delete-confirmation-modal';
    confirmModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;

    confirmModal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center; max-width: 400px; width: 90%;">
            <h3 style="margin-bottom: 20px; color: #333;">–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤?</h3>
            <p style="margin-bottom: 25px; color: #666;">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button id="cancel-delete" style="padding: 10px 25px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 5px; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirm-delete" style="padding: 10px 25px; border: none; background: #f44336; color: white; border-radius: 5px; cursor: pointer;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    `;

    document.body.appendChild(confirmModal);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
    document.getElementById('cancel-delete').onclick = function() {
        document.body.removeChild(confirmModal);
    };

    document.getElementById('confirm-delete').onclick = function() {
        document.body.removeChild(confirmModal);
        deleteReview(reviewId);
        closeFullReviewModal();
    };

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    confirmModal.onclick = function(e) {
        if (e.target === confirmModal) {
            document.body.removeChild(confirmModal);
        }
    };
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
document.getElementById('edit-review-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ √ó
document.querySelector('#edit-review-modal .close').addEventListener('click', closeEditModal);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–Ω–∏—Ü—ã –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ —á–∞—Å–∞—Ö
function getTimeDifferenceHours(createdAt) {
    const created = new Date(createdAt);
    const now = new Date();
    return (now - created) / (1000 * 60 * 60);
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
function checkEditPermissionSync(review) {
    try {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º
        if (!checkIsAuthor(review)) {
            return false;
        }


        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è (3 —á–∞—Å–∞)
        const createdAt = new Date(review.created_at);
        const now = new Date();
        const hoursDiff = (now - createdAt) / (1000 * 60 * 60);

        return hoursDiff <= 3;
    } catch (error) {
        return false;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö –æ—Ç–∑—ã–≤–æ–≤
async function migrateLegacyReviews() {
    try {
        console.log('–ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é legacy-–æ—Ç–∑—ã–≤–æ–≤...');

        const response = await fetch('/api/migrate_legacy_reviews', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_token: userToken,
                device_fingerprint: getDeviceFingerprint()
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
            setTimeout(() => {
                loadReviews();
            }, 500);

            return true;
        } else {
            console.error('–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:', data);
            return false;
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏:', error);
        return false;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
function getTimeLeftMessage(review) {
    const createdAt = new Date(review.created_at);
    const now = new Date();
    const hoursDiff = (now - createdAt) / (1000 * 60 * 60);

    const editTimeLeft = 3 - hoursDiff;
    const deleteTimeLeft = 6 - hoursDiff;

    if (editTimeLeft > 0) {
        return `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${Math.ceil(editTimeLeft)}—á | –£–¥–∞–ª–µ–Ω–∏–µ: ${Math.ceil(deleteTimeLeft)}—á`;
    } else if (deleteTimeLeft > 0) {
        return `–£–¥–∞–ª–µ–Ω–∏–µ: ${Math.ceil(deleteTimeLeft)}—á`;
    } else {
        return '–í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏–π –∏—Å—Ç–µ–∫–ª–æ';
    }
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
function checkDeletePermissionSync(review) {
    try {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º
        if (!checkIsAuthor(review)) {
            return false;
        }

        // Legacy –æ—Ç–∑—ã–≤—ã –Ω–µ–ª—å–∑—è —É–¥–∞–ª—è—Ç—å
        if (review.user_token.startsWith('legacy_token_')) {
            return false;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è (6 —á–∞—Å–æ–≤)
        const createdAt = new Date(review.created_at);
        const now = new Date();
        const hoursDiff = (now - createdAt) / (1000 * 60 * 60);

        return hoursDiff <= 6;
    } catch (error) {
        return false;
    }
}

    // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤
    const review = {
        id: Date.now(),
        name: name,
        rating: selectedRating,
        comment: comment,
        likes: 0,
        dislikes: 0,
        userVoted: null // 'like', 'dislike' –∏–ª–∏ null
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function addEditButtonToModal(modal, reviewData) {
    console.log('Adding edit button for review:', reviewData);

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldEditBtn = modal.querySelector('.edit-review-btn');
    if (oldEditBtn) {
        oldEditBtn.remove();
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–∂–Ω–æ –ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤
    const canEdit = checkEditPermission(reviewData);
    console.log('Can edit:', canEdit);

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫
    let buttonsContainer = modal.querySelector('.modal-buttons-container');
    if (!buttonsContainer) {
        buttonsContainer = document.createElement('div');
        buttonsContainer.className = 'modal-buttons-container';
        modal.querySelector('.modal-content').appendChild(buttonsContainer);
    }

    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const editButton = document.createElement('button');
    editButton.className = `edit-review-btn ${canEdit ? '' : 'disabled'}`;
    editButton.innerHTML = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    editButton.dataset.reviewId = reviewData.id;

    if (canEdit) {
        editButton.onclick = () => {
            console.log('Edit button clicked for review:', reviewData.id);
            openEditReviewModal(reviewData.id, reviewData.rating, reviewData.comment);
        };
    } else {
        editButton.onclick = () => {
            console.log('Edit button clicked but disabled for review:', reviewData.id);
            showEditTimeExpiredMessage(reviewData);
        };
        editButton.title = '–í—Ä–µ–º—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
    }

    buttonsContainer.appendChild(editButton);
    console.log('Edit button added:', editButton);
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function showEditTimeExpiredMessage(review) {
    const createdAt = new Date(review.created_at);
    const now = new Date();
    const hoursDiff = (now - createdAt) / (1000 * 60 * 60);

    let message;

    if (hoursDiff > 3) {
        message = '–£ —Ç–µ–±—è –±—ã–ª–æ 3 —á–∞—Å–∞ —á—Ç–æ–±—ã –≤—Å—ë –∏—Å–ø—Ä–∞–≤–∏—Ç—å. –í—Ä–µ–º—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ!';
    } else if (review.user_token !== userToken) {
        message = '–≠—Ç–æ –Ω–µ —Ç–≤–æ–π –æ—Ç–∑—ã–≤! –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.';
    } else if (!isSameDevice(review)) {
        message = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≥–æ –∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞!';
    } else {
        message = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –ø—Ä–∏—á–∏–Ω–µ.';
    }


    // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
    const editButton = document.querySelector('#full-review-modal .edit-review-btn');
    if (editButton) {
        editButton.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
            editButton.style.animation = '';
        }, 500);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
function updateCountersManually() {
    const modal = document.getElementById('full-review-modal');
    if (!modal) return;

    const reviewId = modal.dataset.reviewId;
    if (!reviewId) return;

    const reviewElement = document.querySelector(`.review-card[data-review-id="${reviewId}"]`);
    const reviewData = reviews.find(r => r.id == reviewId);

    if (reviewData) {
        const likeCountElem = modal.querySelector('.like-count');
        const dislikeCountElem = modal.querySelector('.dislike-count');

        if (likeCountElem) likeCountElem.textContent = reviewData.likes || 0;
        if (dislikeCountElem) dislikeCountElem.textContent = reviewData.dislikes || 0;

        if (reviewElement) {
            reviewElement.dataset.likes = reviewData.likes || 0;
            reviewElement.dataset.dislikes = reviewData.dislikes || 0;
        }
    }
}

// –í—ã–∑–æ–≤–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã —Ç–µ–∫—Å—Ç–∞
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã –¥–ª–∏–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
function limitCommentHeight(reviewElement) {
    const container = reviewElement.querySelector('.comment-container');
    const text = reviewElement.querySelector('.comment-text');
    const blur = reviewElement.querySelector('.comment-blur');

    if (text.scrollHeight > text.clientHeight) {
        blur.style.display = 'block';
    } else {
        blur.style.display = 'none';
    }
}

    // –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    let overallRating = 0;
    let ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç–∑—ã–≤–æ–≤
    function updateRatingBars() {
        const totalReviews = reviews.length;
        for (let i = 1; i <= 5; i++) {
            const count = ratingCounts[i];
            const percentage = totalReviews === 0 ? 0 : (count / totalReviews) * 100;
            const bar = document.querySelector(`.rating-bar:nth-child(${6 - i}) .fill`);
            const countSpan = document.querySelector(`.rating-bar:nth-child(${6 - i}) span:last-child`);
            bar.style.width = `${percentage}%`;
            countSpan.textContent = count;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –æ—Ç–∑—ã–≤–æ–≤
function scrollReviews(direction) {
    const reviewList = document.getElementById('review-list');
    const scrollAmount = 320; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

    if (direction === 'left') {
        reviewList.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    } else {
        reviewList.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    setTimeout(updateScrollButtons, 350);
}

function updateScrollButtons() {
    const reviewList = document.getElementById('review-list');
    const leftButton = document.querySelector('.scroll-button.left');
    const rightButton = document.querySelector('.scroll-button.right');

    if (!reviewList || !leftButton || !rightButton) {
        console.log('Scroll elements not found');
        return;
    }

    // –ñ–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ tick'–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM
    setTimeout(() => {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º—ã–µ –æ—Ç–∑—ã–≤—ã
            const visibleReviews = Array.from(reviewList.children).filter(card =>
                card.style.display !== 'none' && window.getComputedStyle(card).display !== 'none'
            );

            const hasVisibleReviews = visibleReviews.length > 0;
            const canScroll = reviewList.scrollWidth > reviewList.clientWidth + 2; // +2 –¥–ª—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏

            console.log('Scroll state:', {
                visibleReviews: visibleReviews.length,
                scrollWidth: reviewList.scrollWidth,
                clientWidth: reviewList.clientWidth,
                canScroll: canScroll,
                scrollLeft: reviewList.scrollLeft
            });

            if (hasVisibleReviews && canScroll) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                leftButton.style.display = 'flex';
                rightButton.style.display = 'flex';

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
                const canScrollLeft = reviewList.scrollLeft > 5;
                const canScrollRight = reviewList.scrollLeft + reviewList.clientWidth < reviewList.scrollWidth - 5;

                leftButton.style.opacity = canScrollLeft ? '1' : '0.3';
                rightButton.style.opacity = canScrollRight ? '1' : '0.3';
                leftButton.style.pointerEvents = canScrollLeft ? 'auto' : 'none';
                rightButton.style.pointerEvents = canScrollRight ? 'auto' : 'none';
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                leftButton.style.display = 'none';
                rightButton.style.display = 'none';
            }
        } catch (error) {
            console.error('Error in updateScrollButtons:', error);
        }
    }, 50);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
function updateReviewVisibility() {
    const reviewList = document.getElementById('review-list');
    if (!reviewList) return;

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä–æ–ª–ª
    setTimeout(() => {
        updateScrollButtons();
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 500ms
        setTimeout(updateScrollButtons, 500);
    }, 100);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç—Ä–µ–ª–æ—á–µ–∫ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
reviewList.addEventListener('scroll', function() {
    const leftButton = document.querySelector('.scroll-button.left');
    const rightButton = document.querySelector('.scroll-button.right');

    if (!leftButton || !rightButton) return;

    const canScrollLeft = this.scrollLeft > 0;
    const canScrollRight = this.scrollLeft + this.clientWidth < this.scrollWidth - 1;

    leftButton.style.opacity = canScrollLeft ? '1' : '0.5';
    leftButton.style.pointerEvents = canScrollLeft ? 'auto' : 'none';

    rightButton.style.opacity = canScrollRight ? '1' : '0.5';
    rightButton.style.pointerEvents = canScrollRight ? 'auto' : 'none';
});

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞
function expandReview(reviewId) {
    const review = reviews.find(r => r.id === reviewId);
    if (!review) return;

    const modal = document.getElementById('full-review-modal');
    modal.querySelector('.review-name').textContent = review.username;
    modal.querySelector('.review-rating').innerHTML =
        `${'<img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/baka.png') }}" alt="‚òÖ" style="width:20px;height:20px;">'.repeat(review.rating)}`;
    modal.querySelector('.review-comment').textContent = review.comment;
    modal.style.display = 'flex';
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentUser = null; // –î–æ–ª–∂–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
let currentRestaurant = {
    id: 'lambs',
    name: '–ë–∞—Ä–∞—à–∫–∏'
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–∂–Ω–æ –ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤
function checkReviewEditAbility(review) {
    if (!review.can_edit) return false;

    const createdAt = new Date(review.created_at);
    const now = new Date();
    const hoursDiff = (now - createdAt) / (1000 * 60 * 60);

    return hoursDiff <= 3;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∏ –æ—Ç–∑—ã–≤–æ–≤
async function loadRestaurantData() {
    try {
        const response = await fetch(`/api/restaurants/${currentRestaurant.id}`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
        updateRestaurantRating(data.restaurant.rating, data.restaurant.review_count);

        // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤—ã
        document.getElementById('reviews-list').innerHTML = '';
        data.reviews.forEach(review => {
            addReviewToUI(review);
        });
    } catch (error) {
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
function updateRestaurantRating(rating, count) {
    if (rating) {
        document.querySelector('.overall-rating .rating-value').textContent = rating.toFixed(1);
        document.querySelector('.restaurant-rating .rating-value').textContent = rating.toFixed(1);
    }
    if (count) {
        document.querySelector('.overall-rating .reviews-count').textContent = `${count} –æ—Ç–∑—ã–≤–æ–≤`;
    }
}

function addReviewToUI(review) {
    const reviewsContainer = document.getElementById('review-list');

    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤", –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    const noReviewsMsg = reviewsContainer.querySelector('.no-reviews');
    if (noReviewsMsg) {
        noReviewsMsg.remove();
    }

    const reviewElement = document.createElement('div');
    reviewElement.className = 'review-card';
    reviewElement.dataset.reviewId = review.id;

    reviewElement.innerHTML = `
        <div class="review-header">
            <img class="avatar" src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/avatar.png') }}" alt="–ê–≤–∞—Ç–∞—Ä">
            <div class="name-rating">
                <div class="name">${review.username}</div>
                <div class="rating">
                    ${'<img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/baka.png') }}" alt="‚òÖ">'.repeat(review.rating)}
                    ${'<img src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/star.png') }}" alt="‚òÖ">'.repeat(5 - review.rating)}
                </div>
            </div>
        </div>
        <div class="comment-container">
            <div class="comment-text">${review.comment || ''}</div>
        </div>
        <div class="review-actions">
            <button class="like-btn" onclick="rateReview(true, ${review.id})">
                <img src="/static/–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–õ–∞–π–∫.png" alt="–õ–∞–π–∫">
                <span class="like-count">${review.likes || 0}</span>
            </button>
            <button class="dislike-btn" onclick="rateReview(false, ${review.id})">
                <img src="/static/–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–î–∏–∑–ª–∞–π–∫.png" alt="–î–∏–∑–ª–∞–π–∫">
                <span class="dislike-count">${review.dislikes || 0}</span>
            </button>

            ${checkEditPermission(review) ? `
            <button class="edit-btn" onclick="openEditReviewModal(${review.id}, ${review.rating}, '${review.comment}')">
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
            ` : ''}
        </div>
        <div class="review-date">${new Date(review.created_at).toLocaleString()}</div>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ—Ç–∑—ã–≤ –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
    reviewsContainer.insertBefore(reviewElement, reviewsContainer.firstChild);

    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
    reviewElement.style.opacity = '0';
    setTimeout(() => {
        reviewElement.style.transition = 'opacity 0.3s ease';
        reviewElement.style.opacity = '1';
    }, 10);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –æ—Ç–∑—ã–≤–∞
function updateReviewInUI(reviewId, updatedData) {
    console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è –æ—Ç–∑—ã–≤–∞:', reviewId, '—Å –¥–∞–Ω–Ω—ã–º–∏:', updatedData);

    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –æ—Ç–∑—ã–≤–∞ –≤ —Å–ø–∏—Å–∫–µ - –û–°–ù–û–í–ù–û–ï!
    const reviewElement = document.querySelector(`.review-card[data-review-id="${reviewId}"]`);
    if (reviewElement) {
        console.log('–ù–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç –æ—Ç–∑—ã–≤–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        if (updatedData.comment !== undefined) {
            const commentElement = reviewElement.querySelector('.comment-text');
            if (commentElement) {
                commentElement.textContent = updatedData.comment;
                console.log('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω:', updatedData.comment);
            }
        }

        // –û–ë–ù–û–í–õ–Ø–ï–ú –†–ï–ô–¢–ò–ù–ì - –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï!
        if (updatedData.rating !== undefined) {
            const ratingElement = reviewElement.querySelector('.review-rating');
            if (ratingElement) {
                // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∑–≤–µ–∑–¥
                const newStarsHTML = createStarsHTML(updatedData.rating);
                console.log('–ù–æ–≤—ã–µ –∑–≤–µ–∑–¥—ã:', newStarsHTML);

                ratingElement.innerHTML = newStarsHTML;
                console.log('–†–µ–π—Ç–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ UI:', updatedData.rating);
            }
        }

        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        reviewElement.style.transition = 'all 0.3s ease';
        reviewElement.style.backgroundColor = '#f0fff0';
        setTimeout(() => {
            reviewElement.style.backgroundColor = '';
        }, 1000);
    } else {
        console.log('–≠–ª–µ–º–µ–Ω—Ç –æ—Ç–∑—ã–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫');
    }

    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
    const fullModal = document.getElementById('full-review-modal');
    if (fullModal && fullModal.dataset.reviewId == reviewId) {
        console.log('–û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–∫—Ä—ã—Ç–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');

        if (updatedData.comment !== undefined) {
            const commentElement = fullModal.querySelector('.review-comment');
            if (commentElement) {
                commentElement.textContent = updatedData.comment;
            }
        }

        if (updatedData.rating !== undefined) {
            const ratingElement = fullModal.querySelector('.review-rating');
            if (ratingElement) {
                ratingElement.innerHTML = createStarsHTML(updatedData.rating);
            }
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTML –∑–≤–µ–∑–¥
function createStarsHTML(rating) {
    console.log('createStarsHTML –≤—ã–∑–≤–∞–Ω–∞ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º:', rating);

    let starsHTML = '';
    for (let i = 0; i < 5; i++) {
        if (i < rating) {
            starsHTML += `<img src="${PATHS.starActive}" alt="‚òÖ" style="width:20px;height:20px;">`;
            console.log(`–ó–≤–µ–∑–¥–∞ ${i+1}: –∞–∫—Ç–∏–≤–Ω–∞—è`);
        } else {
            starsHTML += `<img src="${PATHS.starInactive}" alt="‚òÖ" style="width:20px;height:20px;">`;
            console.log(`–ó–≤–µ–∑–¥–∞ ${i+1}: –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è`);
        }
    }

    console.log('–ò—Ç–æ–≥–æ–≤—ã–π HTML –∑–≤–µ–∑–¥:', starsHTML);
    return starsHTML;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–∞ –≤ –ë–î
async function checkReviewInDB(reviewId) {
    try {
        const response = await fetch(`/api/reviews?restaurant_id=${currentRestaurantId}`);
        const allReviews = await response.json();

        const targetReview = allReviews.find(r => r.id === reviewId);
        if (targetReview) {
            console.log('=== –ü–†–û–í–ï–†–ö–ê –û–¢–ó–´–í–ê –ò–ó –ë–î ===');
            console.log('ID:', targetReview.id);
            console.log('Username:', targetReview.username);
            console.log('User token –≤ –ë–î:', targetReview.user_token);
            console.log('Device fingerprint –≤ –ë–î:', targetReview.device_fingerprint);
            console.log('============================');
            return targetReview;
        } else {
            console.log('–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î');
            return null;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ:', error);
        return null;
    }
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
function debugReviewData(reviewId) {
    const review = reviews.find(r => r.id == reviewId);
    if (!review) {
        console.log('–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –º–∞—Å—Å–∏–≤–µ reviews');
        return;
    }

    console.log('=== –î–ê–ù–ù–´–ï –û–¢–ó–´–í–ê ===');
    console.log('ID:', review.id);
    console.log('Username:', review.username);
    console.log('User token –≤ –æ—Ç–∑—ã–≤–µ:', review.user_token);
    console.log('–¢–µ–∫—É—â–∏–π user token:', userToken);
    console.log('–°–æ–≤–ø–∞–¥–∞—é—Ç?:', review.user_token === userToken);
    console.log('Device fingerprint –≤ –æ—Ç–∑—ã–≤–µ:', review.device_fingerprint);
    console.log('–¢–µ–∫—É—â–∏–π device fingerprint:', getDeviceFingerprint());
    console.log('========================');
}

function removeReviewFromUI(reviewId) {
    const reviewElement = document.querySelector(`.review-card[data-review-id="${reviewId}"]`);
    if (reviewElement) {
        reviewElement.classList.add('fade-out');
        setTimeout(() => reviewElement.remove(), 300);
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
async function checkCanEditReview(reviewId) {
    try {
        const response = await fetch(`/api/reviews/${reviewId}/can_edit?user_token=${userToken}&device_fingerprint=${getDeviceFingerprint()}`);
        const data = await response.json();

        return data;
    } catch (error) {
        console.error('Error checking edit permission:', error);
        return { can_edit: false, reason: '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏' };
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —É–¥–∞–ª–µ–Ω–∏—è (6 —á–∞—Å–æ–≤)
function canDeleteReview(review) {
    try {
        const createdAt = new Date(review.created_at);
        const now = new Date();
        const hoursDiff = (now - createdAt) / (1000 * 60 * 60);

        return hoursDiff <= 6;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –≤—Ä–µ–º–µ–Ω–∏ —É–¥–∞–ª–µ–Ω–∏—è:', error);
        return false;
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (3 —á–∞—Å–∞) - —É–∂–µ –µ—Å—Ç—å, –æ—Å—Ç–∞–≤–ª—è–µ–º
function canEditReview(review) {
    try {
        const createdAt = new Date(review.created_at);
        const now = new Date();
        const hoursDiff = (now - createdAt) / (1000 * 60 * 60);

        return hoursDiff <= 3;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
        return false;
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function updateEditButtons() {
    reviews.forEach(review => {
        const canEdit = canEditReview(review);
        const reviewElement = document.querySelector(`.review-card[data-review-id="${review.id}"]`);

        if (reviewElement) {
            const editButton = reviewElement.querySelector('.edit-review-btn');
            if (editButton) {
                if (canEdit) {
                    editButton.style.display = 'block';
                    editButton.disabled = false;
                    editButton.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤';
                } else {
                    editButton.style.display = 'none'; // –∏–ª–∏ 'block' —Å –¥—Ä—É–≥–∏–º —Å—Ç–∏–ª–µ–º
                    editButton.disabled = true;
                    editButton.title = '–í—Ä–µ–º—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ (3 —á–∞—Å–∞)';
                }
            }
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–≤–µ–∑–¥ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
function updateEditStars(rating) {
    const stars = document.querySelectorAll('#edit-stars .star');
    stars.forEach((star, index) => {
        const starValue = index + 1;
        const starImage = starValue <= rating ? PATHS.starActive : PATHS.starInactive;
        star.innerHTML = `<img src="${starImage}" alt="‚òÖ" style="width:24px;height:24px;">`;
    });
}

// –£–°–ò–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function openEditReviewModal(reviewId, currentRating, currentComment) {
    console.log('=== –ü–û–ü–´–¢–ö–ê –û–¢–ö–†–´–¢–ò–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ===');

    const review = reviews.find(r => r.id == reviewId);
    if (!review) {
        return;
    }

    // –î–í–û–ô–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä
    if (!checkIsAuthor(review)) {
        console.log('Permission denied: user is not author');
        return;
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
    if (!checkEditPermissionSync(review)) {
        console.log('Permission denied: edit time expired');
        return;
    }

    console.log('Opening edit modal for review:', { reviewId, currentRating, currentComment });

    const modal = document.getElementById('edit-review-modal');
    if (!modal) {
        console.error('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç–∑—ã–≤–∞
    modal.dataset.reviewId = reviewId;
    document.getElementById('edit-review-id').value = reviewId;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥
    editRating = currentRating;
    updateEditStars(currentRating);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    document.getElementById('edit-comment').value = currentComment || '';

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.getElementById('edit-user-token').value = userToken;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modal.style.display = 'flex';

    console.log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–æ');
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
document.getElementById('edit-review-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const modal = document.getElementById('edit-review-modal');
    const reviewId = modal.dataset.reviewId;

    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–≤–µ–∑–¥)
    const rating = modal.querySelectorAll('.star img[src*="baka.png"]').length;
    const comment = modal.querySelector('#edit-comment').value;

    try {
        const response = await fetch(`/api/reviews/${reviewId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                rating: rating,
                comment: comment,
                user_token: userToken,
                device_fingerprint: getDeviceFingerprint()
            })
        });

        const data = await response.json();

        if (response.ok) {
            closeEditModal();

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–∑—ã–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
            const reviewIndex = reviews.findIndex(r => r.id == reviewId);
            if (reviewIndex !== -1) {
                reviews[reviewIndex].rating = rating;
                reviews[reviewIndex].comment = comment;
                reviews[reviewIndex].updated_at = new Date().toISOString();
            }

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadReviews();
            initStats();
        } else {
        }
    } catch (error) {
    }
});

// –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function closeEditModal() {
    document.getElementById('edit-review-modal').style.display = 'none';
    editRating = 0;
}

// –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
function startEditTimer(secondsLeft) {
    const timerElement = document.getElementById('edit-timer');
    if (!timerElement) {
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Ç–∞–π–º–µ—Ä–∞ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        const modalContent = document.querySelector('#edit-review-modal .modal-content');
        const timer = document.createElement('div');
        timer.id = 'edit-timer';
        timer.style.cssText = 'text-align: center; margin: 10px 0; color: #666; font-size: 14px;';
        modalContent.insertBefore(timer, modalContent.querySelector('form'));
    }

    let timeLeft = secondsLeft;

    const timerInterval = setInterval(() => {
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            document.getElementById('edit-timer').textContent = '–í—Ä–µ–º—è –≤—ã—à–ª–æ!';
            document.querySelector('#edit-review-form button').disabled = true;
            return;
        }

        const hours = Math.floor(timeLeft / 3600);
        const minutes = Math.floor((timeLeft % 3600) / 60);
        const seconds = Math.floor(timeLeft % 60);

        document.getElementById('edit-timer').textContent =
            `–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏: ${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        timeLeft--;
    }, 1000);
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
async function submitEditReview(e) {
    if (e) e.preventDefault();

    console.log('=== –ù–ê–ß–ê–õ–û –û–ë–†–ê–ë–û–¢–ö–ò –°–û–•–†–ê–ù–ï–ù–ò–Ø –û–¢–ó–´–í–ê ===');

    const modal = document.getElementById('edit-review-modal');
    const reviewId = modal.dataset.reviewId;
    const comment = document.getElementById('edit-comment').value.trim();

    if (!reviewId) {
        return;
    }

    if (editRating === 0) {
        return;
    }

    console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', {
        reviewId: reviewId,
        rating: editRating,
        comment: comment
    });

    const requestData = {
        rating: editRating,
        comment: comment,
        user_token: userToken,
        device_fingerprint: getDeviceFingerprint()
    };

    try {
        showLoadingIndicator();

        const response = await fetch(`/api/reviews/${reviewId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        const data = await response.json();
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, data);

        if (response.ok) {
            closeEditModal();

            // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞, –∞ –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            if (data.review) {
                console.log('–î–∞–Ω–Ω—ã–µ –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞:', data.review);

                // –û–ë–ù–û–í–õ–Ø–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ú–ê–°–°–ò–í –û–¢–ó–´–í–û–í –° –í–°–ï–ú–ò –ü–û–õ–Ø–ú–ò
                updateReviewData(reviewId, data.review);

                // –ù–ï–ú–ï–î–õ–ï–ù–ù–û –û–ë–ù–û–í–õ–Ø–ï–ú UI –ë–ï–ó –û–ñ–ò–î–ê–ù–ò–Ø
                updateReviewInUI(reviewId, data.review);

                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                setTimeout(() => {
                    initStats();
                }, 100);
            }

        } else {
            throw new Error(data.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
    } finally {
        hideLoadingIndicator();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –æ—Ç–∑—ã–≤–∞
function refreshReviewElement(reviewId, newRating) {
    const reviewElement = document.querySelector(`.review-card[data-review-id="${reviewId}"]`);
    if (!reviewElement) return;

    // –ù–∞—Ö–æ–¥–∏–º –æ—Ç–∑—ã–≤ –≤ –º–∞—Å—Å–∏–≤–µ
    const reviewIndex = reviews.findIndex(r => r.id == reviewId);
    if (reviewIndex === -1) return;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –≤ –¥–∞–Ω–Ω—ã—Ö
    reviews[reviewIndex].rating = newRating;

    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
    const newReviewElement = createReviewElement(reviews[reviewIndex]);

    // –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–æ–≤—ã–º
    reviewElement.parentNode.replaceChild(newReviewElement, reviewElement);

    console.log('–≠–ª–µ–º–µ–Ω—Ç –æ—Ç–∑—ã–≤–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª–µ–Ω —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º:', newRating);
}

// –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
function setEditRating(rating) {
    editRating = rating;

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–≤–µ–∑–¥ - –ò–°–ü–†–ê–í–õ–Ø–ï–ú –ü–£–¢–ò!
    const stars = document.querySelectorAll('#edit-stars .star');
    stars.forEach((star, index) => {
        const starValue = index + 1;
        // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∏–∑ PATHS
        const starImage = starValue <= rating ? PATHS.starActive : PATHS.starInactive;
        star.innerHTML = `<img src="${starImage}" alt="‚òÖ" style="width:24px;height:24px;">`;
    });

    console.log('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–µ–π—Ç–∏–Ω–≥:', rating);
}

function closeEditReviewModal() {
    document.getElementById('edit-review-modal').style.display = 'none';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–ª–∂–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∏–∑ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
    currentUser = 1; // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    loadRestaurantData();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞
    document.getElementById('edit-review-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const reviewId = this.dataset.reviewId;
        const rating = this.querySelectorAll('.star.filled').length;
        const comment = this.querySelector('textarea').value;

        closeEditReviewModal();
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                if (this.id === 'review-modal') closeReviewModal();
                if (this.id === 'edit-review-modal') closeEditReviewModal();
            }
        });
    });
});

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å–∏—Å—Ç–µ–º—ã –æ—Ü–µ–Ω–æ–∫
// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å–∏—Å—Ç–µ–º—ã –æ—Ü–µ–Ω–æ–∫
function debugRatingSystem(reviewId) {
    console.log('=== –î–ï–ë–ê–ì –°–ò–°–¢–ï–ú–´ –û–¶–ï–ù–û–ö ===');
    const review = reviews.find(r => r.id == reviewId);
    if (review) {
        console.log('–û—Ç–∑—ã–≤:', {
            id: review.id,
            username: review.username,
            likes: review.likes,
            dislikes: review.dislikes,
            user_ratings: review.user_ratings,
            current_user_rating: review.user_ratings?.[userToken]
        });
    } else {
        console.log('–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ');
    }
    console.log('–¢–µ–∫—É—â–∏–π userToken:', userToken);
    console.log('–í—Å–µ –æ—Ç–∑—ã–≤—ã –≤ –º–∞—Å—Å–∏–≤–µ:', reviews.map(r => ({id: r.id, rating: r.rating})));
    console.log('============================');
}

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ç–µ–∫—É—â–∏—Ö –ª–∏–º–∏—Ç–æ–≤
function debugReviewLimits() {
    const reviewLimits = JSON.parse(localStorage.getItem('reviewLimits')) || {};
    console.log('=== –¢–ï–ö–£–©–ò–ï –õ–ò–ú–ò–¢–´ –û–¢–ó–´–í–û–í ===');
    console.log('User token:', userToken);
    console.log('Current restaurant ID:', currentRestaurantId);
    console.log('All limits:', reviewLimits);

    if (reviewLimits[userToken]) {
        const userLimit = reviewLimits[userToken];
        console.log('User limit:', {
            lastReviewDate: new Date(userLimit.lastReviewDate).toLocaleString(),
            restaurantId: userLimit.restaurantId,
            isSameRestaurant: userLimit.restaurantId === currentRestaurantId
        });
    }
    console.log('Can post review:', canUserPostReview(currentRestaurantId));
    console.log('==============================');
}

        function debugLocalStorage() {
    console.log('=== DEBUG LOCALSTORAGE ===');
    console.log('userToken:', localStorage.getItem('userToken'));

    const reviewLimits = JSON.parse(localStorage.getItem('reviewLimits')) || {};
    console.log('reviewLimits:', reviewLimits);

    const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    console.log('favorites count:', favorites.length);

    console.log('currentRestaurantId:', currentRestaurantId);
    console.log('==========================');
}

        function testReviewLimits() {
    console.log('=== –¢–ï–°–¢ –°–ò–°–¢–ï–ú–´ –õ–ò–ú–ò–¢–û–í ===');

    const testRestaurants = ['Lambs', 'Gurmetto', 'Brewmen'];

    testRestaurants.forEach(restaurantId => {
        const canPost = canUserPostReview(restaurantId);
        const timeLeft = getTimeUntilNextReview(restaurantId);

        console.log(`–†–µ—Å—Ç–æ—Ä–∞–Ω "${restaurantId}":`, {
            canPost: canPost,
            timeLeft: timeLeft,
            formattedTime: formatTimeUntilNextReview(restaurantId)
        });
    });

    console.log('============================');
}

        // üî• –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–æ–≤
function debugLimitsDetailed() {
    const reviewLimits = JSON.parse(localStorage.getItem('reviewLimits')) || {};
    const userLimit = reviewLimits[userToken];

    console.log('=== –î–ï–¢–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –õ–ò–ú–ò–¢–û–í ===');
    console.log('User token:', userToken);
    console.log('Current restaurant:', currentRestaurantId);
    console.log('All limits:', reviewLimits);

    if (userLimit) {
        const lastReviewDate = new Date(userLimit.lastReviewDate);
        const now = new Date();
        const hoursDiff = (now - lastReviewDate) / (1000 * 60 * 60);

        console.log('User limit details:', {
            restaurant: userLimit.restaurantId,
            lastReview: lastReviewDate.toLocaleString(),
            hoursPassed: hoursDiff.toFixed(2),
            canPost: hoursDiff >= 24,
            isCurrentRestaurant: userLimit.restaurantId === currentRestaurantId
        });
    } else {
        console.log('‚úÖ No active limits for user');
    }
    console.log('================================');
}

        // üî• –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤
function fixLimitsAfterDelete(restaurantId) {
    console.log('üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è...');

    const reviewLimits = JSON.parse(localStorage.getItem('reviewLimits')) || {};
    const userLimit = reviewLimits[userToken];

    console.log('üìä –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', userLimit);

    // –ï—Å–ª–∏ –ª–∏–º–∏—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ - —É–¥–∞–ª—è–µ–º –µ–≥–æ
    if (userLimit && userLimit.restaurantId === restaurantId) {
        delete reviewLimits[userToken];
        localStorage.setItem('reviewLimits', JSON.stringify(reviewLimits));
        console.log('‚úÖ –õ–∏–º–∏—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–µ–Ω');
        console.log('üìä –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', reviewLimits[userToken]);
    } else {
        console.log('‚úÖ –õ–∏–º–∏—Ç —É–∂–µ —Å–Ω—è—Ç –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
    }
}
</script>
</body>
</html>