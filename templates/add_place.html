<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Добавить место</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        form { max-width: 600px; margin: 20px auto; }
        div { margin-bottom: 15px; }
        label { display: inline-block; width: 150px; }
        input[type="text"], textarea, select { width: 100%; padding: 8px; }
        input[type="text2"] { width: 285px; padding: 8px; }
        input[type="tel"] { width: 100%; padding: 8px; }
        input[type="file"] { width: 100%; padding: 8px; }
        textarea { height: 100px; }
        button { padding: 10px 20px; background: #4CAF50; color: white; border: none; }
        .inline {display: flex;}
        .flex-item {margin-right: 10px;}
        #map { height: 300px; }
    </style>
</head>
<body>
    <h1>Добавить новое место</h1>
    <form method="post" enctype="multipart/form-data">
        <div>
            <label>Название:</label>
            <input type="text" name="title">
        </div>

        <div>
            <label>Описание:</label>
            <textarea name="description"></textarea>
        </div>

        <!-- Шаг №1: Объединение широты и долготы -->
        <!-- Блок карты -->
        <div>
            <label>Координаты:</label>
            <div class="map-instructions">
                ⚡ Нажмите на карту, чтобы выбрать местоположение. Метка появится автоматически.
            </div>
            <div id="map"></div>

            <!-- Сообщение об успехе -->
            <div id="successMessage" class="success-message">
                ✅ Метка успешно поставлена! Координаты сохранены.
            </div>

            <!-- Отображение координат -->
            <div id="coordinatesDisplay" class="coordinates-display" style="display: none;">
                <strong>Текущие координаты:</strong>
                <span id="currentCoords"></span>
            </div>

            <input type="hidden" name="latitude" id="latInput">
            <input type="hidden" name="longitude" id="lonInput">
        </div>

        <div>
            <label>Телефон:</label>
            <input type="tel" name="telephone">
        </div>

        <!-- Шаг №2: Ограничение описания времени работы до трёх строк -->
        <div>
            <label>Время работы:</label>
            <textarea name="working_hours" placeholder="Пн-Чт: 12:00-23:00<br>Пт-Вс: 12:00-00:00" rows="3"></textarea>
        </div>

        <div>
            <label>Адрес:</label>
            <input type="text" name="address">
        </div>

        <!-- Шаг №3: Объединение загрузки изображения и полей тегов -->
        <div class="inline">
            <div class="flex-item">
                <span class="help-icon" title="Вводите теги через запятую без пробелов. Например: Ресторан,Доставка,Европейская кухня">❓</span>
                <label>Теги:</label><br />
                <input type="text2" name="tags" class="tags-input">
            </div>
            <div class="flex-item">
                <label>Изображение:</label><br />
                <input type="file" name="image" accept="image/*">
            </div>
        </div>

        <div>
            <label>Меню (JSON формат):</label>
            <textarea name="menu" placeholder='{"Основные блюда": [{"name": "Борщ", "price": "350 руб"}, {"name": "Пельмени", "price": "280 руб"}]}' rows="5"></textarea>
            <small style="color: #666;">
                ⚠️ Формат: {"Категория": [{"name": "Название", "price": "Цена"}, ...]}
            </small>
        </div>

        <div>
            <label>Категория:</label>
            <select name="category" required>
                <option value="">-- Выберите категорию --</option>
                {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit">Добавить</button>
    </form>
<!-- Добавляем подключение скрипта Яндекс Карт -->
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<script>
ymaps.ready(init);

function init(){
    var myMap = new ymaps.Map("map", {
        center: [58.5211, 31.2758],
        zoom: 12,
        controls: ['zoomControl', 'fullscreenControl']
    });

    var myPlacemark;

    myMap.events.add('click', function (event) {
        var coords = event.get('coords');
        var lat = coords[0].toFixed(6);
        var lon = coords[1].toFixed(6);

        // Заполняем скрытые поля
        document.getElementById('latInput').value = lat;
        document.getElementById('lonInput').value = lon;

        // Показываем координаты
        document.getElementById('currentCoords').textContent = lat + ', ' + lon;
        document.getElementById('coordinatesDisplay').style.display = 'block';
        document.getElementById('successMessage').style.display = 'block';

        // Удаляем старую метку
        if (myPlacemark) {
            myMap.geoObjects.remove(myPlacemark);
        }

        // Создаем кастомную серую метку с белым кружочком
        myPlacemark = new ymaps.Placemark(coords, {
            hintContent: 'Выбранное местоположение',
            balloonContent: `
                <strong>Координаты:</strong><br>
                Широта: ${lat}<br>
                Долгота: ${lon}
            `
        }, {
            // Кастомная иконка - серая с белым кружочком
            iconLayout: 'default#image',
            iconImageHref: createCustomMarker(), // Создаем SVG метку
            iconImageSize: [30, 30], // Размер метки
            iconImageOffset: [-15, -15], // Смещение чтобы метка была по центру
            balloonCloseButton: true,
            hideIconOnBalloonOpen: false
        });

        myMap.geoObjects.add(myPlacemark);

        // Автоматически открываем подсказку
        myPlacemark.balloon.open();

        myMap.panTo(coords, { duration: 300 });
    });

    // Функция для создания кастомной SVG метки
    function createCustomMarker() {
        // Создаем SVG изображение серой круглой метки с белым кружочком
        var svg = [
            '<svg width="30" height="30" xmlns="http://www.w3.org/2000/svg">',
            '  <!-- Внешний серый круг -->',
            '  <circle cx="15" cy="15" r="14" fill="#808080" stroke="#ffffff" stroke-width="2"/>',
            '  <!-- Внутренний белый круг -->',
            '  <circle cx="15" cy="15" r="6" fill="#ffffff"/>',
            '  <!-- Тень для объема -->',
            '  <circle cx="14" cy="14" r="14" fill="none" stroke="#000000" stroke-width="1" stroke-opacity="0.2"/>',
            '</svg>'
        ].join('');

        // Конвертируем SVG в data URL
        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }
}
</script>
</body>
</html>