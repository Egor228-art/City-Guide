<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        form { max-width: 600px; margin: 20px auto; }
        div { margin-bottom: 15px; }
        label { display: inline-block; width: 150px; }
        input[type="text"], textarea, select { width: 100%; padding: 8px; }
        input[type="text2"] { width: 285px; padding: 8px; }
        input[type="tel"] { width: 100%; padding: 8px; }
        input[type="file"] { width: 100%; padding: 8px; }
        textarea { height: 100px; }
        button { padding: 10px 20px; background: #4CAF50; color: white; border: none; }
        .inline {display: flex;}
        .flex-item {margin-right: 10px;}
        #map { height: 300px; }
        .category-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .category-toggle { background: #f5f5f5; padding: 10px; cursor: pointer; margin-bottom: 10px; }
        .auto-generated { background: #f0f8ff; padding: 8px; border-radius: 4px; margin-top: 5px; font-size: 12px; }
        .success-message { color: green; margin-top: 5px; }
        .coordinates-display { background: #f0f8ff; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ</h1>
    <form method="post" enctype="multipart/form-data" onsubmit="return validateForm()">
        <div>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" name="title" id="title" oninput="generateSlug()" required>
            <div class="auto-generated">
                <strong>Slug (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):</strong>
                <span id="slug-preview">–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏—è</span>
                <input type="hidden" name="slug" id="slug">
            </div>
        </div>

        <div>
            <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea name="description"></textarea>
        </div>

        <!-- –ë–ª–æ–∫ –∫–∞—Ä—Ç—ã -->
        <div>
            <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</label>
            <div class="map-instructions">
                ‚ö° –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ú–µ—Ç–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
            </div>
            <div id="map"></div>

            <div id="successMessage" class="success-message">
                ‚úÖ –ú–µ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞! –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.
            </div>

            <div id="coordinatesDisplay" class="coordinates-display" style="display: none;">
                <strong>–¢–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong>
                <span id="currentCoords"></span>
            </div>

            <input type="hidden" name="latitude" id="latInput">
            <input type="hidden" name="longitude" id="lonInput">
        </div>

        <div>
            <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
            <input type="tel" name="telephone">
        </div>

        <div>
            <label>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</label>
            <textarea name="working_hours" placeholder='{"–ü–Ω-–ß—Ç": "12:00-23:00", "–ü—Ç-–í—Å": "12:00-00:00"}' rows="3"></textarea>
        </div>

        <div>
            <label>–ê–¥—Ä–µ—Å:</label>
            <input type="text" name="address">
        </div>

        <div class="inline">
            <div class="flex-item">
                <span class="help-icon" title="–í–≤–æ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤. –ù–∞–ø—Ä–∏–º–µ—Ä: –†–µ—Å—Ç–æ—Ä–∞–Ω,–î–æ—Å—Ç–∞–≤–∫–∞,–ï–≤—Ä–æ–ø–µ–π—Å–∫–∞—è –∫—É—Ö–Ω—è">‚ùì</span>
                <label>–¢–µ–≥–∏:</label><br />
                <input type="text2" name="tags" placeholder='–†–µ—Å—Ç–æ—Ä–∞–Ω,–î–æ—Å—Ç–∞–≤–∫–∞,–ï–≤—Ä–æ–ø–µ–π—Å–∫–∞—è –∫—É—Ö–Ω—è' class="tags-input">
            </div>
            <div class="flex-item">
                <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label><br />
                <input type="file" name="image" accept="image/*">
            </div>
        </div>

        <div>
            <label>–ú–µ–Ω—é (JSON —Ñ–æ—Ä–º–∞—Ç):</label>
            <textarea name="menu" placeholder='{"–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞": [{"name": "–ë–æ—Ä—â", "price": "350 —Ä—É–±" "description":"" }, {"name": "–ü–µ–ª—å–º–µ–Ω–∏", "price": "280 —Ä—É–±" "description":"" }], "–ï–¥–∞": [{ "name": "–ë–∏–∑–Ω–µ—Å-–ª–∞–Ω—á", "price": "390 —Ä—É–±", "description": "–ë–∏–∑–Ω–µ—Å-–ª–∞–Ω—á - 2 –±–ª—é–¥–∞ 390 —Ä—É–±, 3 –±–ª—é–¥–∞ 420 —Ä—É–±" }]}}' rows="5"></textarea>
        </div>

        <!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
        <div class="category-section">
            <div class="category-toggle" onclick="toggleCategorySection()">
                üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ ‚ñº
            </div>

            <div id="categorySection">
                <div>
                    <label>–í—ã–±—Ä–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
                    <select name="existing_category" id="existingCategory" onchange="onExistingCategoryChange()">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>
                        {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div style="text-align: center; margin: 10px 0;">
                    <strong>–ò–õ–ò</strong>
                </div>

                <div>
                    <label>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
                    <input type="text" name="new_category" id="newCategory" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" oninput="generateCategoryEn()">
                    <div class="auto-generated">
                        <strong>–ê–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):</strong>
                        <span id="category-en-preview">–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ</span>
                        <input type="hidden" name="category_en" id="categoryEn">
                    </div>
                </div>

                <div class="auto-generated" style="margin-top: 10px;">
                    <strong>–ò—Ç–æ–≥–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:</strong>
                    <span id="final-category-preview">–Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
                </div>
            </div>
        </div>

        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</button>
    </form>

<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ slug –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function generateSlug() {
    const title = document.getElementById('title').value;
    if (!title) {
        document.getElementById('slug-preview').textContent = '–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏—è';
        return;
    }

    // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ –ª–∞—Ç–∏–Ω–∏—Ü—É
    const translitDict = {
        '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'yo',
        '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm',
        '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
        '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sch', '—ä': '',
        '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya'
    };

    let slug = title.toLowerCase();

    // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
    slug = slug.split('').map(char => translitDict[char] || char).join('');

    // –ó–∞–º–µ–Ω–∞ –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –Ω–µ-–±—É–∫–≤–µ–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    slug = slug.replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');

    document.getElementById('slug-preview').textContent = slug;
    document.getElementById('slug').value = slug;
}

function generateCategoryEn() {
    const category = document.getElementById('newCategory').value;
    if (!category) {
        document.getElementById('category-en-preview').textContent = '–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ';
        return;
    }

    // –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    const categoryMapping = {
        '–†–µ—Å—Ç–æ—Ä–∞–Ω': 'restaurant',
        '–ö–∞—Ñ–µ': 'cafe',
        '–ú–∞–≥–∞–∑–∏–Ω': 'shop',
        '–ú—É–∑–µ–π': 'museum',
        '–¢–µ–∞—Ç—Ä': 'theatre',
        '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞': 'library',
        '–ü–∞—Ä–∫': 'park',
        '–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä': 'cinema',
        '–°–ø–æ—Ä—Ç–ø–ª–æ—â–∞–¥–∫–∞': 'sports',
        '–¶–µ—Ä–∫–æ–≤—å': 'church',
        '–ì–æ—Å—Ç–∏–Ω–∏—Ü–∞': 'hotel',
        '–ò–∫–æ–Ω–∫–∞': 'icon'
    };

    let categoryEn;

    // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –µ—Å—Ç—å –≤ —Å–ª–æ–≤–∞—Ä–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥
    if (categoryMapping[category]) {
        categoryEn = categoryMapping[category];
    } else {
        // –ò–Ω–∞—á–µ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä—É–µ–º –∫–∞–∫ slug
        const translitDict = {
            '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'yo',
            '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm',
            '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
            '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sch', '—ä': '',
            '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya'
        };

        categoryEn = category.toLowerCase()
            .split('').map(char => translitDict[char] || char).join('')
            .replace(/[^a-z0-9]/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '');
    }

    document.getElementById('category-en-preview').textContent = categoryEn;
    document.getElementById('categoryEn').value = categoryEn;
    updateFinalCategoryPreview();
}

function onExistingCategoryChange() {
    const selectedCategory = document.getElementById('existingCategory').value;
    if (selectedCategory) {
        document.getElementById('newCategory').value = '';
        document.getElementById('categoryEn').value = '';
        document.getElementById('category-en-preview').textContent = '–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';
    }
    updateFinalCategoryPreview();
}

function updateFinalCategoryPreview() {
    const existingCategory = document.getElementById('existingCategory').value;
    const newCategory = document.getElementById('newCategory').value;

    let finalCategory = '';
    if (existingCategory) {
        finalCategory = `–°—É—â–µ—Å—Ç–≤—É—é—â–∞—è: ${existingCategory}`;
    } else if (newCategory) {
        finalCategory = `–ù–æ–≤–∞—è: ${newCategory}`;
    } else {
        finalCategory = '–Ω–µ –≤—ã–±—Ä–∞–Ω–∞';
    }

    document.getElementById('final-category-preview').textContent = finalCategory;
}

function toggleCategorySection() {
    const section = document.getElementById('categorySection');
    const toggle = document.querySelector('.category-toggle');

    if (section.style.display === 'none') {
        section.style.display = 'block';
        toggle.innerHTML = 'üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ ‚ñº';
    } else {
        section.style.display = 'none';
        toggle.innerHTML = 'üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ ‚ñ∂';
    }
}

function validateForm() {
    const existingCategory = document.getElementById('existingCategory').value;
    const newCategory = document.getElementById('newCategory').value;

    if (!existingCategory && !newCategory) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é');
        return false;
    }

    if (existingCategory && newCategory) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç: –ª–∏–±–æ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –ª–∏–±–æ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é');
        return false;
    }

    return true;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('categorySection').style.display = 'none';
    updateFinalCategoryPreview();
});

// –ö–∞—Ä—Ç–∞ (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
ymaps.ready(init);

function init(){
    var myMap = new ymaps.Map("map", {
        center: [58.5211, 31.2758],
        zoom: 12,
        controls: ['zoomControl', 'fullscreenControl']
    });

    var myPlacemark;

    myMap.events.add('click', function (event) {
        var coords = event.get('coords');
        var lat = coords[0].toFixed(6);
        var lon = coords[1].toFixed(6);

        document.getElementById('latInput').value = lat;
        document.getElementById('lonInput').value = lon;

        document.getElementById('currentCoords').textContent = lat + ', ' + lon;
        document.getElementById('coordinatesDisplay').style.display = 'block';
        document.getElementById('successMessage').style.display = 'block';

        if (myPlacemark) {
            myMap.geoObjects.remove(myPlacemark);
        }

        myPlacemark = new ymaps.Placemark(coords, {
            hintContent: '–í—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ',
            balloonContent: `
                <strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong><br>
                –®–∏—Ä–æ—Ç–∞: ${lat}<br>
                –î–æ–ª–≥–æ—Ç–∞: ${lon}
            `
        }, {
            iconLayout: 'default#image',
            iconImageHref: createCustomMarker(),
            iconImageSize: [30, 30],
            iconImageOffset: [-15, -15],
            balloonCloseButton: true,
            hideIconOnBalloonOpen: false
        });

        myMap.geoObjects.add(myPlacemark);
        myPlacemark.balloon.open();
        myMap.panTo(coords, { duration: 300 });
    });

    function createCustomMarker() {
        var svg = [
            '<svg width="30" height="30" xmlns="http://www.w3.org/2000/svg">',
            '  <circle cx="15" cy="15" r="14" fill="#808080" stroke="#ffffff" stroke-width="2"/>',
            '  <circle cx="15" cy="15" r="6" fill="#ffffff"/>',
            '  <circle cx="14" cy="14" r="14" fill="none" stroke="#000000" stroke-width="1" stroke-opacity="0.2"/>',
            '</svg>'
        ].join('');
        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }
}
</script>
</body>
</html>