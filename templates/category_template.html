<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ category_name }}</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/Style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–ª–æ–≥–æ.png') }}" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
.no-results {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.no-results h3 {
    margin-bottom: 10px;
    font-size: 24px;
}

.no-results p {
    font-size: 16px;
}

    .distance-info {
    display: flex;
    align-items: center;
    gap: 5px;
    margin: 5px 0;
    color: #666;
    font-size: 14px;
}

.distance-info svg {
    width: 16px;
    height: 16px;
    color: #667eea;
}

.rating-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: bold;
    margin-left: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.filters-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 20px;
    margin: 90px auto -30px;
    max-width: 1200px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.filters-header h3 {
    margin: 0;
    color: #333;
    font-size: 1.2rem;
}

.clear-filters {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.clear-filters:hover {
    background: #ff5252;
}

.filter-options {
    left: 0; !important;
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.rating-filter {
    display: flex;
    align-items: center;
    gap: 10px;
}

.rating-filter label {
    font-weight: 500;
    color: #555;
}

.rating-stars-filter {
    display: flex;
    flex-direction: row-reverse;
    gap: 2px;
}

.rating-stars-filter input {
    display: none;
}

.rating-stars-filter label {
    font-size: 24px;
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s ease;
}

.rating-stars-filter input:checked ~ label,
.rating-stars-filter label:hover,
.rating-stars-filter label:hover ~ label {
    color: #ffd700;
}

.rating-stars-filter input:checked + label {
    color: #ffd700;
}

.rating-overlay {
    position: absolute;
    top: 0;
    right: 0;
    padding: 5px 5px;
    border-radius: 15px;
}

.rating-badge {
    color: white;
    font-weight: bold;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.rating-badge::after {
    content: '‚òÖ';
    color: #ffd700;
    font-size: 16px;
}

/* –ï—Å–ª–∏ —Ä–µ–π—Ç–∏–Ω–≥ 0, –¥–µ–ª–∞–µ–º –µ–≥–æ –º–µ–Ω–µ–µ –∑–∞–º–µ—Ç–Ω—ã–º */
.rating-badge[data-rating="0"] {
    opacity: 0.6;
}

.image-wrapper {
    position: relative;
}
</style>
</head>
<body>
    <!-- –í—Å—Ç–∞–≤–ª—è–µ–º —à–∞–ø–∫—É -->
    {% include 'header.html' %}

    <!-- –ü–∞—Ä–∞–ª–ª–∞–∫—Å —Ñ–æ–Ω –∏–∑ –ø–µ—Ä–≤–æ–≥–æ HTML -->
    {% if background_image %}
    <div class="parallax-background">
        <img src="{{ url_for('static', filename=background_image) }}" alt="–§–æ–Ω {{ category_name }}">
    </div>
    {% else %}
    <!-- –ï—Å–ª–∏ —Ñ–æ–Ω–∞ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º -->
    <div class="parallax-background" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div style="text-align: center; padding: 100px 20px; color: white;">
            <h1>{{ category_name }}</h1>
            <p>–õ—É—á—à–∏–µ –º–µ—Å—Ç–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>
        </div>
    </div>
    {% endif %}

    <!-- –£–º–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div class="smart-pagination" id="smartPagination">
        <div class="filters-container-left">
            <div class="filter-options">
                <select id="sortFilter" class="filter-select" onchange="applyFilters()">
                    <option value="default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                    <option value="distance" id="distanceOption">–ë–ª–∏–∂–∞–π—à–∏–π –∫–æ –º–Ω–µ</option>
                    <option value="rating_high">–ù–∞–∏–≤—ã—Å—à–∏–π —Ä–µ–π—Ç–∏–Ω–≥</option>
                    <option value="rating_low">–ù–∏–∑—à–∏–π —Ä–µ–π—Ç–∏–Ω–≥</option>
                    <option value="name_asc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ê-–Ø)</option>
                    <option value="name_desc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–Ø-–ê)</option>
                </select>
            </div>
        </div>
        <div class="pagination-container">
            <ul class="pagination" id="pagination">
                <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </ul>
        </div>
    </div>

     <div class="restaurants-container" id="restaurantsContainer">
        {% if places %}
            {% for place_data in places_with_ratings %}
            {% set place = place_data.place %}
            {% set avg_rating = place_data.avg_rating %}
            {% set review_count = place_data.review_count %}
            {% set restaurant_found = place_data.restaurant_found %}

            <div id="loading" style="display: none; text-align: center; padding: 20px; position: absolute; left: 50%; transform: translateX(-50%);">
                <div class="loading-spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>

            <div class="restaurant-card"
                 data-id="{{ place.id }}"
                 data-rating="{{ avg_rating }}"
                 data-name="{{ place.title | lower if place.title else '' }}"
                 onclick="window.location.href='{% if place.slug %}{{ url_for('place_page_by_slug', category_en=place.category_en, slug=place.slug) }}{% else %}{{ url_for('restaurant_page', id=place.id) }}{% endif %}'">

                <div class="image-wrapper">
                    {% if place.image_path %}
                        <img class="restaurant-image"
                             src="{{ url_for('static', filename=place.image_path) }}"
                             alt="{{ place.title }}">
                    {% else %}
                        <img class="restaurant-image"
                             src="{{ url_for('static', filename='–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/default.png') }}"
                             alt="–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                    {% endif %}

                    <!-- –†–µ–π—Ç–∏–Ω–≥ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ - –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º -->
                    <div class="rating-overlay">
                        <span class="rating-badge">{{ avg_rating | default(0) }}</span>
                    </div>
                </div>

                <div class="restaurant-info">
                    <h3 class="restaurant-name">{{ place.title if place.title else '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ' }}</h3>

                    <p class="restaurant-description">
                        {{ place.description if place.description else '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' }}
                        {% if review_count > 0 %}
                        <br><small>–û—Ç–∑—ã–≤–æ–≤: {{ review_count }}</small>
                        {% endif %}
                    </p>

                    <div class="restaurant-contacts">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                            <span>{{ place.telephone if place.telephone else '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω' }}</span>
                        </div>
                        <div class="metka">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <span>{{ place.address if place.address else '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω' }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ–¥–µ–Ω–∏–π</p>
        {% endif %}
    </div>

    <!-- –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–¥–≤–∞–ª -->
    {% include 'footer.html' %}

    <script>
        // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ JavaScript
        window.currentCategory = '{{ category_en }}';
        console.log('üéØ –¢–µ–∫—É—â–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:', window.currentCategory);
    </script>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—â–∏–π JS -->
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script src="{{ url_for('static', filename='js/category.js') }}"></script>
    <script>
// ==================== –°–ö–†–û–õ–õ–ò–ù–ì ====================
function initScrollSystem() {
    let isScrolling = false;
    let scrollTimer;

    window.addEventListener('scroll', function () {
        if (!isScrolling) {
            isScrolling = true;

            clearTimeout(scrollTimer);
            scrollTimer = setTimeout(() => {
                handleScroll();
                isScrolling = false;
            }, 150);
        }
    });
}

function handleScroll() {
    if (isLoading) return;

    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const scrollHeight = document.documentElement.scrollHeight;
    const clientHeight = window.innerHeight;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏ –º—ã –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (50px –æ—Ç –Ω–∏–∑–∞)
    if (scrollTop + clientHeight >= scrollHeight - 50) {
        if (currentPage < totalPages) {
            console.log(`–î–æ—Å—Ç–∏–≥–Ω—É—Ç –∫–æ–Ω–µ—Ü —Å—Ç—Ä–∞–Ω–∏—Ü—ã: –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É ${currentPage + 1}`);
            goToPage(currentPage + 1);
        }
    }
}
// ==================== –°–ö–†–´–í–ê–Æ–©–ê–Ø–°–Ø –®–ê–ü–ö–ê ====================
function initHeaderScroll() {
    let lastScroll = 0;

    window.addEventListener('scroll', function () {
        const currentScroll = window.pageYOffset;

        if (currentScroll <= 10) {
            navbar.style.transform = 'translateY(0)';
            smartPagination.style.top = '95px';
        } else if (currentScroll > lastScroll) {
            navbar.style.transform = 'translateY(-100%)';
            smartPagination.style.top = '0';
        } else {
            navbar.style.transform = 'translateY(0)';
            smartPagination.style.top = '95px';
        }

        lastScroll = currentScroll;
    });
}

// ==================== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ====================
async function loadAllPlaces() {
    showLoading();

    try {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö...');
        const allPlacesData = [];

        // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å—Ç—Ä–∞–Ω–∏—Ü
        const firstPageResponse = await fetch(`/api/categories/${currentCategory}?page=1`);

        if (!firstPageResponse.ok) {
            throw new Error(`HTTP error! status: ${firstPageResponse.status}`);
        }

        const firstPageData = await firstPageResponse.json();
        console.log('üìä –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö:', firstPageData);

        // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –∏–∑ –æ—Ç–≤–µ—Ç–∞
        const actualTotalPages = firstPageData.total_pages || 1;
        console.log(`–í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${actualTotalPages}`);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        for (let page = 1; page <= actualTotalPages; page++) {
            // –î–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (page === 1) {
                if (firstPageData.places) {
                    console.log(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${firstPageData.places.length} –∑–∞–≤–µ–¥–µ–Ω–∏–π`);
                    firstPageData.places.forEach(place => {
                        console.log(`üìç ${place.title}: —Ä–µ–π—Ç–∏–Ω–≥=${place.avg_rating}, –æ—Ç–∑—ã–≤–æ–≤=${place.review_count}`);
                        allPlacesData.push({
                            id: place.id,
                            title: place.title,
                            description: place.description,
                            telephone: place.telephone,
                            address: place.address,
                            image_path: place.image_path,
                            slug: place.slug,
                            avg_rating: place.avg_rating || 0,  // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∏–∑ API
                            review_count: place.review_count || 0,  // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ –∏–∑ API
                            name: (place.title || '').toLowerCase(),
                            latitude: place.latitude,
                            longitude: place.longitude
                        });
                    });
                }
            } else {
                // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
                const response = await fetch(`/api/categories/${currentCategory}?page=${page}`);

                if (!response.ok) {
                    console.warn(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
                    continue;
                }

                const data = await response.json();

                if (data.places && data.places.length > 0) {
                    console.log(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page}: –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${data.places.length} –∑–∞–≤–µ–¥–µ–Ω–∏–π`);
                    data.places.forEach(place => {
                        console.log(`üìç ${place.title}: —Ä–µ–π—Ç–∏–Ω–≥=${place.avg_rating}, –æ—Ç–∑—ã–≤–æ–≤=${place.review_count}`);
                        allPlacesData.push({
                            id: place.id,
                            title: place.title,
                            description: place.description,
                            telephone: place.telephone,
                            address: place.address,
                            image_path: place.image_path,
                            slug: place.slug,
                            avg_rating: place.avg_rating || 0,  // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∏–∑ API
                            review_count: place.review_count || 0,  // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ –∏–∑ API
                            name: (place.title || '').toLowerCase(),
                            latitude: place.latitude,
                            longitude: place.longitude
                        });
                    });
                }
            }
        }

        allPlaces = allPlacesData;
        const perPage = 10;
        totalPages = Math.ceil(allPlaces.length / perPage);
        console.log(`üìÑ –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ: ${totalPages} (${allPlaces.length} –º–µ—Å—Ç / ${perPage} –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É)`);

        console.log(`‚úÖ –í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${allPlaces.length} –∑–∞–≤–µ–¥–µ–Ω–∏–π`);
        console.log('üìä –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:', allPlaces.slice(0, 3));

        renderCurrentPage();
        initPagination(totalPages, currentPage);
        hideLoading();

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        hideLoading();

        // –ï—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–±–ª–æ–Ω–∞ –∫–∞–∫ fallback
        console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–±–ª–æ–Ω–∞ –∫–∞–∫ fallback');
        useTemplateDataAsFallback();
    }
}

// Fallback —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —à–∞–±–ª–æ–Ω–∞
function useTemplateDataAsFallback() {
    const container = document.getElementById('restaurantsContainer');
    if (!container) return;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π HTML –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    const originalHTML = container.innerHTML;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º allPlaces –∏–∑ –¥–∞–Ω–Ω—ã—Ö –≤ DOM
    allPlaces = [];
    const cards = container.querySelectorAll('.restaurant-card');

    cards.forEach(card => {
        const place = {
            id: card.getAttribute('data-id'),
            title: card.querySelector('.restaurant-name').textContent,
            description: card.querySelector('.restaurant-description').textContent,
            avg_rating: parseFloat(card.getAttribute('data-rating')) || 0,
            // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
        };
        allPlaces.push(place);
    });

    totalPages = 1;
    currentPage = 1;
    initPagination(totalPages, currentPage);
}

// ==================== –ü–ê–ì–ò–ù–ê–¶–ò–Ø ====================
function initPagination(totalPages, currentPage) {
    const pagination = document.getElementById('pagination');
    const smartPagination = document.getElementById('smartPagination');

    if (!pagination) {
        console.error('–≠–ª–µ–º–µ–Ω—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    pagination.innerHTML = '';

    // –ï—Å–ª–∏ –≤—Å–µ–≥–æ 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
    if (totalPages <= 1 || allPlaces.length === 0) {
        pagination.style.display = 'none';
        pagination.classList.add('hidden');
        smartPagination.classList.add('no-pagination');
        return;
    } else {
        pagination.style.display = 'flex';
        pagination.classList.remove('hidden');
        smartPagination.classList.remove('no-pagination');
    }

    // –ö–Ω–æ–ø–∫–∞ "–í –Ω–∞—á–∞–ª–æ"
    addPageItem(pagination, '¬´', 1);

    // –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    if (currentPage > 1) {
        addPageItem(pagination, '<', currentPage - 1, 'arrow');
    }

    // –°—Ç—Ä–∞–Ω–∏—Ü—ã
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
            addPageItem(pagination, i, i, i === currentPage ? 'active' : '');
        } else if (i === currentPage - 2 || i === currentPage + 2) {
            addEllipsis(pagination);
        }
    }

    // –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    if (currentPage < totalPages) {
        addPageItem(pagination, '>', currentPage + 1, 'arrow');
    }

    // –ö–Ω–æ–ø–∫–∞ "–í –∫–æ–Ω–µ—Ü"
    addPageItem(pagination, '¬ª', totalPages);
}

function addPageItem(container, text, pageNumber, className = '') {
    const li = document.createElement('li');
    li.className = 'page-item';

    const a = document.createElement('a');
    a.className = `page-link ${className}`;
    a.href = '#';
    a.textContent = text;
    a.onclick = (e) => {
        e.preventDefault();
        goToPage(pageNumber);
    };

    li.appendChild(a);
    container.appendChild(li);
}

function addEllipsis(container) {
    const li = document.createElement('li');
    li.className = 'page-item';
    li.innerHTML = '<span class="ellipsis">...</span>';
    container.appendChild(li);
}

function goToPage(pageNumber) {
    if (pageNumber < 1 || pageNumber > totalPages || isLoading) {
        console.log('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ');
        return;
    }

    if (pageNumber === currentPage) {
        console.log(`–£–∂–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ${pageNumber}`);
        return;
    }

    console.log(`–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É ${pageNumber}`);
    currentPage = pageNumber;
    isLoading = true;

    showLoading();

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
    requestAnimationFrame(() => {
        const url = new URL(window.location);
        url.searchParams.set('page', pageNumber);
        window.history.pushState({ page: pageNumber }, '', url.toString());

        renderCurrentPage();
        initPagination(totalPages, currentPage);

        setTimeout(() => {
            hideLoading();
            isLoading = false;
            console.log(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageNumber} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞`);
        }, 300);
    });
}

// ==================== –ì–ï–û–õ–û–ö–ê–¶–ò–Ø –ü–û IP ====================
function getLocationByIP() {
    console.log('–ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ IP...');

    return fetch('https://ipapi.co/json/')
        .then(response => response.json())
        .then(data => {
            if (data.latitude && data.longitude) {
                userLocation = {
                    latitude: data.latitude,
                    longitude: data.longitude
                };
                console.log('‚úÖ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ IP:', userLocation);

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ–ø—Ü–∏—é –≤ —Ñ–∏–ª—å—Ç—Ä–µ
                const distanceOption = document.getElementById('distanceOption');
                if (distanceOption) {
                    distanceOption.textContent = '–ë–ª–∏–∂–∞–π—à–∏–π –∫–æ –º–Ω–µ';
                    distanceOption.disabled = false;
                }

                return userLocation;
            } else {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ IP');
            }
        })
        .catch(error => {
            console.log('–û—à–∏–±–∫–∞ IP-–≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –í–µ–ª–∏–∫–æ–≥–æ –ù–æ–≤–≥–æ—Ä–æ–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            userLocation = {
                latitude: 58.521,
                longitude: 31.275
            };
            console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–í–µ–ª–∏–∫–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥):', userLocation);
            return userLocation;
        });
}

// ==================== –†–ï–ù–î–ï–†–ò–ù–ì ====================
function renderCurrentPage() {
    console.log(`=== –†–ï–ù–î–ï–†–ò–ù–ì –°–¢–†–ê–ù–ò–¶–´ ${currentPage} ===`);

    const container = document.getElementById('restaurantsContainer');
    if (!container) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    container.innerHTML = '';

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
    if (allPlaces.length === 0) {
        container.innerHTML = `
            <div class="no-results">
                <h3>–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ–¥–µ–Ω–∏–π</h3>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</p>
            </div>
        `;
        return;
    }

    const perPage = 10;
    const startIndex = (currentPage - 1) * perPage;
    const endIndex = startIndex + perPage;
    const pagePlaces = allPlaces.slice(startIndex, endIndex);

    console.log(`–†–µ–Ω–¥–µ—Ä–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É ${currentPage}: ${pagePlaces.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);

    pagePlaces.forEach((place, index) => {
        const card = createRestaurantCard(place, index);
        container.appendChild(card);
    });

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –≤–µ—Ä—Ö—É –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (!isInitialLoad) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    isInitialLoad = false;
}

function createRestaurantCard(place, index) {
    console.log(`üéØ –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è: ${place.title}`, {
        id: place.id,
        avg_rating: place.avg_rating,
        review_count: place.review_count,
        has_rating: !!place.avg_rating
    });

    const card = document.createElement('div');
    card.className = 'restaurant-card';
    card.style.animationDelay = (index * 0.1) + 's';

    card.setAttribute('data-id', place.id);
    card.setAttribute('data-rating', place.avg_rating);
    card.setAttribute('data-name', place.name);

    const url = place.slug ?
        `/${currentCategory}/${place.slug}` :
        `/restaurant/${place.id}`;

    card.onclick = () => window.location.href = url;

    const imagePath = place.image_path ?
        `/static/${place.image_path}` :
        '/static/–§–æ—Ç–∫–∏ –∑–¥–∞–Ω–∏–π/–ò–∫–æ–Ω–∫–∞–ú–µ—Å—Ç–∞.png';

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–π—Ç–∏–Ω–≥
    const ratingDisplay = place.avg_rating ? place.avg_rating.toFixed(1) : '0.0';
    console.log(`‚≠ê –†–µ–π—Ç–∏–Ω–≥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${ratingDisplay}`);

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ –µ—Å–ª–∏ –µ—Å—Ç—å
    const reviewInfo = place.review_count > 0 ?
        `<br><small>–û—Ç–∑—ã–≤–æ–≤: ${place.review_count}</small>` : '';

    const hasDistance = currentSort === 'distance' && place.distance !== undefined && place.distance < 9999;
    const distanceInfo = hasDistance ?
        `<div class="distance-info">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2s4 4.5 4 10-4 10-4 10-4-4.5-4-10 4-10 4-10z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
            <span>${place.distance.toFixed(1)} –∫–º</span>
        </div>` : '';

    card.innerHTML = `
        <div class="image-wrapper">
            <img class="restaurant-image" src="${imagePath}" alt="${place.title || '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}">
            <div class="rating-overlay">
                <span class="rating-badge">${ratingDisplay}</span>
            </div>
        </div>
        <div class="restaurant-info">
            <h3 class="restaurant-name">${place.title || '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</h3>
            <p class="restaurant-description">
                ${place.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
                ${reviewInfo}
            </p>
            ${distanceInfo}
            <div class="restaurant-contacts">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                    <span>${place.telephone || '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
                </div>
                <div class="metka">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <span>${place.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
                </div>
            </div>
        </div>
    `;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ä–µ–π—Ç–∏–Ω–≥ –¥–æ–±–∞–≤–∏–ª—Å—è –≤ DOM
    setTimeout(() => {
        const badge = card.querySelector('.rating-badge');
        console.log(`‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ DOM: ${place.title} - badge:`, badge?.textContent);
    }, 100);

    return card;
}

// ==================== –§–ò–õ–¨–¢–†–´ ====================
function initFilters() {
    const sortFilter = document.getElementById('sortFilter');
    if (sortFilter) {
        const lastFilter = localStorage.getItem('lastSortFilter');
        if (lastFilter) {
            sortFilter.value = lastFilter;
            currentSort = lastFilter;
        }

        sortFilter.addEventListener('change', function() {
            applyFilters();
        });
    }

    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
    getUserLocation().catch(error => {
        console.log('–ë—Ä–∞—É–∑–µ—Ä–Ω–∞—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ–±—É–µ–º IP...');
        return getLocationByIP();
    }).then(location => {
        console.log('‚úÖ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:', location);

        // –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è - –ø—Ä–∏–º–µ–Ω—è–µ–º –µ–≥–æ!
        if (currentSort === 'distance') {
            console.log('üîÑ –§–∏–ª—å—Ç—Ä —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è —É–∂–µ –≤—ã–±—Ä–∞–Ω, –ø—Ä–∏–º–µ–Ω—è–µ–º...');
            applySortingToAll();
        }
    }).catch(error => {
        console.log('–í—Å–µ –º–µ—Ç–æ–¥—ã –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
    });
}

// ==================== –ì–ï–û–õ–û–ö–ê–¶–ò–Ø –° –£–°–¢–†–û–ô–°–¢–í–ê ====================
function getUserLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            console.error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é');
            reject(new Error('Geolocation not supported'));
            return;
        }

        console.log('üîÑ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...');

        // –û–ü–¢–ò–ú–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        const options = {
            enableHighAccuracy: true,    // –ò—Å–ø–æ–ª—å–∑—É–µ–º GPS –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
            timeout: 15000,              // –ñ–¥–µ–º –¥–æ 15 —Å–µ–∫—É–Ω–¥
            maximumAge: 60000            // –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ 1 –º–∏–Ω—É—Ç—É
        };

        navigator.geolocation.getCurrentPosition(
            // –£–°–ü–ï–•
            (position) => {
                userLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };

                console.log('‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –£–°–ü–ï–®–ù–ê!');
                console.log('üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', userLocation);
                console.log('üìè –¢–æ—á–Ω–æ—Å—Ç—å:', position.coords.accuracy + ' –º–µ—Ç—Ä–æ–≤');

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä
                const distanceOption = document.getElementById('distanceOption');
                if (distanceOption) {
                    distanceOption.textContent = '–ë–ª–∏–∂–∞–π—à–∏–π –∫–æ –º–Ω–µ';
                    distanceOption.disabled = false;
                }

                resolve(userLocation);
            },

            // –û–®–ò–ë–ö–ê
            (error) => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);

                let errorMessage = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = '–í—ã –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏. –†–∞–∑—Ä–µ—à–∏—Ç–µ –µ–≥–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GPS/–∏–Ω—Ç–µ—Ä–Ω–µ—Ç.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = '–í—Ä–µ–º—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ.';
                        break;
                    default:
                        errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.';
                        break;
                }

                console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', errorMessage);
                reject(new Error(errorMessage));
            },

            options // –ø–µ—Ä–µ–¥–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        );
    });
}

// –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (—Ñ–æ—Ä–º—É–ª–∞ –ì–∞–≤–µ—Ä—Å–∏–Ω—É—Å–∞)
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// ==================== –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –§–ò–õ–¨–¢–†–´ ====================
function applyFilters() {
    console.log('=== APPLY FILTERS CALLED ===');

    const sortFilter = document.getElementById('sortFilter');
    if (!sortFilter) {
        console.error('sortFilter —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    currentSort = sortFilter.value;
    console.log('–í—ã–±—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä:', currentSort);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
    localStorage.setItem('lastSortFilter', currentSort);

    if (currentSort === 'distance') {
        console.log('üéØ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é');

        if (!userLocation) {
            console.log('üìç –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é...');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            showNotification('–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...');

            getUserLocation()
                .then(location => {
                    console.log('‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞, –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä');
                    hideNotification();
                    applySortingToAll();
                })
                .catch(error => {
                    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é:', error);
                    hideNotification();

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    showLocationError(error.message);

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
                    sortFilter.value = 'default';
                    currentSort = 'default';
                    localStorage.setItem('lastSortFilter', 'default');
                });
        } else {
            console.log('üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é:', userLocation);
            applySortingToAll();
        }
    } else {
        console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞:', currentSort);
        applySortingToAll();
    }
}

function showLoading() {
    const loading = document.getElementById('loading');
    if (loading) {
        loading.style.display = 'block';
    }
}

function hideLoading() {
    const loading = document.getElementById('loading');
    if (loading) {
        loading.style.display = 'none';
    }
}

function applySortingToAll() {
    if (allPlaces.length === 0) {
        console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏');
        return;
    }

    showLoading();

    setTimeout(() => {
        const sortedPlaces = [...allPlaces];

        switch(currentSort) {
            case 'rating_high':
                sortedPlaces.sort((a, b) => b.avg_rating - a.avg_rating || a.name.localeCompare(b.name));
                // –£–±–∏—Ä–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∫—Ä–æ–º–µ distance
                sortedPlaces.forEach(place => delete place.distance);
                break;
            case 'rating_low':
                sortedPlaces.sort((a, b) => a.avg_rating - b.avg_rating || a.name.localeCompare(b.name));
                sortedPlaces.forEach(place => delete place.distance);
                break;
            case 'name_asc':
                sortedPlaces.sort((a, b) => a.name.localeCompare(b.name));
                sortedPlaces.forEach(place => delete place.distance);
                break;
            case 'name_desc':
                sortedPlaces.sort((a, b) => b.name.localeCompare(a.name));
                sortedPlaces.forEach(place => delete place.distance);
                break;
            case 'distance':
                console.log('üîç –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è...');
                console.log('üìç userLocation:', userLocation);

                if (!userLocation) {
                    console.error('‚ùå userLocation –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                    return;
                }

                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –∑–∞–≤–µ–¥–µ–Ω–∏–π —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                let placesWithDistance = 0;
                sortedPlaces.forEach(place => {
                    if (place.latitude && place.longitude) {
                        place.distance = calculateDistance(
                            userLocation.latitude,
                            userLocation.longitude,
                            place.latitude,
                            place.longitude
                        );
                        placesWithDistance++;
                        console.log(`üìè ${place.title}: ${place.distance.toFixed(2)} –∫–º`);
                    } else {
                        place.distance = 9999; // –ë–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ –¥–ª—è –∑–∞–≤–µ–¥–µ–Ω–∏–π –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                        console.log(`‚ùå ${place.title}: –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç`);
                    }
                });

                console.log(`‚úÖ –†–∞—Å—Å—á–∏—Ç–∞–Ω–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π: ${placesWithDistance} –∏–∑ ${sortedPlaces.length}`);

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é
                sortedPlaces.sort((a, b) => a.distance - b.distance);
                break;
            case 'default':
            default:
                sortedPlaces.sort((a, b) => parseInt(a.id) - parseInt(b.id));
                // –£–±–∏—Ä–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                sortedPlaces.forEach(place => delete place.distance);
                break;
        }

        allPlaces = sortedPlaces;
        currentPage = 1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        renderCurrentPage();
        initPagination(totalPages, currentPage);
        hideLoading();

        console.log(`‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: ${currentSort}`);
        console.log(`üìç –ü–æ–∫–∞–∑–∞–Ω—ã —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è: ${currentSort === 'distance'}`);
    }, 300);
}

// ==================== –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å ====================

function onExistingCategoryChange() {
    const selectedCategory = document.getElementById('existingCategory').value;
    const backgroundSection = document.getElementById('categoryBackgroundSection');
    const backgroundInput = document.getElementById('categoryBackgroundInput');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Ñ–æ–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–§–æ–Ω"
    if (selectedCategory === '–§–æ–Ω') {
        backgroundSection.style.display = 'block';
        if (backgroundInput) backgroundInput.required = true;
    } else {
        backgroundSection.style.display = 'none';
        if (backgroundInput) backgroundInput.required = false;
    }

    // –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞...
    if (selectedCategory) {
        const newCategoryInput = document.getElementById('newCategory');
        if (newCategoryInput) {
            newCategoryInput.value = '';
        }
    }
    updateFinalCategoryPreview();
}
    </script>
</body>
</html>