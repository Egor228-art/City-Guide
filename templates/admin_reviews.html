{% extends "base_admin.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏</h1>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
<div class="alert alert-info d-flex justify-content-between align-items-center">
    <span>
        –ü–æ–∫–∞–∑–∞–Ω–æ <strong>{{ reviews_data|length }}</strong> –∏–∑ <strong>{{ pagination.total }}</strong> –æ—Ç–∑—ã–≤–æ–≤
    </span>
    <span>
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ <strong>{{ pagination.page }}</strong> –∏–∑ <strong>{{ pagination.pages }}</strong>
    </span>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th>–†–µ–π—Ç–∏–Ω–≥</th>
                        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–õ–∞–π–∫–∏</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in reviews_data %}
                    {% set review = item.review %}
                    <tr>
                        <td>{{ review.id }}</td>
                        <td>{{ review.username }}</td>
                        <td>
                            <a href="{{ item.place_url }}" target="_blank" class="text-decoration-none">
                                {{ item.place_title }}
                            </a>
                        </td>
                        <td>
                            <span class="badge bg-{{ 'success' if review.rating >= 4 else 'warning' }} if review.rating == 3 else 'danger' }}">
                                {{ review.rating }}/5
                            </span>
                        </td>
                        <td>
                            {% if review.comment %}
                                {{ review.comment[:100] }}{% if review.comment|length > 100 %}...{% endif %}
                            {% else %}
                                <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td>{{ review.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                        <td>
                            <small class="text-success">üëç {{ review.likes or 0 }}</small>
                            <small class="text-danger">üëé {{ review.dislikes or 0 }}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å" -->
                                <a href="{{ item.place_url }}#review-{{ review.id }}"
                                   class="btn btn-outline-primary"
                                   target="_blank"
                                   title="–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ç–∑—ã–≤—É">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>

                                <!-- –ö–Ω–æ–ø–∫–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" -->
                                <button class="btn btn-outline-warning edit-review"
                                        data-review-id="{{ review.id }}"
                                        data-username="{{ review.username }}"
                                        data-rating="{{ review.rating }}"
                                        data-comment="{{ review.comment }}"
                                        title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤">
                                    <i class="fas fa-edit"></i>
                                </button>

                                <!-- –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å" -->
                                <button class="btn btn-outline-danger delete-review"
                                        data-review-id="{{ review.id }}"
                                        data-username="{{ review.username }}"
                                        title="–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if pagination.pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link"
                       href="{{ url_for('admin_reviews_page', page=pagination.prev_num) if pagination.has_prev else '#' }}">
                        &laquo; –ù–∞–∑–∞–¥
                    </a>
                </li>

                <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
                {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('admin_reviews_page', page=page_num) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}

                <!-- –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥" -->
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link"
                       href="{{ url_for('admin_reviews_page', page=pagination.next_num) if pagination.has_next else '#' }}">
                        –í–ø–µ—Ä–µ–¥ &raquo;
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
<div class="modal fade" id="editReviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editReviewForm">
                    <input type="hidden" id="editReviewId" name="review_id">
                    <div class="mb-3">
                        <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                        <input type="text" class="form-control" id="editReviewUsername" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–†–µ–π—Ç–∏–Ω–≥</label>
                        <select class="form-select" id="editReviewRating" name="rating" required>
                            <option value="1">‚òÖ (1)</option>
                            <option value="2">‚òÖ‚òÖ (2)</option>
                            <option value="3">‚òÖ‚òÖ‚òÖ (3)</option>
                            <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ (4)</option>
                            <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (5)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea class="form-control" id="editReviewComment" name="comment" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveReviewChanges">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
document.querySelectorAll('.edit-review').forEach(btn => {
    btn.addEventListener('click', function() {
        const reviewId = this.dataset.reviewId;
        const username = this.dataset.username;
        const rating = this.dataset.rating;
        const comment = this.dataset.comment;

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.getElementById('editReviewId').value = reviewId;
        document.getElementById('editReviewUsername').value = username;
        document.getElementById('editReviewRating').value = rating;
        document.getElementById('editReviewComment').value = comment || '';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = new bootstrap.Modal(document.getElementById('editReviewModal'));
        modal.show();
    });
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç–∑—ã–≤–∞
document.getElementById('saveReviewChanges').addEventListener('click', function() {
    const reviewId = document.getElementById('editReviewId').value;
    const rating = document.getElementById('editReviewRating').value;
    const comment = document.getElementById('editReviewComment').value;

    fetch(`/admin/api/reviews/${reviewId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            rating: parseInt(rating),
            comment: comment
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
            bootstrap.Modal.getInstance(document.getElementById('editReviewModal')).hide();
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    });
});

// –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
document.querySelectorAll('.delete-review').forEach(btn => {
    btn.addEventListener('click', function() {
        const reviewId = this.dataset.reviewId;
        const username = this.dataset.username;

        if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) {
            fetch(`/admin/api/reviews/${reviewId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–û—Ç–∑—ã–≤ —É–¥–∞–ª–µ–Ω');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            });
        }
    });
});
</script>
{% endblock %}